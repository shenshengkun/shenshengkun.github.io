<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>舒宇的博客</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://shenshengkun.github.io/"/>
  <updated>2019-05-30T02:29:19.208Z</updated>
  <id>https://shenshengkun.github.io/</id>
  
  <author>
    <name>Shu Yu</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>tomcat报SEVERE Error listenerStart</title>
    <link href="https://shenshengkun.github.io/posts/1b8b1cc1.html"/>
    <id>https://shenshengkun.github.io/posts/1b8b1cc1.html</id>
    <published>2019-05-28T09:49:10.000Z</published>
    <updated>2019-05-30T02:29:19.208Z</updated>
    
    <content type="html"><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>启动tomcat时报错，错误信息如下： </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">org.apache.catalina.core.StandardContext startInternal</span><br><span class="line">SEVERE: Error listenerStart</span><br><span class="line">org.apache.catalina.core.StandardContext startInternal</span><br><span class="line">SEVERE: Context [/projectname] startup failed due to previous errors</span><br></pre></td></tr></table></figure><h1 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h1><p>在<code>WEB-INF/classes</code>目录下新建一个文件叫<code>logging.properties</code>，内容如下 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">handlers = org.apache.juli.FileHandler, java.util.logging.ConsoleHandler  </span><br><span class="line">org.apache.juli.FileHandler.level = FINE  </span><br><span class="line">org.apache.juli.FileHandler.directory = $&#123;catalina.base&#125;/logs  </span><br><span class="line">org.apache.juli.FileHandler.prefix = error-debug.   </span><br><span class="line">java.util.logging.ConsoleHandler.level = FINE  </span><br><span class="line">java.util.logging.ConsoleHandler.formatter=java.util.logging.SimpleFormatter</span><br></pre></td></tr></table></figure><p>之后，重启tomcat查看日志，就可以看到是由于数据库连接或者jdk版本不兼容等原因导致的</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;问题&quot;&gt;&lt;a href=&quot;#问题&quot; class=&quot;headerlink&quot; title=&quot;问题&quot;&gt;&lt;/a&gt;问题&lt;/h1&gt;&lt;p&gt;启动tomcat时报错，错误信息如下： &lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;t
      
    
    </summary>
    
      <category term="中间件" scheme="https://shenshengkun.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
  </entry>
  
  <entry>
    <title>k8s强制删除</title>
    <link href="https://shenshengkun.github.io/posts/267edcc5.html"/>
    <id>https://shenshengkun.github.io/posts/267edcc5.html</id>
    <published>2019-05-27T09:43:01.000Z</published>
    <updated>2019-05-30T02:29:19.201Z</updated>
    
    <content type="html"><![CDATA[<h1 id="可使用kubectl中的强制删除命令"><a href="#可使用kubectl中的强制删除命令" class="headerlink" title="可使用kubectl中的强制删除命令"></a>可使用kubectl中的强制删除命令</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 删除POD</span><br><span class="line">kubectl delete pod PODNAME --force --grace-period=0</span><br><span class="line"></span><br><span class="line"># 删除NAMESPACE</span><br><span class="line">kubectl delete namespace NAMESPACENAME --force --grace-period=0</span><br></pre></td></tr></table></figure><p>有时候这种方法也删除不掉，可能是之前删除顺序有问题，没有删干净pod，就删除命名空间，导致删除不掉</p><h1 id="直接从ETCD中删除源数据"><a href="#直接从ETCD中删除源数据" class="headerlink" title="直接从ETCD中删除源数据"></a>直接从ETCD中删除源数据</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 删除default namespace下的pod名为pod-to-be-deleted-0</span><br><span class="line">ETCDCTL_API=3 etcdctl del /registry/pods/default/pod-to-be-deleted-0</span><br><span class="line"></span><br><span class="line"># 删除需要删除的NAMESPACE</span><br><span class="line">etcdctl del /registry/namespaces/NAMESPACENAME</span><br></pre></td></tr></table></figure><h2 id="添加别名"><a href="#添加别名" class="headerlink" title="添加别名"></a>添加别名</h2><p>上面直接etcd删除，是证书直接能找到时候，如果证书配置方式不一样，就需要手动配一下！</p><p>配置别名etcdctl3，添加证书等参数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">alias etcdctl3=&apos;docker run --rm -it \</span><br><span class="line">--net host -e ETCDCTL_API=3 \</span><br><span class="line">-v /etc/kubernetes:/etc/kubernetes k8s.gcr.io/etcd:3.3.10 etcdctl \</span><br><span class="line">--cert /etc/kubernetes/pki/etcd/peer.crt \</span><br><span class="line">--key /etc/kubernetes/pki/etcd/peer.key \</span><br><span class="line">--cacert /etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">--endpoints https://192.168.3.101:2379,https://192.168.3.102:2379,https://192.168.3.103:2379&apos;</span><br></pre></td></tr></table></figure><p>查询都有哪些daemonsets</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tcdctl3 get /registry/daemonsets/ --prefix --keys-only</span><br><span class="line">/registry/daemonsets/default/testpod</span><br><span class="line">/registry/daemonsets/kube-system/calico-node</span><br><span class="line">/registry/daemonsets/kube-system/kube-proxy</span><br></pre></td></tr></table></figure><p>与kubectl查看的结果一致</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get daemonsets --all-namespaces </span><br><span class="line">NAMESPACE     NAME          DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR                 AGE</span><br><span class="line">default       testpod       3         3         3       3            3           &lt;none&gt;                        91m</span><br><span class="line">kube-system   calico-node   3         3         3       3            3           beta.kubernetes.io/os=linux   116m</span><br><span class="line">kube-system   kube-proxy    3         3         3       3            3           &lt;none&gt;                        122m</span><br></pre></td></tr></table></figure><p>在etcd中查询default namespace中的pod</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">etcdctl3 get /registry/pods/default --prefix --keys-only </span><br><span class="line">/registry/pods/default/testpod-5wtb7</span><br><span class="line">/registry/pods/default/testpod-646d8</span><br><span class="line">/registry/pods/default/testpod-t7ps7</span><br></pre></td></tr></table></figure><p>kubectl命令看到结果与etcd中一致</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -l app=fortest</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE</span><br><span class="line">testpod-5wtb7   1/1     Running   0          93m</span><br><span class="line">testpod-646d8   1/1     Running   0          93m</span><br><span class="line">testpod-t7ps7   1/1     Running   0          93m</span><br></pre></td></tr></table></figure><p>在etcd中删除pod testpod-t7ps7</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">etcdctl3 del /registry/pods/default/testpod-t7ps7    </span><br><span class="line">1</span><br></pre></td></tr></table></figure><p>再次查看pod，发现testpod-t7ps7已经没有了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE</span><br><span class="line">testpod-5wtb7   1/1     Running   0          96m</span><br><span class="line">testpod-646d8   1/1     Running   0          96m</span><br><span class="line">testpod-qczvt   1/1     Running   0          17s</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;可使用kubectl中的强制删除命令&quot;&gt;&lt;a href=&quot;#可使用kubectl中的强制删除命令&quot; class=&quot;headerlink&quot; title=&quot;可使用kubectl中的强制删除命令&quot;&gt;&lt;/a&gt;可使用kubectl中的强制删除命令&lt;/h1&gt;&lt;figure c
      
    
    </summary>
    
      <category term="k8s" scheme="https://shenshengkun.github.io/categories/k8s/"/>
    
    
  </entry>
  
  <entry>
    <title>fabric问题汇总</title>
    <link href="https://shenshengkun.github.io/posts/9c5623c7.html"/>
    <id>https://shenshengkun.github.io/posts/9c5623c7.html</id>
    <published>2019-05-22T05:04:10.000Z</published>
    <updated>2019-05-30T02:29:19.211Z</updated>
    
    <content type="html"><![CDATA[<h1 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h1><h2 id="fabric测试项目安装问题"><a href="#fabric测试项目安装问题" class="headerlink" title="fabric测试项目安装问题"></a>fabric测试项目安装问题</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install probuf的时候报的错</span><br><span class="line">fabric依赖的sdk需要依赖c++的编译库，windows也许windows-tools，linux也需要支持的gc++,gc</span><br></pre></td></tr></table></figure><h2 id="fabric-ca-server-存储私钥么"><a href="#fabric-ca-server-存储私钥么" class="headerlink" title="fabric-ca-server 存储私钥么"></a>fabric-ca-server 存储私钥么</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">从mysql中不存储私钥</span><br></pre></td></tr></table></figure><h2 id="启动order遇到问题"><a href="#启动order遇到问题" class="headerlink" title="启动order遇到问题"></a>启动order遇到问题</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Failed to initialize local MSP: the supplied identity is not valid: x509: certificate signed by unknown authority</span><br><span class="line"></span><br><span class="line">原因：实体的证书不是组织的证书签发的</span><br></pre></td></tr></table></figure><h2 id="docker-compose创建报错"><a href="#docker-compose创建报错" class="headerlink" title="docker-compose创建报错"></a>docker-compose创建报错</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[blocksProvider] DeliverBlocks -&gt; ERRO 039 [vaccinechannel] Got error &amp;&#123;FORBIDDEN&#125;</span><br><span class="line"></span><br><span class="line">解决办法： 需要在组织的msp中增加config.yaml</span><br></pre></td></tr></table></figure><h1 id="应用过程中问题"><a href="#应用过程中问题" class="headerlink" title="应用过程中问题"></a>应用过程中问题</h1><h2 id="Peer或者Orderer不通"><a href="#Peer或者Orderer不通" class="headerlink" title="Peer或者Orderer不通"></a>Peer或者Orderer不通</h2><p>当不通的时候，先确认域名对应的IP是否正确，然后用telnet检查服务端口：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ping peer0.org1.example.com</span><br><span class="line">telnet peer0.org1.example.com 7051</span><br></pre></td></tr></table></figure><p>如果不通，检查一下/etc/hosts中是否设置了域名和IP的对应关系是否正确。</p><p>如果还是不通，看一下系统有没有防火墙，7051端口有没有被防火墙禁止。</p><h2 id="目标Peer上的Docker没有启动，导致合约实例化失败"><a href="#目标Peer上的Docker没有启动，导致合约实例化失败" class="headerlink" title="目标Peer上的Docker没有启动，导致合约实例化失败"></a>目标Peer上的Docker没有启动，导致合约实例化失败</h2><p>实例化合约时出错：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./peer.sh chaincode instantiate -o orderer.example.com:7050 --tls true --cafile ./tlsca.example.com-cert.pem -C mychannel -n demo -v 0.0.1 -c &apos;&#123;&quot;Args&quot;:[&quot;init&quot;]&#125;&apos; -P &quot;OR(&apos;Org1MSP.member&apos;,&apos;Org2MSP.member&apos;)&quot;</span><br></pre></td></tr></table></figure><p>错误如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: Error endorsing chaincode: rpc error: code = Unknown desc = error starting container: Post http://unix.sock/containers/create?name=dev-peer1.org1.example.com-demo-0.0.1: dial unix /var/run/docker.sock: connect: no such file or directory</span><br></pre></td></tr></table></figure><p>这是目标peer上的docker没有启动造成的。</p><h2 id="genesisblock中admin证书错误导致orderer-panic-x509-ECDSA-verification-failure"><a href="#genesisblock中admin证书错误导致orderer-panic-x509-ECDSA-verification-failure" class="headerlink" title="genesisblock中admin证书错误导致orderer panic: x509: ECDSA verification failure"></a>genesisblock中admin证书错误导致orderer panic: x509: ECDSA verification failure</h2><p>orderer在启动的时候报错，直接panic：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-----END CERTIFICATE-----</span><br><span class="line">2018-06-22 14:27:30.462 UTC [orderer/commmon/multichannel] newLedgerResources -&gt; CRIT 04d Error creating channelconfig bundle: initializing channelconfig failed: could not create channel Consortiums sub-group config: setting up the MSP manager failed: the supplied identity is not valid: x509: certificate signed by unknown authority (possibly because of &quot;x509: ECDSA verification failure&quot; while trying to verify candidate authority certificate &quot;ca.org1.example.com&quot;)</span><br><span class="line">panic: Error creating channelconfig bundle: initializing channelconfig failed: could not create channel Consortiums sub-group config: setting up the MSP manager failed: the supplied identity is not valid: x509: certificate signed by unknown authority (possibly because of &quot;x509: ECDSA verification failure&quot; while trying to verify candidate authority certificate &quot;ca.org1.example.com&quot;)</span><br><span class="line"></span><br><span class="line">goroutine 1 [running]:</span><br><span class="line">github.com/hyperledger/fabric/vendor/github.com/op/go-logging.(*Logger).Panicf(0xc4201ee120, 0x108668e, 0x27, 0xc42026af50, 0x1, 0x1)</span><br><span class="line">/w/workspace/fabric-binaries-x86_64/gopath/src/github.com/hyperledger/fabric/vendor/github.com/op/go-logging/logger.go:194 +0x134</span><br><span class="line">github.com/hyperledger/fabric/orderer/common/multichannel.(*Registrar).newLedgerResources(0xc42010a380, 0xc420138840, 0xc420138840)</span><br><span class="line">/w/workspace/fabric-binaries-x86_64/gopath/src/github.com/hyperledger/fabric/orderer/common/multichannel/registrar.go:253 +0x391</span><br></pre></td></tr></table></figure><p>怀疑是创世块的原因，用下面的命令将创始块解开：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/configtxgen -profile TwoOrgsOrdererGenesis -outputBlock ./genesisblock</span><br></pre></td></tr></table></figure><p>发现比较奇怪的地方，Org1的Admin证书有两个：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&quot;groups&quot;: &#123;</span><br><span class="line">  &quot;Org1MSP&quot;: &#123;</span><br><span class="line">  &quot;mod_policy&quot;: &quot;Admins&quot;,</span><br><span class="line">  ...</span><br><span class="line">  &quot;mod_policy&quot;: &quot;Admins&quot;,</span><br><span class="line">  &quot;value&quot;: &#123;</span><br><span class="line">  &quot;config&quot;: &#123;</span><br><span class="line">  &quot;admins&quot;: [</span><br><span class="line">  &quot;LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNHVENDQWIrZ0F3SUJBZ0lRVXRxQWxlZENzWkErWStWdlZMUTZQakFLQmdncWhrak9QUVFEQWpCek1Rc3cKQ1FZRFZRUUdFd0pWVXpFVE1CRUdBMVVFQ0JNS1EyRnNhV1p2Y201cFlURVdNQlFHQTFVRUJ4TU5VMkZ1SUVaeQpZVzVqYVhOamJ6RVpNQmNHQTFVRUNoTVFiM0puTVM1bGVHRnRjR3hsTG1OdmJURWNNQm9HQTFVRUF4TVRZMkV1CmIzSm5NUzVsZUdGdGNHeGxMbU52YlRBZUZ3MHhPREEyTWpFd05qVTNNekJhRncweU9EQTJNVGd3TmpVM016QmEKTUZzeEN6QUpCZ05WQkFZVEFsVlRNUk13RVFZRFZRUUlFd3BEWVd4cFptOXlibWxoTVJZd0ZBWURWUVFIRXcxVApZVzRnUm5KaGJtTnBjMk52TVI4d0hRWURWUVFEREJaQlpHMXBia0J2Y21jeExtVjRZVzF3YkdVdVkyOXRNRmt3CkV3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFRVp3cUhTVmxxRGNKNC9aVSt0YnB5RVBSTkl5ellMdTMKRGlRVUZOMklBZm5vVGhjTjRmY3Y4c2dsdXUxcnpJYUVHSFRFLzd0TC9EdEg2U3Fjd2tOQkthTk5NRXN3RGdZRApWUjBQQVFIL0JBUURBZ2VBTUF3R0ExVWRFd0VCL3dRQ01BQXdLd1lEVlIwakJDUXdJb0FnbkpjYVVLVFlseVJxCjcyckk4QXNINHNVZHB0ZytWY3IvbHkxZlp3QndrOEF3Q2dZSUtvWkl6ajBFQXdJRFNBQXdSUUloQUsvRXh6NlYKRVYwUFl4M1BQbitPMysvODQrdXFEVkZ2Q1ZRUEVNcU1yV3dkQWlBNVVqTDcyb2drTHB3UUtGZ1ptdTJqRmtPWApSVnhpY0htLzZCR3htelFRc1E9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==&quot;,</span><br><span class="line">  &quot;LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNGVENDQWJ5Z0F3SUJBZ0lRU3E0VzJ1SEVqbHdXZHdGY21WNUlpekFLQmdncWhrak9QUVFEQWpCek1Rc3cKQ1FZRFZRUUdFd0pWVXpFVE1CRUdBMVVFQ0JNS1EyRnNhV1p2Y201cFlURVdNQlFHQTFVRUJ4TU5VMkZ1SUVaeQpZVzVqYVhOamJ6RVpNQmNHQTFVRUNoTVFiM0puTVM1bGVHRnRjR3hsTG1OdmJURWNNQm9HQTFVRUF4TVRZMkV1CmIzSm5NUzVsZUdGdGNHeGxMbU52YlRBZUZ3MHhPREEyTWpFd056VXdNVEZhRncweU9EQTJNVGd3TnpVd01URmEKTUZneEN6QUpCZ05WQkFZVEFsVlRNUk13RVFZRFZRUUlFd3BEWVd4cFptOXlibWxoTVJZd0ZBWURWUVFIRXcxVApZVzRnUm5KaGJtTnBjMk52TVJ3d0dnWURWUVFERXhOallTNXZjbWN4TG1WNFlXMXdiR1V1WTI5dE1Ga3dFd1lICktvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUVxNHl6K0tqSTR2ZmtObzQ0bWp0Q25HQ2cwLzA3L2Y5VW1sZlEKMlpSZWtHN2lyVm1QY0N6YnRVVEcvTFJjbndVemgyaFMvZkg5cGxvZEM4a1pwSlpXQzZOTk1Fc3dEZ1lEVlIwUApBUUgvQkFRREFnZUFNQXdHQTFVZEV3RUIvd1FDTUFBd0t3WURWUjBqQkNRd0lvQWdPc1NNQ2VqcnBOMnBhNEZSCnBOMVE2eXJkVHJleXNGY0Q1Ym9TcVNzSnFLNHdDZ1lJS29aSXpqMEVBd0lEUndBd1JBSWdCQWo1Q3l2cEFhU0kKaTh4anpVVHZxbUt5dmxSOFFPeExBUTAvVi9jRGpTNENJRVg3V1lnZzYwTFUwTy9LNEpmVVpiQmoyNHRBbTkxcgpkQmczN21IZHZVcSsKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=&quot;</span><br><span class="line">  ],</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><p>将上面的两大行字符串分别用base64解码得到证书，然后用openssl命令查看：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;LS0tLS1CRUdJTiBDRVJUSU....tLS0tCg==&quot; |base64 -D &gt;a.cert</span><br><span class="line">openssl x509 -in a.cert -text</span><br></pre></td></tr></table></figure><p>第一个证书正确：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"> Subject: C=US, ST=California, L=San Francisco, CN=Admin@org1.example.com</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>查看第二行：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;LS0tLS1CRUdJTi....tLS0tLQo=&quot; |base64 -D &gt;b.cert</span><br><span class="line">openssl x509 -in b.cert -text</span><br></pre></td></tr></table></figure><p>发现第二个证书是CA证书，不是用户证书！</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Subject: C=US, ST=California, L=San Francisco, CN=ca.org1.example.com</span><br></pre></td></tr></table></figure><p>检查生成genesisblock时使用的configtx.yaml文件，发现configtx.yaml中配置的msp目录：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MSPDir: ./certs/peerOrganizations/org1.example.com/msp</span><br></pre></td></tr></table></figure><p>msp的admincerts子目录中，多出了一个ca证书：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ls ./certs/peerOrganizations/org1.example.com/msp/admincerts/</span><br><span class="line">Admin@org1.example.com-cert.pem ca.org1.example.com-cert.pem</span><br></pre></td></tr></table></figure><p>把多出的ca证书删除。</p><h2 id="残留数据导致orderer启动失败"><a href="#残留数据导致orderer启动失败" class="headerlink" title="残留数据导致orderer启动失败"></a>残留数据导致orderer启动失败</h2><p>启动orderer的时候报错，orderer直接panic：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2018-06-21 11:01:47.892 CST [orderer/commmon/multichannel] newLedgerResources -&gt; CRIT 052 Error creating channelconfig bundle: initializing channelconfig failed: could not create channel Orderer sub-group config: setting up the MSP manager failed: the supplied identity is not valid: x509: certificate signed by unknown authority (possibly because of &quot;x509: ECDSA verification failure&quot; while trying to verify candidate authority certificate &quot;ca.example.com&quot;)</span><br><span class="line">panic: Error creating channelconfig bundle: initializing channelconfig failed: could not create channel Orderer sub-group config: setting up the MSP manager failed: the supplied identity is not valid: x509: certificate signed by unknown authority (possibly because of &quot;x509: ECDSA verification failure&quot; while trying to verify candidate authority certificate &quot;ca.example.com&quot;)</span><br></pre></td></tr></table></figure><p>排查发现，部署orderer的机器上以前部署过orderer，并且orderer.yaml中配置的数据路径<code>/opt/app/fabric/orderer/data</code>中残留了以前的数据。</p><p>将/opt/app/fabric/orderer/data中的文件都删除后，问题解决。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;安装部署&quot;&gt;&lt;a href=&quot;#安装部署&quot; class=&quot;headerlink&quot; title=&quot;安装部署&quot;&gt;&lt;/a&gt;安装部署&lt;/h1&gt;&lt;h2 id=&quot;fabric测试项目安装问题&quot;&gt;&lt;a href=&quot;#fabric测试项目安装问题&quot; class=&quot;headerli
      
    
    </summary>
    
      <category term="区块链" scheme="https://shenshengkun.github.io/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/"/>
    
    
  </entry>
  
  <entry>
    <title>Prometheus添加验证登录</title>
    <link href="https://shenshengkun.github.io/posts/239bdf86.html"/>
    <id>https://shenshengkun.github.io/posts/239bdf86.html</id>
    <published>2019-05-22T01:38:01.000Z</published>
    <updated>2019-05-30T02:29:19.206Z</updated>
    
    <content type="html"><![CDATA[<h1 id="prometheus添加nginx验证"><a href="#prometheus添加nginx验证" class="headerlink" title="prometheus添加nginx验证"></a>prometheus添加nginx验证</h1><p>Prometheus默认开箱即食，并没有设置认证方式，如果你使用Grafana那就另当别论。</p><p>如果你想直接访问Prometheus并且需要设置个认证，那么通过Nginx反向代理是一个不错的选择。</p><p>本文通过Nginx反向代理增加401认证方式来实现。</p><h2 id="安装apache-htpasswd工具"><a href="#安装apache-htpasswd工具" class="headerlink" title="安装apache-htpasswd工具"></a>安装apache-htpasswd工具</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install httpd-tools</span><br></pre></td></tr></table></figure><h2 id="加密认证密码"><a href="#加密认证密码" class="headerlink" title="加密认证密码"></a>加密认证密码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">htpasswd -cs /usr/local/nginx/conf/401htpasswd sy</span><br></pre></td></tr></table></figure><h2 id="设置Nginx反向代理及401认证"><a href="#设置Nginx反向代理及401认证" class="headerlink" title="设置Nginx反向代理及401认证"></a>设置Nginx反向代理及401认证</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/nginx/conf/vhost</span><br><span class="line">vi demo.conf</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name 192.168.10.177;</span><br><span class="line"> </span><br><span class="line">    location / &#123;</span><br><span class="line">        auth_basic &quot;Prometheus&quot;;</span><br><span class="line">        auth_basic_user_file /usr/local/nginx/conf/401htpasswd;</span><br><span class="line">        proxy_pass http://localhost:9090/;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动nginx；访问192.168.10.177</p><p>正常输入密码后，会看到Prometheus页面，如果提示403则表示账号密码不正确，或者路径配错。 </p><h1 id="加密node-exporter"><a href="#加密node-exporter" class="headerlink" title="加密node_exporter"></a>加密node_exporter</h1><p>node_exporter是Prometheus的一个扩展程序，也是通过go语言编写，同样是开箱即食，主要用来采集服务器上的数据（CPU、内存等等）。 所以为了安全考虑，也需要加密一下。</p><h2 id="Nginx配置如下"><a href="#Nginx配置如下" class="headerlink" title="Nginx配置如下"></a>Nginx配置如下</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 19100;</span><br><span class="line">    server_name 你的远程主机IP;</span><br><span class="line"> </span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://localhost:9100/;</span><br><span class="line">        auth_basic &quot;Prometheus&quot;;</span><br><span class="line">        auth_basic_user_file /usr/local/nginx/conf/401htpasswd;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="prometheus配置"><a href="#prometheus配置" class="headerlink" title="prometheus配置"></a>prometheus配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">在Prometheus配置文件下面添加以下内容，username是远程服务器认证账号，password为加密密码，此处IP为远程服务器的IP地址，不需要加http。</span><br><span class="line"></span><br><span class="line">- job_name: server</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&apos;IP:19100&apos;]</span><br><span class="line">        labels:</span><br><span class="line">          instance: name</span><br><span class="line">    basic_auth:</span><br><span class="line">      username: sy</span><br><span class="line">      password: 123456</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;prometheus添加nginx验证&quot;&gt;&lt;a href=&quot;#prometheus添加nginx验证&quot; class=&quot;headerlink&quot; title=&quot;prometheus添加nginx验证&quot;&gt;&lt;/a&gt;prometheus添加nginx验证&lt;/h1&gt;&lt;p&gt;Pr
      
    
    </summary>
    
      <category term="k8s" scheme="https://shenshengkun.github.io/categories/k8s/"/>
    
    
  </entry>
  
  <entry>
    <title>nginx基础整理</title>
    <link href="https://shenshengkun.github.io/posts/8d1c645b.html"/>
    <id>https://shenshengkun.github.io/posts/8d1c645b.html</id>
    <published>2019-05-15T07:40:10.000Z</published>
    <updated>2019-05-30T02:29:19.234Z</updated>
    
    <content type="html"><![CDATA[<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><blockquote><p>prce(重定向支持)和openssl(https支持，如果不需要https可以不安装。)</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y pcre-devel </span><br><span class="line">yum -y install gcc make gcc-c++ wget</span><br><span class="line">yum -y install openssl openssl-devel</span><br></pre></td></tr></table></figure><h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p><a href="http://nginx.org/en/download.html" target="_blank" rel="noopener">nginx的所有版本在这里</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#创建存放源码包的目录</span><br><span class="line">[root@nginx ~]# mkdir tools</span><br><span class="line">[root@nginx ~]# cd tools/</span><br><span class="line"> #下载Nginx源码包</span><br><span class="line">[root@nginx tools]# wget http://nginx.org/download/nginx-1.14.2.tar.gz</span><br><span class="line">[root@nginx tools]# ls</span><br><span class="line">nginx-1.14.2.tar.gz</span><br><span class="line"> #解压Nginx源码包</span><br><span class="line">[root@nginx tools]# tar -xf nginx-1.14.2.tar.gz</span><br></pre></td></tr></table></figure><h2 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h2><p>然后进入目录编译安装</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> #创建安装的目录</span><br><span class="line">[root@nginx nginx-1.14.2]# mkdir -p /application/nginx</span><br><span class="line">[root@nginx nginx-1.14.2]# ./configure --prefix=/application/nginx</span><br></pre></td></tr></table></figure><p>如果没有error信息，就可以执行下边的安装了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><h2 id="nginx测试"><a href="#nginx测试" class="headerlink" title="nginx测试"></a>nginx测试</h2><p>运行下面命令会出现两个结果，一般情况nginx会安装在<code>/usr/local/nginx</code>目录中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/nginx/sbin/</span><br><span class="line">./nginx -t</span><br><span class="line"></span><br><span class="line"># nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</span><br><span class="line"># nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful</span><br></pre></td></tr></table></figure><h2 id="设置全局nginx命令"><a href="#设置全局nginx命令" class="headerlink" title="设置全局nginx命令"></a>设置全局nginx命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi ~/.bash_profile</span><br></pre></td></tr></table></figure><p>将下面内容添加到 <code>~/.bash_profile</code> 文件中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PATH=$PATH:$HOME/bin:/usr/local/nginx/sbin/</span><br><span class="line">export PATH</span><br></pre></td></tr></table></figure><p>运行命令 <strong>source ~/.bash_profile</strong> 让配置立即生效。你就可以全局运行 <code>nginx</code> 命令了。</p><h2 id="开机自启动"><a href="#开机自启动" class="headerlink" title="开机自启动"></a>开机自启动</h2><p><strong>开机自启动方法一：</strong></p><p>编辑 <strong>vi /lib/systemd/system/nginx.service</strong> 文件，没有创建一个 <strong>touch nginx.service</strong> 然后将如下内容根据具体情况进行修改后，添加到nginx.service文件中：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=nginx</span><br><span class="line">After=network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"></span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/var/run/nginx.pid</span><br><span class="line">ExecStartPre=/usr/local/nginx/sbin/nginx -t -c /usr/local/nginx/conf/nginx.conf</span><br><span class="line">ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">ExecStop=/bin/kill -s QUIT $MAINPID</span><br><span class="line">PrivateTmp=true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><ul><li><code>[Unit]</code>:服务的说明</li><li><code>Description</code>:描述服务</li><li><code>After</code>:描述服务类别</li><li><code>[Service]</code>服务运行参数的设置</li><li><code>Type=forking</code>是后台运行的形式</li><li><code>ExecStart</code>为服务的具体运行命令</li><li><code>ExecReload</code>为重启命令</li><li><code>ExecStop</code>为停止命令</li><li><code>PrivateTmp=True</code>表示给服务分配独立的临时空间</li></ul><p>注意：<code>[Service]</code>的启动、重启、停止命令全部要求使用绝对路径。</p><p><code>[Install]</code>运行级别下服务安装的相关设置，可设置为多用户，即系统运行级别为<code>3</code>。</p><p>保存退出。</p><p>设置开机启动，使配置生效：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 启动nginx服务</span><br><span class="line">systemctl start nginx.service</span><br><span class="line"># 停止开机自启动</span><br><span class="line">systemctl disable nginx.service</span><br><span class="line"># 查看服务当前状态</span><br><span class="line">systemctl status nginx.service</span><br><span class="line"># 查看所有已启动的服务</span><br><span class="line">systemctl list-units --type=service</span><br><span class="line"># 重新启动服务</span><br><span class="line">systemctl restart nginx.service</span><br><span class="line"># 设置开机自启动</span><br><span class="line">systemctl enable nginx.service</span><br><span class="line"># 输出下面内容表示成功了</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/nginx.service to /usr/lib/systemd/system/nginx.service.</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">systemctl is-enabled servicename.service # 查询服务是否开机启动</span><br><span class="line">systemctl enable *.service # 开机运行服务</span><br><span class="line">systemctl disable *.service # 取消开机运行</span><br><span class="line">systemctl start *.service # 启动服务</span><br><span class="line">systemctl stop *.service # 停止服务</span><br><span class="line">systemctl restart *.service # 重启服务</span><br><span class="line">systemctl reload *.service # 重新加载服务配置文件</span><br><span class="line">systemctl status *.service # 查询服务运行状态</span><br><span class="line">systemctl --failed # 显示启动失败的服务</span><br></pre></td></tr></table></figure><p>注：*代表某个服务的名字，如http的服务名为httpd</p><p><strong>开机自启动方法二：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/rc.local</span><br><span class="line"></span><br><span class="line"># 在 rc.local 文件中，添加下面这条命令</span><br><span class="line">/usr/local/nginx/sbin/nginx start</span><br></pre></td></tr></table></figure><p>如果开机后发现自启动脚本没有执行，你要去确认一下rc.local这个文件的访问权限是否是可执行的，因为rc.local默认是不可执行的。修改rc.local访问权限，增加可执行权限：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># /etc/rc.local是/etc/rc.d/rc.local的软连接，</span><br><span class="line">chmod +x /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure><h1 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h1><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>–prefix=<code>&lt;path&gt;</code></td><td>Nginx安装路径。如果没有指定，默认为 /usr/local/nginx。</td></tr><tr><td>–sbin-path=<code>&lt;path&gt;</code></td><td>Nginx可执行文件安装路径。只能安装时指定，如果没有指定，默认为<code>&lt;prefix&gt;</code>/sbin/nginx。</td></tr><tr><td>–conf-path=<code>&lt;path&gt;</code></td><td>在没有给定-c选项下默认的nginx.conf的路径。如果没有指定，默认为<code>&lt;prefix&gt;</code>/conf/nginx.conf。</td></tr><tr><td>–pid-path=<code>&lt;path&gt;</code></td><td>在nginx.conf中没有指定pid指令的情况下，默认的nginx.pid的路径。如果没有指定，默认为 <code>&lt;prefix&gt;</code>/logs/nginx.pid。</td></tr><tr><td>–lock-path=<code>&lt;path&gt;</code></td><td>nginx.lock文件的路径。</td></tr><tr><td>–error-log-path=<code>&lt;path&gt;</code></td><td>在nginx.conf中没有指定error_log指令的情况下，默认的错误日志的路径。如果没有指定，默认为 <code>&lt;prefix&gt;</code>/- logs/error.log。</td></tr><tr><td>–http-log-path=<code>&lt;path&gt;</code></td><td>在nginx.conf中没有指定access_log指令的情况下，默认的访问日志的路径。如果没有指定，默认为 <code>&lt;prefix&gt;</code>/- logs/access.log。</td></tr><tr><td>–user=<code>&lt;user&gt;</code></td><td>在nginx.conf中没有指定user指令的情况下，默认的nginx使用的用户。如果没有指定，默认为 nobody。</td></tr><tr><td>–group=<code>&lt;group&gt;</code></td><td>在nginx.conf中没有指定user指令的情况下，默认的nginx使用的组。如果没有指定，默认为 nobody。</td></tr><tr><td>–builddir=DIR</td><td>指定编译的目录</td></tr><tr><td>–with-rtsig_module</td><td>启用 rtsig 模块</td></tr><tr><td>–with-select_module –without-select_module</td><td>允许或不允许开启SELECT模式，如果 configure 没有找到更合适的模式，比如：kqueue(sun os),epoll (linux kenel 2.6+), rtsig(- 实时信号)或者/dev/poll(一种类似select的模式，底层实现与SELECT基本相 同，都是采用轮训方法) SELECT模式将是默认安装模式</td></tr><tr><td>–with-poll_module –without-poll_module</td><td>Whether or not to enable the poll module. This module is enabled by, default if a more suitable method such as kqueue, epoll, rtsig or /dev/poll is not discovered by configure.</td></tr><tr><td>–with-http_ssl_module</td><td>Enable ngx_http_ssl_module. Enables SSL support and the ability to handle HTTPS requests. Requires OpenSSL. On Debian, this is libssl-dev. 开启HTTP SSL模块，使NGINX可以支持HTTPS请求。这个模块需要已经安装了OPENSSL，在DEBIAN上是libssl</td></tr><tr><td>–with-http_realip_module</td><td>启用 ngx_http_realip_module</td></tr><tr><td>–with-http_addition_module</td><td>启用 ngx_http_addition_module</td></tr><tr><td>–with-http_sub_module</td><td>启用 ngx_http_sub_module</td></tr><tr><td>–with-http_dav_module</td><td>启用 ngx_http_dav_module</td></tr><tr><td>–with-http_flv_module</td><td>启用 ngx_http_flv_module</td></tr><tr><td>–with-http_stub_status_module</td><td>启用 “server status” 页</td></tr><tr><td>–without-http_charset_module</td><td>禁用 ngx_http_charset_module</td></tr><tr><td>–without-http_gzip_module</td><td>禁用 ngx_http_gzip_module. 如果启用，需要 zlib 。</td></tr><tr><td>–without-http_ssi_module</td><td>禁用 ngx_http_ssi_module</td></tr><tr><td>–without-http_userid_module</td><td>禁用 ngx_http_userid_module</td></tr><tr><td>–without-http_access_module</td><td>禁用 ngx_http_access_module</td></tr><tr><td>–without-http_auth_basic_module</td><td>禁用 ngx_http_auth_basic_module</td></tr><tr><td>–without-http_autoindex_module</td><td>禁用 ngx_http_autoindex_module</td></tr><tr><td>–without-http_geo_module</td><td>禁用 ngx_http_geo_module</td></tr><tr><td>–without-http_map_module</td><td>禁用 ngx_http_map_module</td></tr><tr><td>–without-http_referer_module</td><td>禁用 ngx_http_referer_module</td></tr><tr><td>–without-http_rewrite_module</td><td>禁用 ngx_http_rewrite_module. 如果启用需要 PCRE 。</td></tr><tr><td>–without-http_proxy_module</td><td>禁用 ngx_http_proxy_module</td></tr><tr><td>–without-http_fastcgi_module</td><td>禁用 ngx_http_fastcgi_module</td></tr><tr><td>–without-http_memcached_module</td><td>禁用 ngx_http_memcached_module</td></tr><tr><td>–without-http_limit_zone_module</td><td>禁用 ngx_http_limit_zone_module</td></tr><tr><td>–without-http_empty_gif_module</td><td>禁用 ngx_http_empty_gif_module</td></tr><tr><td>–without-http_browser_module</td><td>禁用 ngx_http_browser_module</td></tr><tr><td>–without-http_upstream_ip_hash_module</td><td>禁用 ngx_http_upstream_ip_hash_module</td></tr><tr><td>–with-http_perl_module</td><td>启用 ngx_http_perl_module</td></tr><tr><td>–with-perl_modules_path=PATH</td><td>指定 perl 模块的路径</td></tr><tr><td>–with-perl=PATH</td><td>指定 perl 执行文件的路径</td></tr><tr><td>–http-log-path=PATH</td><td>Set path to the http access log</td></tr><tr><td>–http-client-body-temp-path=PATH</td><td>Set path to the http client request body temporary files</td></tr><tr><td>–http-proxy-temp-path=PATH</td><td>Set path to the http proxy temporary files</td></tr><tr><td>–http-fastcgi-temp-path=PATH</td><td>Set path to the http fastcgi temporary files</td></tr><tr><td>–without-http</td><td>禁用 HTTP server</td></tr><tr><td>–with-mail</td><td>启用 IMAP4/POP3/SMTP 代理模块</td></tr><tr><td>–with-mail_ssl_module</td><td>启用 ngx_mail_ssl_module</td></tr><tr><td>–with-cc=PATH</td><td>指定 C 编译器的路径</td></tr><tr><td>–with-cpp=PATH</td><td>指定 C 预处理器的路径</td></tr><tr><td>–with-cc-opt=OPTIONS</td><td>Additional parameters which will be added to the variable CFLAGS. With the use of the system library PCRE in FreeBSD, it is necessary to indicate –with-cc-opt=”-I /usr/local/include”. If we are using select() and it is necessary to increase the number of file descriptors, then this also can be assigned here: –with-cc-opt=”-D FD_SETSIZE=2048”.</td></tr><tr><td>–with-ld-opt=OPTIONS</td><td>Additional parameters passed to the linker. With the use of the system library PCRE in - FreeBSD, it is necessary to indicate –with-ld-opt=”-L /usr/local/lib”.</td></tr><tr><td>–with-cpu-opt=CPU</td><td>为特定的 CPU 编译，有效的值包括：pentium, pentiumpro, pentium3, pentium4, athlon, opteron, amd64, sparc32, sparc64, ppc64</td></tr><tr><td>–without-pcre</td><td>禁止 PCRE 库的使用。同时也会禁止 HTTP rewrite 模块。在 “location” 配置指令中的正则表达式也需要 PCRE 。</td></tr><tr><td>–with-pcre=DIR</td><td>指定 PCRE 库的源代码的路径。</td></tr><tr><td>–with-pcre-opt=OPTIONS</td><td>Set additional options for PCRE building.</td></tr><tr><td>–with-md5=DIR</td><td>Set path to md5 library sources.</td></tr><tr><td>–with-md5-opt=OPTIONS</td><td>Set additional options for md5 building.</td></tr><tr><td>–with-md5-asm</td><td>Use md5 assembler sources.</td></tr><tr><td>–with-sha1=DIR</td><td>Set path to sha1 library sources.</td></tr><tr><td>–with-sha1-opt=OPTIONS</td><td>Set additional options for sha1 building.</td></tr><tr><td>–with-sha1-asm</td><td>Use sha1 assembler sources.</td></tr><tr><td>–with-zlib=DIR</td><td>Set path to zlib library sources.</td></tr><tr><td>–with-zlib-opt=OPTIONS</td><td>Set additional options for zlib building.</td></tr><tr><td>–with-zlib-asm=CPU</td><td>Use zlib assembler sources optimized for specified CPU, valid values are: pentium, pentiumpro</td></tr><tr><td>–with-openssl=DIR</td><td>Set path to OpenSSL library sources</td></tr><tr><td>–with-openssl-opt=OPTIONS</td><td>Set additional options for OpenSSL building</td></tr><tr><td>–with-debug</td><td>启用调试日志</td></tr><tr><td>–add-module=PATH</td><td>Add in a third-party module found in directory PATH</td></tr></tbody></table><h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><p>在Centos 默认配置文件在 <strong>/usr/local/nginx-1.5.1/conf/nginx.conf</strong> 我们要在这里配置一些文件。nginx.conf是主配置文件，由若干个部分组成，每个大括号<code>{}</code>表示一个部分。每一行指令都由分号结束<code>;</code>，标志着一行的结束。</p><h2 id="常用正则"><a href="#常用正则" class="headerlink" title="常用正则"></a>常用正则</h2><table><thead><tr><th>正则</th><th>说明</th><th>正则</th><th>说明</th></tr></thead><tbody><tr><td><code>.</code></td><td>匹配除换行符以外的任意字符</td><td><code>$</code></td><td>匹配字符串的结束</td></tr><tr><td><code>?</code></td><td>重复0次或1次</td><td><code>{n}</code></td><td>重复n次</td></tr><tr><td><code>+</code></td><td>重复1次或更多次</td><td><code>{n,}</code></td><td>重复n次或更多次</td></tr><tr><td><code>*</code></td><td>重复0次或更多次</td><td><code>[c]</code></td><td>匹配单个字符c</td></tr><tr><td><code>\d</code></td><td>匹配数字</td><td><code>[a-z]</code></td><td>匹配a-z小写字母的任意一个</td></tr><tr><td><code>^</code></td><td>匹配字符串的开始</td><td>-</td><td>-</td></tr></tbody></table><h2 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h2><table><thead><tr><th>变量</th><th>说明</th><th>变量</th><th>说明</th></tr></thead><tbody><tr><td>$args</td><td>这个变量等于请求行中的参数，同$query_string</td><td>$remote_port</td><td>客户端的端口。</td></tr><tr><td>$content_length</td><td>请求头中的Content-length字段。</td><td>$remote_user</td><td>已经经过Auth Basic Module验证的用户名。</td></tr><tr><td>$content_type</td><td>请求头中的Content-Type字段。</td><td>$request_filename</td><td>当前请求的文件路径，由root或alias指令与URI请求生成。</td></tr><tr><td>$document_root</td><td>当前请求在root指令中指定的值。</td><td>$scheme</td><td>HTTP方法（如http，https）。</td></tr><tr><td>$host</td><td>请求主机头字段，否则为服务器名称。</td><td>$server_protocol</td><td>请求使用的协议，通常是HTTP/1.0或HTTP/1.1。</td></tr><tr><td>$http_user_agent</td><td>客户端agent信息</td><td>$server_addr</td><td>服务器地址，在完成一次系统调用后可以确定这个值。</td></tr><tr><td>$http_cookie</td><td>客户端cookie信息</td><td>$server_name</td><td>服务器名称。</td></tr><tr><td>$limit_rate</td><td>这个变量可以限制连接速率。</td><td>$server_port</td><td>请求到达服务器的端口号。</td></tr><tr><td>$request_method</td><td>客户端请求的动作，通常为GET或POST。</td><td>$request_uri</td><td>包含请求参数的原始URI，不包含主机名，如：/foo/bar.php?arg=baz。</td></tr><tr><td>$remote_addr</td><td>客户端的IP地址。</td><td>$uri</td><td>不带请求参数的当前URI，$uri不包含主机名，如/foo/bar.html。</td></tr><tr><td>$document_uri</td><td>与$uri相同。</td><td>-</td><td>-</td></tr></tbody></table><p>例如请求：<code>http://localhost:3000/test1/test2/test.php</code></p><p>$host：localhost<br>$server_port：3000<br>$request_uri：/test1/test2/test.php<br>$document_uri：/test1/test2/test.php<br>$document_root：/var/www/html<br>$request_filename：/var/www/html/test1/test2/test.php</p><h2 id="符号参考"><a href="#符号参考" class="headerlink" title="符号参考"></a>符号参考</h2><table><thead><tr><th>符号</th><th>说明</th><th>符号</th><th>说明</th><th>符号</th><th>说明</th></tr></thead><tbody><tr><td>k,K</td><td>千字节</td><td>m,M</td><td>兆字节</td><td>ms</td><td>毫秒</td></tr><tr><td>s</td><td>秒</td><td>m</td><td>分钟</td><td>h</td><td>小时</td></tr><tr><td>d</td><td>日</td><td>w</td><td>周</td><td>M</td><td>一个月, 30天</td></tr></tbody></table><p>例如，”8k”，”1m” 代表字节数计量。<br>例如，”1h 30m”，”1y 6M”。代表 “1小时 30分”，”1年零6个月”。</p><h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>nginx 的配置系统由一个主配置文件和其他一些辅助的配置文件构成。这些配置文件均是纯文本文件，全部位于 nginx 安装目录下的 conf 目录下。</p><p>指令由 nginx 的各个模块提供，不同的模块会提供不同的指令来实现配置。 指令除了 Key-Value 的形式，还有作用域指令。</p><p>nginx.conf 中的配置信息，根据其逻辑上的意义，对它们进行了分类，也就是分成了多个作用域，或者称之为配置指令上下文。不同的作用域含有一个或者多个配置项。</p><p>下面的这些上下文指令是用的比较多：</p><table><thead><tr><th>Directive</th><th>Description</th><th>Contains Directive</th></tr></thead><tbody><tr><td>main</td><td>nginx 在运行时与具体业务功能（比如 http 服务或者 email 服务代理）无关的一些参数，比如工作进程数，运行的身份等。</td><td>user, worker_processes, error_log, events, http, mail</td></tr><tr><td>http</td><td>与提供 http 服务相关的一些配置参数。例如：是否使用 keepalive 啊，是否使用 gzip 进行压缩等。</td><td>server</td></tr><tr><td>server</td><td>http 服务上支持若干虚拟主机。每个虚拟主机一个对应的 server 配置项，配置项里面包含该虚拟主机相关的配置。在提供 mail 服务的代理时，也可以建立若干 server. 每个 server 通过监听的地址来区分。</td><td>listen, server_name, access_log, location, protocol, proxy, smtp_auth, xclient</td></tr><tr><td>location</td><td>http 服务中，某些特定的 URL 对应的一系列配置项。</td><td>index, root</td></tr><tr><td>mail</td><td>实现 email 相关的 SMTP/IMAP/POP3 代理时，共享的一些配置项（因为可能实现多个代理，工作在多个监听地址上）。</td><td>server, http, imap_capabilities</td></tr><tr><td>include</td><td>以便增强配置文件的可读性，使得部分配置文件可以重新使用。</td><td>-</td></tr><tr><td>valid_referers</td><td>用来校验Http请求头Referer是否有效。</td><td>-</td></tr><tr><td>try_files</td><td>用在server部分，不过最常见的还是用在location部分，它会按照给定的参数顺序进行尝试，第一个被匹配到的将会被使用。</td><td>-</td></tr><tr><td>if</td><td>当在location块中使用if指令，在某些情况下它并不按照预期运行，一般来说避免使用if指令。</td><td>-</td></tr></tbody></table><p>例如我们再 <strong>nginx.conf</strong> 里面引用两个配置 vhost/example.com.conf 和 vhost/gitlab.com.conf 它们都被放在一个我自己新建的目录 vhost 下面。nginx.conf 配置如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  1;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    #log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">    #                  &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">    #                  &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line"></span><br><span class="line">    #access_log  logs/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        location / &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    include  vhost/example.com.conf;</span><br><span class="line">    include  vhost/gitlab.com.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单的配置: example.com.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    #侦听的80端口</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  baidu.com app.baidu.com; # 这里指定域名</span><br><span class="line">    index        index.html index.htm;    # 这里指定默认入口页面</span><br><span class="line">    root /home/www/app.baidu.com;         # 这里指定目录</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="内置预定义变量"><a href="#内置预定义变量" class="headerlink" title="内置预定义变量"></a>内置预定义变量</h2><p>Nginx提供了许多预定义的变量，也可以通过使用set来设置变量。你可以在if中使用预定义变量，也可以将它们传递给代理服务器。以下是一些常见的预定义变量，<a href="http://nginx.org/en/docs/varindex.html" target="_blank" rel="noopener">更多详见</a></p><table><thead><tr><th>变量名称</th><th>值</th></tr></thead><tbody><tr><td>$args_name</td><td>在请求中的name参数</td></tr><tr><td>$args</td><td>所有请求参数</td></tr><tr><td>$query_string</td><td>$args的别名</td></tr><tr><td>$content_length</td><td>请求头Content-Length的值</td></tr><tr><td>$content_type</td><td>请求头Content-Type的值</td></tr><tr><td>$host</td><td>如果当前有Host，则为请求头Host的值；如果没有这个头，那么该值等于匹配该请求的server_name的值</td></tr><tr><td>$remote_addr</td><td>客户端的IP地址</td></tr><tr><td>$request</td><td>完整的请求，从客户端收到，包括Http请求方法、URI、Http协议、头、请求体</td></tr><tr><td>$request_uri</td><td>完整请求的URI，从客户端来的请求，包括参数</td></tr><tr><td>$scheme</td><td>当前请求的协议</td></tr><tr><td>$uri</td><td>当前请求的标准化URI</td></tr></tbody></table><h2 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h2><p>反向代理是一个Web服务器，它接受客户端的连接请求，然后将请求转发给上游服务器，并将从服务器得到的结果返回给连接的客户端。下面简单的反向代理的例子：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server &#123;  </span><br><span class="line">  listen       80;                                                        </span><br><span class="line">  server_name  localhost;                                              </span><br><span class="line">  client_max_body_size 1024M;  # 允许客户端请求的最大单文件字节数</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_pass                         http://localhost:8080;</span><br><span class="line">    proxy_set_header Host              $host:$server_port;</span><br><span class="line">    proxy_set_header X-Forwarded-For   $remote_addr; # HTTP的请求端真实的IP</span><br><span class="line">    proxy_set_header X-Forwarded-Proto $scheme;      # 为了正确地识别实际用户发出的协议是 http 还是 https</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>复杂的配置: gitlab.com.conf。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    #侦听的80端口</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  git.example.cn;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass   http://localhost:3000;</span><br><span class="line">        #以下是一些反向代理的配置可删除</span><br><span class="line">        proxy_redirect             off;</span><br><span class="line">        #后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span><br><span class="line">        proxy_set_header           Host $host;</span><br><span class="line">        client_max_body_size       10m; #允许客户端请求的最大单文件字节数</span><br><span class="line">        client_body_buffer_size    128k; #缓冲区代理缓冲用户端请求的最大字节数</span><br><span class="line">        proxy_connect_timeout      300; #nginx跟后端服务器连接超时时间(代理连接超时)</span><br><span class="line">        proxy_send_timeout         300; #后端服务器数据回传时间(代理发送超时)</span><br><span class="line">        proxy_read_timeout         300; #连接成功后，后端服务器响应时间(代理接收超时)</span><br><span class="line">        proxy_buffer_size          4k; #设置代理服务器（nginx）保存用户头信息的缓冲区大小</span><br><span class="line">        proxy_buffers              4 32k; #proxy_buffers缓冲区，网页平均在32k以下的话，这样设置</span><br><span class="line">        proxy_busy_buffers_size    64k; #高负荷下缓冲大小（proxy_buffers*2）</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代理到上游服务器的配置中，最重要的是proxy_pass指令。以下是代理模块中的一些常用指令：</p><table><thead><tr><th>指令</th><th>说明</th></tr></thead><tbody><tr><td>proxy_connect_timeout</td><td>Nginx从接受请求至连接到上游服务器的最长等待时间</td></tr><tr><td>proxy_send_timeout</td><td>后端服务器数据回传时间(代理发送超时)</td></tr><tr><td>proxy_read_timeout</td><td>连接成功后，后端服务器响应时间(代理接收超时)</td></tr><tr><td>proxy_cookie_domain</td><td>替代从上游服务器来的Set-Cookie头的domain属性</td></tr><tr><td>proxy_cookie_path</td><td>替代从上游服务器来的Set-Cookie头的path属性</td></tr><tr><td>proxy_buffer_size</td><td>设置代理服务器（nginx）保存用户头信息的缓冲区大小</td></tr><tr><td>proxy_buffers</td><td>proxy_buffers缓冲区，网页平均在多少k以下</td></tr><tr><td>proxy_set_header</td><td>重写发送到上游服务器头的内容，也可以通过将某个头部的值设置为空字符串，而不发送某个头部的方法实现</td></tr><tr><td>proxy_ignore_headers</td><td>这个指令禁止处理来自代理服务器的应答。</td></tr><tr><td>proxy_intercept_errors</td><td>使nginx阻止HTTP应答代码为400或者更高的应答。</td></tr></tbody></table><h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><p>upstream指令启用一个新的配置区段，在该区段定义一组上游服务器。这些服务器可能被设置不同的权重，也可能出于对服务器进行维护，标记为down。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">upstream gitlab &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    # upstream的负载均衡，weight是权重，可以根据机器配置定义权重。weigth参数表示权值，权值越高被分配到的几率越大。</span><br><span class="line">    server 192.168.122.11:8081 ;</span><br><span class="line">    server 127.0.0.1:82 weight=3;</span><br><span class="line">    server 127.0.0.1:83 weight=3 down;</span><br><span class="line">    server 127.0.0.1:84 weight=3; max_fails=3  fail_timeout=20s;</span><br><span class="line">    server 127.0.0.1:85 weight=4;;</span><br><span class="line">    keepalive 32;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    #侦听的80端口</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  git.example.cn;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass   http://gitlab;    #在这里设置一个代理，和upstream的名字一样</span><br><span class="line">        #以下是一些反向代理的配置可删除</span><br><span class="line">        proxy_redirect             off;</span><br><span class="line">        #后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span><br><span class="line">        proxy_set_header           Host $host;</span><br><span class="line">        proxy_set_header           X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header           X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        client_max_body_size       10m;  #允许客户端请求的最大单文件字节数</span><br><span class="line">        client_body_buffer_size    128k; #缓冲区代理缓冲用户端请求的最大字节数</span><br><span class="line">        proxy_connect_timeout      300;  #nginx跟后端服务器连接超时时间(代理连接超时)</span><br><span class="line">        proxy_send_timeout         300;  #后端服务器数据回传时间(代理发送超时)</span><br><span class="line">        proxy_read_timeout         300;  #连接成功后，后端服务器响应时间(代理接收超时)</span><br><span class="line">        proxy_buffer_size          4k; #设置代理服务器（nginx）保存用户头信息的缓冲区大小</span><br><span class="line">        proxy_buffers              4 32k;# 缓冲区，网页平均在32k以下的话，这样设置</span><br><span class="line">        proxy_busy_buffers_size    64k; #高负荷下缓冲大小（proxy_buffers*2）</span><br><span class="line">        proxy_temp_file_write_size 64k; #设定缓存文件夹大小，大于这个值，将从upstream服务器传</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。</p><p><strong>负载均衡：</strong></p><p>upstream模块能够使用3种负载均衡算法：轮询、IP哈希、最少连接数。</p><p><strong>轮询：</strong> 默认情况下使用轮询算法，不需要配置指令来激活它，它是基于在队列中谁是下一个的原理确保访问均匀地分布到每个上游服务器；<br><strong>IP哈希：</strong> 通过ip_hash指令来激活，Nginx通过IPv4地址的前3个字节或者整个IPv6地址作为哈希键来实现，同一个IP地址总是能被映射到同一个上游服务器；<br><strong>最少连接数：</strong> 通过least_conn指令来激活，该算法通过选择一个活跃数最少的上游服务器进行连接。如果上游服务器处理能力不同，可以通过给server配置weight权重来说明，该算法将考虑到不同服务器的加权最少连接数。</p><h3 id="RR"><a href="#RR" class="headerlink" title="RR"></a>RR</h3><p><strong>简单配置</strong> ，这里我配置了2台服务器，当然实际上是一台，只是端口不一样而已，而8081的服务器是不存在的，也就是说访问不到，但是我们访问 <code>http://localhost</code> 的时候，也不会有问题，会默认跳转到<code>http://localhost:8080</code>具体是因为Nginx会自动判断服务器的状态，如果服务器处于不能访问（服务器挂了），就不会跳转到这台服务器，所以也避免了一台服务器挂了影响使用的情况，由于Nginx默认是RR策略，所以我们不需要其他更多的设置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">upstream test &#123;</span><br><span class="line">    server localhost:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       81;</span><br><span class="line">    server_name  localhost;</span><br><span class="line">    client_max_body_size 1024M;</span><br><span class="line"> </span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://test;</span><br><span class="line">        proxy_set_header Host $host:$server_port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>负载均衡的核心代码为</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream test &#123;</span><br><span class="line">    server localhost:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="权重"><a href="#权重" class="headerlink" title="权重"></a>权重</h3><p>指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。 例如</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream test &#123;</span><br><span class="line">    server localhost:8080 weight=9;</span><br><span class="line">    server localhost:8081 weight=1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么10次一般只会有1次会访问到8081，而有9次会访问到8080</p><h3 id="ip-hash"><a href="#ip-hash" class="headerlink" title="ip_hash"></a>ip_hash</h3><p>上面的2种方式都有一个问题，那就是下一个请求来的时候请求可能分发到另外一个服务器，当我们的程序不是无状态的时候（采用了session保存数据），这时候就有一个很大的很问题了，比如把登录信息保存到了session中，那么跳转到另外一台服务器的时候就需要重新登录了，所以很多时候我们需要一个客户只访问一个服务器，那么就需要用iphash了，iphash的每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream test &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    server localhost:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="fair"><a href="#fair" class="headerlink" title="fair"></a>fair</h3><p>这是个第三方模块，按后端服务器的响应时间来分配请求，响应时间短的优先分配。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    fair;</span><br><span class="line">    server localhost:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="url-hash"><a href="#url-hash" class="headerlink" title="url_hash"></a>url_hash</h3><p>这是个第三方模块，按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为缓存时比较有效。 在upstream中加入hash语句，server语句中不能写入weight等其他的参数，hash_method是使用的hash算法</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    hash $request_uri;</span><br><span class="line">    hash_method crc32;</span><br><span class="line">    server localhost:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上5种负载均衡各自适用不同情况下使用，所以可以根据实际情况选择使用哪种策略模式，不过fair和url_hash需要安装第三方模块才能使用</p><p><strong>server指令可选参数：</strong></p><ol><li>weight：设置一个服务器的访问权重，数值越高，收到的请求也越多；</li><li>fail_timeout：在这个指定的时间内服务器必须提供响应，如果在这个时间内没有收到响应，那么服务器将会被标记为down状态；</li><li>max_fails：设置在fail_timeout时间之内尝试对一个服务器连接的最大次数，如果超过这个次数，那么服务器将会被标记为down;</li><li>down：标记一个服务器不再接受任何请求；</li><li>backup：一旦其他服务器宕机，那么有该标记的机器将会接收请求。</li></ol><p><strong>keepalive指令：</strong></p><p>Nginx服务器将会为每一个worker进行保持同上游服务器的连接。</p><h2 id="屏蔽ip"><a href="#屏蔽ip" class="headerlink" title="屏蔽ip"></a>屏蔽ip</h2><p>在nginx的配置文件<code>nginx.conf</code>中加入如下配置，可以放到http, server, location, limit_except语句块，需要注意相对路径，本例当中<code>nginx.conf</code>，<code>blocksip.conf</code>在同一个目录中。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include blockip.conf;</span><br></pre></td></tr></table></figure><p>在blockip.conf里面输入内容，如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">deny 165.91.122.67;</span><br><span class="line"></span><br><span class="line">deny IP;   # 屏蔽单个ip访问</span><br><span class="line">allow IP;  # 允许单个ip访问</span><br><span class="line">deny all;  # 屏蔽所有ip访问</span><br><span class="line">allow all; # 允许所有ip访问</span><br><span class="line">deny 123.0.0.0/8   # 屏蔽整个段即从123.0.0.1到123.255.255.254访问的命令</span><br><span class="line">deny 124.45.0.0/16 # 屏蔽IP段即从123.45.0.1到123.45.255.254访问的命令</span><br><span class="line">deny 123.45.6.0/24 # 屏蔽IP段即从123.45.6.1到123.45.6.254访问的命令</span><br><span class="line"></span><br><span class="line"># 如果你想实现这样的应用，除了几个IP外，其他全部拒绝</span><br><span class="line">allow 1.1.1.1; </span><br><span class="line">allow 1.1.1.2;</span><br><span class="line">deny all;</span><br></pre></td></tr></table></figure><h1 id="第三方模块安装方法"><a href="#第三方模块安装方法" class="headerlink" title="第三方模块安装方法"></a>第三方模块安装方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/你的安装目录  --add-module=/第三方模块目录</span><br></pre></td></tr></table></figure><h1 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h1><ul><li><code>permanent</code> 永久性重定向。请求日志中的状态码为301</li><li><code>redirect</code> 临时重定向。请求日志中的状态码为302</li></ul><h2 id="重定向整个网站"><a href="#重定向整个网站" class="headerlink" title="重定向整个网站"></a>重定向整个网站</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    server_name old-site.com</span><br><span class="line">    return 301 $scheme://new-site.com$request_uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="重定向单页"><a href="#重定向单页" class="headerlink" title="重定向单页"></a>重定向单页</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    location = /oldpage.html &#123;</span><br><span class="line">        return 301 http://example.org/newpage.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="重定向整个子路径"><a href="#重定向整个子路径" class="headerlink" title="重定向整个子路径"></a>重定向整个子路径</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /old-site &#123;</span><br><span class="line">    rewrite ^/old-site/(.*) http://example.org/new-site/$1 permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h1><h2 id="内容缓存"><a href="#内容缓存" class="headerlink" title="内容缓存"></a>内容缓存</h2><p>允许浏览器基本上永久地缓存静态内容。 Nginx将为您设置Expires和Cache-Control头信息。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location /static &#123;</span><br><span class="line">    root /data;</span><br><span class="line">    expires max;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果要求浏览器永远不会缓存响应（例如用于跟踪请求），请使用-1。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location = /empty.gif &#123;</span><br><span class="line">    empty_gif;</span><br><span class="line">    expires -1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Gzip压缩"><a href="#Gzip压缩" class="headerlink" title="Gzip压缩"></a>Gzip压缩</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">gzip  on;</span><br><span class="line">gzip_buffers 16 8k;</span><br><span class="line">gzip_comp_level 6;</span><br><span class="line">gzip_http_version 1.1;</span><br><span class="line">gzip_min_length 256;</span><br><span class="line">gzip_proxied any;</span><br><span class="line">gzip_vary on;</span><br><span class="line">gzip_types</span><br><span class="line">    text/xml application/xml application/atom+xml application/rss+xml application/xhtml+xml image/svg+xml</span><br><span class="line">    text/javascript application/javascript application/x-javascript</span><br><span class="line">    text/x-json application/json application/x-web-app-manifest+json</span><br><span class="line">    text/css text/plain text/x-component</span><br><span class="line">    font/opentype application/x-font-ttf application/vnd.ms-fontobject</span><br><span class="line">    image/x-icon;</span><br><span class="line">gzip_disable  &quot;msie6&quot;;</span><br></pre></td></tr></table></figure><h2 id="打开文件缓存"><a href="#打开文件缓存" class="headerlink" title="打开文件缓存"></a>打开文件缓存</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">open_file_cache max=1000 inactive=20s;</span><br><span class="line">open_file_cache_valid 30s;</span><br><span class="line">open_file_cache_min_uses 2;</span><br><span class="line">open_file_cache_errors on;</span><br></pre></td></tr></table></figure><h2 id="SSL缓存"><a href="#SSL缓存" class="headerlink" title="SSL缓存"></a>SSL缓存</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssl_session_cache shared:SSL:10m;</span><br><span class="line">ssl_session_timeout 10m;</span><br></pre></td></tr></table></figure><h2 id="上游Keepalive"><a href="#上游Keepalive" class="headerlink" title="上游Keepalive"></a>上游Keepalive</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    server 127.0.0.1:8080;</span><br><span class="line">    keepalive 32;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    ...</span><br><span class="line">    location /api/ &#123;</span><br><span class="line">        proxy_pass http://backend;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connection &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h2><p>使用<code>ngxtop</code>实时解析nginx访问日志，并且将处理结果输出到终端，功能类似于系统命令top。所有示例都读取nginx配置文件的访问日志位置和格式。如果要指定访问日志文件和/或日志格式，请使用-f和-a选项。</p><p>注意：在nginx配置中<code>/usr/local/nginx/conf/nginx.conf</code>日志文件必须是绝对路径。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 安装 ngxtop</span><br><span class="line">pip install ngxtop</span><br><span class="line"></span><br><span class="line"># 实时状态</span><br><span class="line">ngxtop</span><br><span class="line"># 状态为404的前10个请求的路径：</span><br><span class="line">ngxtop top request_path --filter &apos;status == 404&apos;</span><br><span class="line"></span><br><span class="line"># 发送总字节数最多的前10个请求</span><br><span class="line">ngxtop --order-by &apos;avg(bytes_sent) * count&apos;</span><br><span class="line"></span><br><span class="line"># 排名前十位的IP，例如，谁攻击你最多</span><br><span class="line">ngxtop --group-by remote_addr</span><br><span class="line"></span><br><span class="line"># 打印具有4xx或5xx状态的请求，以及status和http referer</span><br><span class="line">ngxtop -i &apos;status &gt;= 400&apos; print request status http_referer</span><br><span class="line"></span><br><span class="line"># 由200个请求路径响应发送的平均正文字节以&apos;foo&apos;开始：</span><br><span class="line">ngxtop avg bytes_sent --filter &apos;status == 200 and request_path.startswith(&quot;foo&quot;)&apos;</span><br><span class="line"></span><br><span class="line"># 使用“common”日志格式从远程机器分析apache访问日志</span><br><span class="line">ssh remote tail -f /var/log/apache2/access.log | ngxtop -f common</span><br></pre></td></tr></table></figure><h1 id="常见使用场景"><a href="#常见使用场景" class="headerlink" title="常见使用场景"></a>常见使用场景</h1><h2 id="跨域问题"><a href="#跨域问题" class="headerlink" title="跨域问题"></a>跨域问题</h2><p>在工作中，有时候会遇到一些接口不支持跨域，这时候可以简单的添加add_headers来支持cors跨域。配置如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name api.xxx.com;</span><br><span class="line">    </span><br><span class="line">  add_header &apos;Access-Control-Allow-Origin&apos; &apos;*&apos;;</span><br><span class="line">  add_header &apos;Access-Control-Allow-Credentials&apos; &apos;true&apos;;</span><br><span class="line">  add_header &apos;Access-Control-Allow-Methods&apos; &apos;GET,POST,HEAD&apos;;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_pass http://127.0.0.1:3000;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header Host  $http_host;    </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面更改头信息，还有一种，使用 <a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html" target="_blank" rel="noopener">rewrite</a> 指令重定向URI来解决跨域问题。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">upstream test &#123;</span><br><span class="line">  server 127.0.0.1:8080;</span><br><span class="line">  server localhost:8081;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name api.xxx.com;</span><br><span class="line">  location / &#123; </span><br><span class="line">    root  html;                   #去请求../html文件夹里的文件</span><br><span class="line">    index  index.html index.htm;  #首页响应地址</span><br><span class="line">  &#125;</span><br><span class="line">  # 用于拦截请求，匹配任何以 /api/开头的地址，</span><br><span class="line">  # 匹配符合以后，停止往下搜索正则。</span><br><span class="line">  location ^~/api/&#123; </span><br><span class="line">    # 代表重写拦截进来的请求，并且只能对域名后边的除去传递的参数外的字符串起作用，</span><br><span class="line">    # 例如www.a.com/proxy/api/msg?meth=1&amp;par=2重写，只对/proxy/api/msg重写。</span><br><span class="line">    # rewrite后面的参数是一个简单的正则 ^/api/(.*)$，</span><br><span class="line">    # $1代表正则中的第一个()，$2代表第二个()的值，以此类推。</span><br><span class="line">    rewrite ^/api/(.*)$ /$1 break;</span><br><span class="line">    </span><br><span class="line">    # 把请求代理到其他主机 </span><br><span class="line">    # 其中 http://www.b.com/ 写法和 http://www.b.com写法的区别如下</span><br><span class="line">    # 如果你的请求地址是他 http://server/html/test.jsp</span><br><span class="line">    # 配置一： http://www.b.com/ 后面有“/” </span><br><span class="line">    #         将反向代理成 http://www.b.com/html/test.jsp 访问</span><br><span class="line">    # 配置一： http://www.b.com 后面没有有“/” </span><br><span class="line">    #         将反向代理成 http://www.b.com/test.jsp 访问</span><br><span class="line">    proxy_pass http://test;</span><br><span class="line"></span><br><span class="line">    # 如果 proxy_pass  URL 是 http://a.xx.com/platform/ 这种情况</span><br><span class="line">    # proxy_cookie_path应该设置成 /platform/ / (注意两个斜杠之间有空格)。</span><br><span class="line">    proxy_cookie_path /platfrom/ /;</span><br><span class="line"></span><br><span class="line">    # http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass_header</span><br><span class="line">    # 设置 Cookie 头通过</span><br><span class="line">    proxy_pass_header Set-Cookie;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="跳转到带www的域上面"><a href="#跳转到带www的域上面" class="headerlink" title="跳转到带www的域上面"></a>跳转到带www的域上面</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    # 配置正常的带www的域名</span><br><span class="line">    server_name www.wangchujiang.com;</span><br><span class="line">    root /home/www/wabg/download;</span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files $uri $uri/ /index.html =404;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    # 这个要放到下面，</span><br><span class="line">    # 将不带www的 wangchujiang.com 永久性重定向到  https://www.wangchujiang.com</span><br><span class="line">    server_name wangchujiang.com;</span><br><span class="line">    rewrite ^(.*) https://www.wangchujiang.com$1 permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="代理转发"><a href="#代理转发" class="headerlink" title="代理转发"></a>代理转发</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">upstream server-api&#123;</span><br><span class="line">    # api 代理服务地址</span><br><span class="line">    server 127.0.0.1:3110;    </span><br><span class="line">&#125;</span><br><span class="line">upstream server-resource&#123;</span><br><span class="line">    # 静态资源 代理服务地址</span><br><span class="line">    server 127.0.0.1:3120;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       3111;</span><br><span class="line">    server_name  localhost;      # 这里指定域名</span><br><span class="line">    root /home/www/server-statics;</span><br><span class="line">    # 匹配 api 路由的反向代理到API服务</span><br><span class="line">    location ^~/api/ &#123;</span><br><span class="line">        rewrite ^/(.*)$ /$1 break;</span><br><span class="line">        proxy_pass http://server-api;</span><br><span class="line">    &#125;</span><br><span class="line">    # 假设这里验证码也在API服务中</span><br><span class="line">    location ^~/captcha &#123;</span><br><span class="line">        rewrite ^/(.*)$ /$1 break;</span><br><span class="line">        proxy_pass http://server-api;</span><br><span class="line">    &#125;</span><br><span class="line">    # 假设你的图片资源全部在另外一个服务上面</span><br><span class="line">    location ^~/img/ &#123;</span><br><span class="line">        rewrite ^/(.*)$ /$1 break;</span><br><span class="line">        proxy_pass http://server-resource;</span><br><span class="line">    &#125;</span><br><span class="line">    # 路由在前端，后端没有真实路由，在路由不存在的 404状态的页面返回 /index.html</span><br><span class="line">    # 这个方式使用场景，你在写React或者Vue项目的时候，没有真实路由</span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files $uri $uri/ /index.html =404;</span><br><span class="line">        #                               ^ 空格很重要</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="监控状态信息"><a href="#监控状态信息" class="headerlink" title="监控状态信息"></a>监控状态信息</h2><p>通过 <code>nginx -V</code> 来查看是否有 <code>with-http_stub_status_module</code> 该模块。</p><blockquote><p><code>nginx -V</code> 这里 <code>V</code> 是大写的，如果是小写的 <code>v</code> 即 <code>nginx -v</code>，则不会出现有哪些模块，只会出现 <code>nginx</code> 的版本</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location /nginx_status &#123;</span><br><span class="line">    stub_status on;</span><br><span class="line">    access_log off;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过 <a href="http://127.0.0.1/nginx_status" target="_blank" rel="noopener">http://127.0.0.1/nginx_status</a> 访问出现下面结果。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Active connections: 3</span><br><span class="line">server accepts handled requests</span><br><span class="line"> 7 7 5 </span><br><span class="line">Reading: 0 Writing: 1 Waiting: 2</span><br></pre></td></tr></table></figure><ol><li>主动连接(第 1 行)</li></ol><p>当前与http建立的连接数，包括等待的客户端连接：3</p><ol><li>服务器接受处理的请求(第 2~3 行)</li></ol><p>接受的客户端连接总数目：7<br>处理的客户端连接总数目：7<br>客户端总的请求数目：5</p><ol><li>读取其它信(第 4 行)</li></ol><p>当前，nginx读请求连接<br>当前，nginx写响应返回给客户端<br>目前有多少空闲客户端请求连接</p><h2 id="代理转发连接替换"><a href="#代理转发连接替换" class="headerlink" title="代理转发连接替换"></a>代理转发连接替换</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location ^~/api/upload &#123;</span><br><span class="line">    rewrite ^/(.*)$ /wfs/v1/upload break;</span><br><span class="line">    proxy_pass http://wfs-api;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ssl配置"><a href="#ssl配置" class="headerlink" title="ssl配置"></a>ssl配置</h2><p>超文本传输安全协议（缩写：HTTPS，英语：Hypertext Transfer Protocol Secure）是超文本传输协议和SSL/TLS的组合，用以提供加密通讯及对网络服务器身份的鉴定。HTTPS连接经常被用于万维网上的交易支付和企业信息系统中敏感信息的传输。HTTPS不应与在RFC 2660中定义的安全超文本传输协议（S-HTTP）相混。HTTPS 目前已经是所有注重隐私和安全的网站的首选，随着技术的不断发展，HTTPS 网站已不再是大型网站的专利，所有普通的个人站长和博客均可以自己动手搭建一个安全的加密的网站。</p><p>创建SSL证书，如果你购买的证书，就可以直接下载</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /etc/nginx/ssl</span><br><span class="line"># 创建了有效期100年，加密强度为RSA2048的SSL密钥key和X509证书文件。</span><br><span class="line">sudo openssl req -x509 -nodes -days 36500 -newkey rsa:2048 -keyout /etc/nginx/ssl/nginx.key -out /etc/nginx/ssl/nginx.crt</span><br><span class="line"># 上面命令，会有下面需要填写内容</span><br><span class="line">Country Name (2 letter code) [AU]:US</span><br><span class="line">State or Province Name (full name) [Some-State]:New York</span><br><span class="line">Locality Name (eg, city) []:New York City</span><br><span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:Bouncy Castles, Inc.</span><br><span class="line">Organizational Unit Name (eg, section) []:Ministry of Water Slides</span><br><span class="line">Common Name (e.g. server FQDN or YOUR name) []:your_domain.com</span><br><span class="line">Email Address []:admin@your_domain.com</span><br></pre></td></tr></table></figure><p>创建自签证书</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">首先，创建证书和私钥的目录</span><br><span class="line"># mkdir -p /etc/nginx/cert</span><br><span class="line"># cd /etc/nginx/cert</span><br><span class="line">创建服务器私钥，命令会让你输入一个口令：</span><br><span class="line"># openssl genrsa -des3 -out nginx.key 2048</span><br><span class="line">创建签名请求的证书（CSR）：</span><br><span class="line"># openssl req -new -key nginx.key -out nginx.csr</span><br><span class="line">在加载SSL支持的Nginx并使用上述私钥时除去必须的口令：</span><br><span class="line"># cp nginx.key nginx.key.org</span><br><span class="line"># openssl rsa -in nginx.key.org -out nginx.key</span><br><span class="line">最后标记证书使用上述私钥和CSR：</span><br><span class="line"># openssl x509 -req -days 365 -in nginx.csr -signkey nginx.key -out nginx.crt</span><br></pre></td></tr></table></figure><p>查看目前nginx编译选项</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sbin/nginx -V</span><br></pre></td></tr></table></figure><p>输出下面内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx version: nginx/1.7.8</span><br><span class="line">built by gcc 4.4.7 20120313 (Red Hat 4.4.7-4) (GCC)</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/local/nginx-1.7.8 --with-http_ssl_module --with-http_spdy_module --with-http_stub_status_module --with-pcre</span><br></pre></td></tr></table></figure><p>如果依赖的模块不存在，可以进入安装目录，输入下面命令重新编译安装。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/local/nginx --with-http_stub_status_module --with-http_ssl_module</span><br></pre></td></tr></table></figure><p>运行完成之后还需要<code>make</code> (不用make install)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 备份nginx的二进制文件</span><br><span class="line">cp -rf /usr/local/nginx/sbin/nginx　 /usr/local/nginx/sbin/nginx.bak</span><br><span class="line"># 覆盖nginx的二进制文件</span><br><span class="line">cp -rf objs/nginx   /usr/local/nginx/sbin/</span><br></pre></td></tr></table></figure><p>HTTPS server</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       443 ssl;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">    # 禁止在header中出现服务器版本，防止黑客利用版本漏洞攻击</span><br><span class="line">    server_tokens off;</span><br><span class="line">    # 设置ssl/tls会话缓存的类型和大小。如果设置了这个参数一般是shared，buildin可能会参数内存碎片，默认是none，和off差不多，停用缓存。如shared:SSL:10m表示我所有的nginx工作进程共享ssl会话缓存，官网介绍说1M可以存放约4000个sessions。 </span><br><span class="line">    ssl_session_cache    shared:SSL:1m; </span><br><span class="line"></span><br><span class="line">    # 客户端可以重用会话缓存中ssl参数的过期时间，内网系统默认5分钟太短了，可以设成30m即30分钟甚至4h。</span><br><span class="line">    ssl_session_timeout  5m; </span><br><span class="line"></span><br><span class="line">    # 选择加密套件，不同的浏览器所支持的套件（和顺序）可能会不同。</span><br><span class="line">    # 这里指定的是OpenSSL库能够识别的写法，你可以通过 openssl -v cipher &apos;RC4:HIGH:!aNULL:!MD5&apos;（后面是你所指定的套件加密算法） 来看所支持算法。</span><br><span class="line">    ssl_ciphers  HIGH:!aNULL:!MD5;</span><br><span class="line"></span><br><span class="line">    # 设置协商加密算法时，优先使用我们服务端的加密套件，而不是客户端浏览器的加密套件。</span><br><span class="line">    ssl_prefer_server_ciphers  on;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="强制将http重定向到https"><a href="#强制将http重定向到https" class="headerlink" title="强制将http重定向到https"></a>强制将http重定向到https</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  example.com;</span><br><span class="line">    rewrite ^ https://$http_host$request_uri? permanent;    # 强制将http重定向到https</span><br><span class="line">    # 在错误页面和“服务器”响应头字段中启用或禁用发射nginx版本。 防止黑客利用版本漏洞攻击</span><br><span class="line">    server_tokens off;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="两个虚拟主机"><a href="#两个虚拟主机" class="headerlink" title="两个虚拟主机"></a>两个虚拟主机</h2><p>纯静态-html 支持</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen          80;</span><br><span class="line">        server_name     www.domain1.com;</span><br><span class="line">        access_log      logs/domain1.access.log main;</span><br><span class="line">        location / &#123;</span><br><span class="line">            index index.html;</span><br><span class="line">            root  /var/www/domain1.com/htdocs;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen          80;</span><br><span class="line">        server_name     www.domain2.com;</span><br><span class="line">        access_log      logs/domain2.access.log main;</span><br><span class="line">        location / &#123;</span><br><span class="line">            index index.html;</span><br><span class="line">            root  /var/www/domain2.com/htdocs;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="虚拟主机标准配置"><a href="#虚拟主机标准配置" class="headerlink" title="虚拟主机标准配置"></a>虚拟主机标准配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">  server &#123;</span><br><span class="line">    listen          80 default;</span><br><span class="line">    server_name     _ *;</span><br><span class="line">    access_log      logs/default.access.log main;</span><br><span class="line">    location / &#123;</span><br><span class="line">       index index.html;</span><br><span class="line">       root  /var/www/default/htdocs;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="爬虫过滤"><a href="#爬虫过滤" class="headerlink" title="爬虫过滤"></a>爬虫过滤</h2><p>根据 <code>User-Agent</code> 过滤请求，通过一个简单的正则表达式，就可以过滤不符合要求的爬虫请求(初级爬虫)。</p><blockquote><p><code>~*</code> 表示不区分大小写的正则匹配</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    if ($http_user_agent ~* &quot;python|curl|java|wget|httpclient|okhttp&quot;) &#123;</span><br><span class="line">        return 503;</span><br><span class="line">    &#125;</span><br><span class="line">    # 正常处理</span><br><span class="line">    # ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="防盗链"><a href="#防盗链" class="headerlink" title="防盗链"></a>防盗链</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location ~* \.(gif|jpg|png|swf|flv)$ &#123;</span><br><span class="line">   root html</span><br><span class="line">   valid_referers none blocked *.nginxcn.com;</span><br><span class="line">   if ($invalid_referer) &#123;</span><br><span class="line">     rewrite ^/ www.nginx.cn</span><br><span class="line">     #return 404;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="虚拟目录配置"><a href="#虚拟目录配置" class="headerlink" title="虚拟目录配置"></a>虚拟目录配置</h2><p>alias指定的目录是准确的，root是指定目录的上级目录，并且该上级目录要含有location指定名称的同名目录。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location /img/ &#123;</span><br><span class="line">    alias /var/www/image/;</span><br><span class="line">&#125;</span><br><span class="line"># 访问/img/目录里面的文件时，ningx会自动去/var/www/image/目录找文件</span><br><span class="line">location /img/ &#123;</span><br><span class="line">    root /var/www/image;</span><br><span class="line">&#125;</span><br><span class="line"># 访问/img/目录下的文件时，nginx会去/var/www/image/img/目录下找文件。]</span><br></pre></td></tr></table></figure><h2 id="防盗图配置"><a href="#防盗图配置" class="headerlink" title="防盗图配置"></a>防盗图配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location ~ \/public\/(css|js|img)\/.*\.(js|css|gif|jpg|jpeg|png|bmp|swf) &#123;</span><br><span class="line">    valid_referers none blocked *.jslite.io;</span><br><span class="line">    if ($invalid_referer) &#123;</span><br><span class="line">        rewrite ^/  http://wangchujiang.com/piratesp.png;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="屏蔽-git等文件"><a href="#屏蔽-git等文件" class="headerlink" title="屏蔽.git等文件"></a>屏蔽.git等文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location ~ (.git|.gitattributes|.gitignore|.svn) &#123;</span><br><span class="line">    deny all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="域名路径加不加需要都能正常访问"><a href="#域名路径加不加需要都能正常访问" class="headerlink" title="域名路径加不加需要都能正常访问"></a>域名路径加不加需要都能正常访问</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http://wangchujiang.com/api/index.php?a=1&amp;name=wcj</span><br><span class="line">                                  ^ 有后缀</span><br><span class="line"></span><br><span class="line">http://wangchujiang.com/api/index?a=1&amp;name=wcj</span><br><span class="line">                                 ^ 没有后缀</span><br></pre></td></tr></table></figure><p>nginx rewrite规则如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rewrite ^/(.*)/$ /index.php?/$1 permanent;</span><br><span class="line">if (!-d $request_filename)&#123;</span><br><span class="line">        set $rule_1 1$rule_1;</span><br><span class="line">&#125;</span><br><span class="line">if (!-f $request_filename)&#123;</span><br><span class="line">        set $rule_1 2$rule_1;</span><br><span class="line">&#125;</span><br><span class="line">if ($rule_1 = &quot;21&quot;)&#123;</span><br><span class="line">        rewrite ^/ /index.php last;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="错误问题"><a href="#错误问题" class="headerlink" title="错误问题"></a>错误问题</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The plain HTTP request was sent to HTTPS port</span><br></pre></td></tr></table></figure><p>解决办法，<code>fastcgi_param HTTPS $https if_not_empty</code> 添加这条规则，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl; # 注意这条规则</span><br><span class="line">    server_name  my.domain.com;</span><br><span class="line">    </span><br><span class="line">    fastcgi_param HTTPS $https if_not_empty;</span><br><span class="line">    fastcgi_param HTTPS on;</span><br><span class="line"></span><br><span class="line">    ssl_certificate /etc/ssl/certs/your.pem;</span><br><span class="line">    ssl_certificate_key /etc/ssl/private/your.key;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        # Your config here...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;安装&quot;&gt;&lt;a href=&quot;#安装&quot; class=&quot;headerlink&quot; title=&quot;安装&quot;&gt;&lt;/a&gt;安装&lt;/h1&gt;&lt;h2 id=&quot;安装依赖&quot;&gt;&lt;a href=&quot;#安装依赖&quot; class=&quot;headerlink&quot; title=&quot;安装依赖&quot;&gt;&lt;/a&gt;安装依赖&lt;/h
      
    
    </summary>
    
      <category term="中间件" scheme="https://shenshengkun.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
  </entry>
  
  <entry>
    <title>区块链浏览器部署</title>
    <link href="https://shenshengkun.github.io/posts/984b410.html"/>
    <id>https://shenshengkun.github.io/posts/984b410.html</id>
    <published>2019-05-09T08:21:10.000Z</published>
    <updated>2019-05-30T02:29:19.213Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Hyperledger-Explorer"><a href="#Hyperledger-Explorer" class="headerlink" title="Hyperledger Explorer"></a>Hyperledger Explorer</h1><p>Hyperledger Explorer是一个简单，功能强大，易于使用，高度可维护的开源浏览器，用于查看底层区块链网络上的活动 。</p><h1 id="postgresql"><a href="#postgresql" class="headerlink" title="postgresql"></a>postgresql</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>创建用户</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd postgres</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">注意：更新yum源，163或者阿里的yum源都可以</span><br><span class="line"></span><br><span class="line">添加RPM</span><br><span class="line">    yum install https://download.postgresql.org/pub/repos/yum/9.5/redhat/rhel-7-x86_64/pgdg-centos95-9.5-3.noarch.rpm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">安装PostgreSQL 9.5</span><br><span class="line">    yum install postgresql95-server postgresql95-contrib</span><br><span class="line"></span><br><span class="line">初始化数据库</span><br><span class="line">    /usr/pgsql-9.5/bin/postgresql95-setup initdb</span><br><span class="line">设置开机自启动</span><br><span class="line">    systemctl enable postgresql-9.5.service</span><br><span class="line"></span><br><span class="line">启动服务</span><br><span class="line">    systemctl start postgresql-9.5.service</span><br><span class="line">查看服务运行状态</span><br><span class="line">systemctl status postgresql-9.5.service</span><br></pre></td></tr></table></figure><p>postgreSQL 安装完成后，会建立一下‘postgres’用户，用于执行PostgreSQL，数据库中也会建立一个’postgres’用户，默认密码为自动生成，需要在系统中改一下。</p><h2 id="修改用户密码"><a href="#修改用户密码" class="headerlink" title="修改用户密码"></a>修改用户密码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">su - postgres  切换用户，执行后提示符会变为 &apos;-bash-4.2$&apos;</span><br><span class="line">psql -U postgres 登录数据库，执行后提示符变为 &apos;postgres=#&apos;</span><br><span class="line">ALTER USER postgres WITH PASSWORD &apos;gooagoo&apos;  设置postgres用户密码</span><br><span class="line">\q  退出数据库</span><br></pre></td></tr></table></figure><h2 id="开启远程访问"><a href="#开启远程访问" class="headerlink" title="开启远程访问"></a>开启远程访问</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /var/lib/pgsql/9.5/data/postgresql.conf</span><br><span class="line">修改#listen_addresses = &apos;localhost&apos;  为  listen_addresses=&apos;*&apos;</span><br><span class="line">当然，此处‘*’也可以改为任何你想开放的服务器IP</span><br></pre></td></tr></table></figure><h2 id="信任远程连接"><a href="#信任远程连接" class="headerlink" title="信任远程连接"></a>信任远程连接</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi /var/lib/pgsql/9.5/data/pg_hba.conf</span><br><span class="line">    修改如下内容，信任指定服务器连接</span><br><span class="line">    # IPv4 local connections:</span><br><span class="line">    host    all            all      127.0.0.1/32      trust</span><br><span class="line">    host    all            all      10.211.55.6/32（需要连接的服务器IP）  trust</span><br></pre></td></tr></table></figure><h3 id="重启"><a href="#重启" class="headerlink" title="重启"></a>重启</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart postgresql-9.5.service</span><br></pre></td></tr></table></figure><h1 id="blockchain-explorer"><a href="#blockchain-explorer" class="headerlink" title="blockchain-explorer"></a>blockchain-explorer</h1><h2 id="克隆存储库"><a href="#克隆存储库" class="headerlink" title="克隆存储库"></a>克隆存储库</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/hyperledger/blockchain-explorer.git</span><br><span class="line">cd blockchain-explorer</span><br><span class="line"></span><br><span class="line">也可以从我的百度链接上面下载：</span><br><span class="line">链接：https://pan.baidu.com/s/1VsxMlk5qo_5hUKsJ03DTlA </span><br><span class="line">提取码：9s5f </span><br><span class="line"></span><br><span class="line">cp -apr blockchain-explorer /var/lib/pgsql/</span><br></pre></td></tr></table></figure><h2 id="数据库设置"><a href="#数据库设置" class="headerlink" title="数据库设置"></a>数据库设置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br><span class="line">cd blockchain-explorer/app</span><br><span class="line"></span><br><span class="line">修改explorerconfig.json以更新postgresql属性</span><br><span class="line"></span><br><span class="line">postgreSQL主机，端口，数据库，用户名，密码详细信息。</span><br><span class="line">“postgreSQL”：&#123;</span><br><span class="line"></span><br><span class="line">  &quot;host&quot;: &quot;127.0.0.1&quot;,</span><br><span class="line">  &quot;port&quot;: &quot;5432&quot;,</span><br><span class="line">  &quot;database&quot;: &quot;fabricexplorer&quot;,</span><br><span class="line">  &quot;username&quot;: &quot;postgres&quot;,</span><br><span class="line">  &quot;passwd&quot;: &quot;gooagoo&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="运行create-database脚本"><a href="#运行create-database脚本" class="headerlink" title="运行create database脚本"></a>运行create database脚本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd blockchain-explorer/app/persistence/fabric/postgreSQL/db</span><br><span class="line">./createdb.sh</span><br></pre></td></tr></table></figure><h2 id="安装node"><a href="#安装node" class="headerlink" title="安装node"></a>安装node</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tar xvf  node-v11.10.0-linux-x64.tar</span><br><span class="line">cd node-v11.10.0-linux-x64</span><br><span class="line">./configure  &amp;&amp; make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">装cnpm淘宝源</span><br><span class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure><h2 id="npm测试"><a href="#npm测试" class="headerlink" title="npm测试"></a>npm测试</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cnpm install</span><br><span class="line">cd blockchain-explorer/app/test</span><br><span class="line">cnpm install</span><br><span class="line">cnpm run test</span><br><span class="line">cd client/</span><br><span class="line">cnpm install</span><br><span class="line">cnpm test -- -u --coverage</span><br><span class="line">cnpm run build</span><br><span class="line"></span><br><span class="line">由于config.json还没有写配置，所以node test会测试不成功</span><br></pre></td></tr></table></figure><h2 id="fabric的网络配置"><a href="#fabric的网络配置" class="headerlink" title="fabric的网络配置"></a>fabric的网络配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">vim blockchain-explorer/app/platform/fabric/config.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;network-configs&quot;: &#123;</span><br><span class="line">    &quot;network-1&quot;: &#123;</span><br><span class="line">      &quot;version&quot;: &quot;1.0&quot;,</span><br><span class="line">      &quot;clients&quot;: &#123;</span><br><span class="line">        &quot;client-1&quot;: &#123;</span><br><span class="line">          &quot;tlsEnable&quot;: false,</span><br><span class="line">          &quot;organization&quot;: &quot;1D8L291SQ3QRQ80AB2M1029FB60010HCMSP&quot;,</span><br><span class="line">          &quot;channel&quot;: &quot;vaccine&quot;,</span><br><span class="line">          &quot;credentialStore&quot;: &#123;</span><br><span class="line">            &quot;path&quot;: &quot;./tmp/credentialStore_Org1/credential&quot;,</span><br><span class="line">            &quot;cryptoStore&quot;: &#123;</span><br><span class="line">              &quot;path&quot;: &quot;./tmp/credentialStore_Org1/crypto&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;channels&quot;: &#123;</span><br><span class="line">        &quot;vaccine&quot;: &#123;</span><br><span class="line">          &quot;peers&quot;: &#123;</span><br><span class="line">            &quot;peer0.syj.vaccine.com&quot;: &#123;&#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;connection&quot;: &#123;</span><br><span class="line">            &quot;timeout&quot;: &#123;</span><br><span class="line">              &quot;peer&quot;: &#123;</span><br><span class="line">                &quot;endorser&quot;: &quot;6000&quot;,</span><br><span class="line">                &quot;eventHub&quot;: &quot;6000&quot;,</span><br><span class="line">                &quot;eventReg&quot;: &quot;6000&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;organizations&quot;: &#123;</span><br><span class="line">        &quot;1D8L291SQ3QRQ80AB2M1029FB60010HCMSP&quot;: &#123;</span><br><span class="line">          &quot;mspid&quot;: &quot;1D8L291SQ3QRQ80AB2M1029FB60010HCMSP&quot;,</span><br><span class="line">          &quot;fullpath&quot;: false,</span><br><span class="line">          &quot;adminPrivateKey&quot;: &#123;</span><br><span class="line">            &quot;path&quot;: &quot;/data/fabric/fabric-ca-files/vaccine-org/syj.vaccine.com/admin/msp/keystore&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;signedCert&quot;: &#123;</span><br><span class="line">            &quot;path&quot;: &quot;/data/fabric/fabric-ca-files/vaccine-org/syj.vaccine.com/admin/msp/signcerts&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;1D9K2HVDM752IN0AB2M105R9Q5001125MSP&quot;: &#123;</span><br><span class="line">          &quot;mspid&quot;: &quot;1D9K2HVDM752IN0AB2M105R9Q5001125MSP&quot;,</span><br><span class="line">          &quot;fullpath&quot;: false,</span><br><span class="line">          &quot;adminPrivateKey&quot;: &#123;</span><br><span class="line">            &quot;path&quot;: &quot;/data/fabric/fabric-ca-files/vaccine-org/czsrmyy.czsjkzx.hbsjkzx.vaccine.com/admin/msp/keystore&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;signedCert&quot;: &#123;</span><br><span class="line">            &quot;path&quot;: &quot;/data/fabric/fabric-ca-files/vaccine-org/czsrmyy.czsjkzx.hbsjkzx.vaccine.com/admin/msp/signcerts&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;OrdererMSP&quot;: &#123;</span><br><span class="line">          &quot;mspid&quot;: &quot;OrdererMSP&quot;,</span><br><span class="line">          &quot;adminPrivateKey&quot;: &#123;</span><br><span class="line">            &quot;path&quot;: &quot;/data/fabric/fabric-ca-files/vaccine-order/vaccine.syj.vaccine.com/admin/msp/keystore&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;peers&quot;: &#123;</span><br><span class="line">        &quot;peer0.syj.vaccine.com&quot;: &#123;</span><br><span class="line">          &quot;url&quot;: &quot;grpc://peer0.syj.vaccine.com:7051&quot;,</span><br><span class="line">          &quot;eventUrl&quot;: &quot;grpc://peer0.syj.vaccine.com:7053&quot;,</span><br><span class="line">          &quot;grpcOptions&quot;: &#123;</span><br><span class="line">            &quot;ssl-target-name-override&quot;: &quot;peer0.syj.vaccine.com&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;peer0.czsrmyy.czsjkzx.hbsjkzx.vaccine.com&quot;: &#123;</span><br><span class="line">          &quot;url&quot;: &quot;grpc://peer0.czsrmyy.czsjkzx.hbsjkzx.vaccine.com:7351&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;orderers&quot;: &#123;</span><br><span class="line">        &quot;orderer1.vaccine.syj.vaccine.com&quot;: &#123;</span><br><span class="line">          &quot;url&quot;: &quot;grpc://orderer1.vaccine.syj.vaccine.com:7050&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;network-2&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;configtxgenToolPath&quot;: &quot;/data/fabric/bin&quot;,</span><br><span class="line">  &quot;license&quot;: &quot;Apache-2.0&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>完成之后，在执行上面的，cnpm test</p><h2 id="汉化"><a href="#汉化" class="headerlink" title="汉化"></a>汉化</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /var/lib/pgsql/blockchain-explorer/client/src</span><br><span class="line">将components替换成我百度链接的包</span><br><span class="line"></span><br><span class="line">之后还需要重新，cnpm build一下</span><br></pre></td></tr></table></figure><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">由于区块链浏览器默认需要有锚节点，才能显示所有节点，所以在部署了第一个组织之后，需要在升级下锚节点</span><br><span class="line">./bin/configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org1MSPanchors.tx -channelID vaccine -asOrg Org1MSP</span><br><span class="line"></span><br><span class="line">docker exec -it cli-vaccine peer channel update -o orderer1.vaccine.syj.vaccine.com:7050 -c vaccine -f ./channel-artifacts/Org1MSPanchors.tx</span><br></pre></td></tr></table></figure><h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd blockchain-explorer/</span><br><span class="line">./start.sh</span><br></pre></td></tr></table></figure><h2 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip:8080</span><br></pre></td></tr></table></figure><p><img src="https://shenshengkun.github.io/images/fabric_exporler.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Hyperledger-Explorer&quot;&gt;&lt;a href=&quot;#Hyperledger-Explorer&quot; class=&quot;headerlink&quot; title=&quot;Hyperledger Explorer&quot;&gt;&lt;/a&gt;Hyperledger Explorer&lt;/h1&gt;&lt;
      
    
    </summary>
    
      <category term="区块链" scheme="https://shenshengkun.github.io/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/"/>
    
    
  </entry>
  
  <entry>
    <title>python监控es状态</title>
    <link href="https://shenshengkun.github.io/posts/71abe607.html"/>
    <id>https://shenshengkun.github.io/posts/71abe607.html</id>
    <published>2019-04-28T03:04:01.000Z</published>
    <updated>2019-05-30T02:29:19.196Z</updated>
    
    <content type="html"><![CDATA[<h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p>用python写一个监控es状态的脚本</p><h1 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h1><h2 id="监控es的机器"><a href="#监控es的机器" class="headerlink" title="监控es的机器"></a>监控es的机器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">配置文件</span><br><span class="line"></span><br><span class="line">[root@Ops-script monitor_elasticsearch]# cat escluster_ip.ini</span><br><span class="line">[mail]</span><br><span class="line">name = sy@xxx.com</span><br><span class="line">[tax_es]</span><br><span class="line">cluster_ip = 192.168.50.7:9200,192.168.50.8:9200,192.168.50.9:9200</span><br><span class="line">name_pass = none,none</span><br><span class="line">[analysis_es]</span><br><span class="line">cluster_ip = 192.168.50.24:9200,192.168.50.25:9200</span><br><span class="line">name_pass = none,none</span><br></pre></td></tr></table></figure><h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@Ops-script monitor_elasticsearch]# cat monitor_elastic_cluster.py</span><br><span class="line"></span><br><span class="line">import urllib,socket,time,json</span><br><span class="line">import logging,requests,configparser,os</span><br><span class="line"></span><br><span class="line"># 定义日志格式读取配置文件</span><br><span class="line">cur_path = os.path.dirname(os.path.realpath(__file__))</span><br><span class="line">logging.basicConfig(format=&apos;[ %(asctime)s ] -- %(message)s&apos;,</span><br><span class="line">                    datefmt=&apos;%a, %d %b %Y %H:%M:%S&apos;,</span><br><span class="line">                    filename=cur_path+&quot;/scripts.log&quot;,</span><br><span class="line">                    level=logging.INFO)</span><br><span class="line">config_path = os.path.join(cur_path,&quot;escluster_ip.ini&quot;)</span><br><span class="line">conf = configparser.ConfigParser()</span><br><span class="line">conf.read(config_path)</span><br><span class="line">esgroup = conf.sections()</span><br><span class="line"></span><br><span class="line">def GetClusterIp():</span><br><span class="line">    # 按集群名循环检查,集群名为配置文件中的标题</span><br><span class="line">    for group in esgroup:</span><br><span class="line">        # 获取到 mail 中的邮件地址不再继续循环</span><br><span class="line">        if group == &quot;mail&quot;:</span><br><span class="line">            mailname = conf.get(group,&quot;name&quot;)</span><br><span class="line">            continue</span><br><span class="line">        # 获取到一个集群 ip 后进行 get 请求</span><br><span class="line">        iplist = conf.get(group,&quot;cluster_ip&quot;).split(&quot;,&quot;)</span><br><span class="line">        for esip in iplist:</span><br><span class="line">            url = &quot;http://%s/_cat/health&quot;%esip</span><br><span class="line">            try:</span><br><span class="line">                # 超时时间为 3 秒, request 的请求值不是200的将全部置为400</span><br><span class="line">                # 如果是请求成功,则获取 status 的状态和 status_num 的百分比</span><br><span class="line">                response = requests.get(url,timeout=3)</span><br><span class="line">                request = response.status_code</span><br><span class="line">                status = response.text.split()[3]</span><br><span class="line">                status_num = response.text.split()[-1]</span><br><span class="line">            except:</span><br><span class="line">                request = 400</span><br><span class="line">            # 请求值为 200 后,检查 status 值非 green 状态发送报警邮件,并不在继续检查本集群内的剩余节点</span><br><span class="line">            if request == 200:</span><br><span class="line">                if status != &quot;green&quot;:</span><br><span class="line">                    mailtitle = &quot;elasticsearch集群 [ %s ], ip为:%s ,查状态: %s, 状态百分比: %s&quot;%(group,esip,status,status_num)</span><br><span class="line">                    mailtxt = &quot;elasticsearch集群 [ %s ]\n\nip为: [ %s ]\n\n检查状态为: %s\n\n状态百分比: %s&quot;%(group,esip,status,status_num)</span><br><span class="line">                    command = &quot;echo -e %s%s%s | mail -s %s%s%s %s&quot;%(&apos;&quot;&apos;,mailtxt,&apos;&quot;&apos;,&apos;&quot;&apos;,mailtitle,&apos;&quot;&apos;,mailname)</span><br><span class="line">                    logging.info(mailtitle)</span><br><span class="line">                    os.system(command)</span><br><span class="line">                    break</span><br><span class="line">            # 请求值不是 200 ,报警后继续检查集群内剩余 ip</span><br><span class="line">            else:</span><br><span class="line">                mailtitle = &quot;elasticsearch集群 [ %s ], ip为:%s, 请求超时,请检查端口&quot;%(group,esip)</span><br><span class="line">                mailtxt = &quot;elasticsearch集群 [ %s ]\n\nip: [ %s ]\n\n请求超时,请检查端口&quot;%(group,esip)</span><br><span class="line">                command = &quot;echo -e %s%s%s | mail -s %s%s%s %s&quot;%(&apos;&quot;&apos;,mailtxt,&apos;&quot;&apos;,&apos;&quot;&apos;,mailtitle,&apos;&quot;&apos;,mailname)</span><br><span class="line">                logging.info(mailtitle)</span><br><span class="line">                os.system(command)</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    GetClusterIp()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;需求&quot;&gt;&lt;a href=&quot;#需求&quot; class=&quot;headerlink&quot; title=&quot;需求&quot;&gt;&lt;/a&gt;需求&lt;/h1&gt;&lt;p&gt;用python写一个监控es状态的脚本&lt;/p&gt;
&lt;h1 id=&quot;实例&quot;&gt;&lt;a href=&quot;#实例&quot; class=&quot;headerlink&quot; t
      
    
    </summary>
    
      <category term="python" scheme="https://shenshengkun.github.io/categories/python/"/>
    
    
  </entry>
  
  <entry>
    <title>钉钉定时发送值班人员</title>
    <link href="https://shenshengkun.github.io/posts/59cdc228.html"/>
    <id>https://shenshengkun.github.io/posts/59cdc228.html</id>
    <published>2019-04-19T06:20:50.000Z</published>
    <updated>2019-05-30T02:29:19.192Z</updated>
    
    <content type="html"><![CDATA[<h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p>每天运维人员都需要去做些基础服务，就需要值班人员去轮班解决，现在需要写一个定时发送值班人员的脚本</p><h1 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h1><p>需要自己在钉钉群，申请个机器人，申请过程这里不赘述了，下面是脚本</p><h1 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">[root@Ops-script dingding]# mkdir /home/monitor/dingding</span><br><span class="line">[root@Ops-script dingding]# touch groupkey  helpkey</span><br><span class="line"></span><br><span class="line">[root@Ops-script dingding]# cat send_dingding.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line">groupfiles=&quot;/home/monitor/dingding/groupkey&quot;</span><br><span class="line">helpfiles=&quot;/home/monitor/dingding/helpkey&quot;</span><br><span class="line">Date=`date +%Y-%m-%d\ %H:%M:%S`</span><br><span class="line">url=&quot;https://oapi.dingtalk.com/robot/send?access_token=c2123f81820fccfadfc47bbd629d26e7613ae49f1a053edc6e81f5864c550e30&quot;</span><br><span class="line">group=(&quot;a:xx;&quot;</span><br><span class="line">       &quot;b:xx;&quot;</span><br><span class="line">       &quot;c:xx;&quot;)</span><br><span class="line">opshelp=(&quot;a:xx;&quot;</span><br><span class="line">         &quot;b:xx;&quot;</span><br><span class="line">         &quot;c:xx;&quot;)</span><br><span class="line">groupkey=`sed -n &quot;1p&quot; $groupfiles`</span><br><span class="line">helpkeys=`awk &apos;NR==1&#123;print $1&#125;&apos; $helpfiles`</span><br><span class="line">helpkey=`awk &apos;NR==1&#123;print $2&#125;&apos; $helpfiles`</span><br><span class="line"># 每日值班人</span><br><span class="line">for crew in $&#123;group[@]&#125;;do</span><br><span class="line">    if echo $crew | grep -q $groupkey ;then</span><br><span class="line">        values=`echo $crew | awk -F&apos;:&apos; &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">        onduty_mess=&quot;今日运维值班人: [ $values ]&quot;</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line"># 修改缓存文件内的运维值班人员 key , 使得下次人员自动更换</span><br><span class="line">if [ $groupkey == &quot;a&quot; ];then</span><br><span class="line">    echo &quot;b&quot; &gt; $groupfiles</span><br><span class="line">elif [ $groupkey == &quot;b&quot; ];then</span><br><span class="line">    echo &quot;c&quot; &gt; $groupfiles</span><br><span class="line">elif [ $groupkey == &quot;c&quot; ];then</span><br><span class="line">    echo &quot;a&quot; &gt; $groupfiles</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改缓存文件内的运维上线人员 key , 使得下次人员自动更换</span><br><span class="line">if [ $helpkeys == 7 ];then</span><br><span class="line">    helpsum=1</span><br><span class="line">else</span><br><span class="line">    helpsum=$(($helpkeys+1))</span><br><span class="line">fi</span><br><span class="line">if [ $helpsum == 1 ];then</span><br><span class="line">    if [ $helpkey == &quot;a&quot; ];then</span><br><span class="line">        echo &quot;$helpsum b&quot; &gt; $helpfiles</span><br><span class="line">    elif [ $helpkey == &quot;b&quot; ];then</span><br><span class="line">        echo &quot;$helpsum c&quot; &gt; $helpfiles</span><br><span class="line">    elif [ $helpkey == &quot;c&quot; ];then</span><br><span class="line">        echo &quot;$helpsum a&quot; &gt; $helpfiles</span><br><span class="line">    fi</span><br><span class="line">else</span><br><span class="line">    echo &quot;$helpsum $helpkey&quot; &gt; $helpfiles</span><br><span class="line">fi</span><br><span class="line"># 每周支持上线人</span><br><span class="line">for opsdit in $&#123;opshelp[@]&#125;;do</span><br><span class="line">    if [ $helpsum == 1 ];then</span><br><span class="line">        helpkey=`awk &apos;NR==1&#123;print $2&#125;&apos; $helpfiles`</span><br><span class="line">    fi</span><br><span class="line">    if echo $opsdit | grep -q $helpkey ;then</span><br><span class="line">        helpvalues=`echo $opsdit | awk -F&apos;:&apos; &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">        help_mess=&quot;本周版本上线运维支持: [ $helpvalues ]&quot;</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line">curl -XPOST -s -L -H &quot;Content-Type:application/json&quot; -H &quot;charset:utf-8&quot; $url -d &quot;</span><br><span class="line">        &#123;</span><br><span class="line">        \&quot;msgtype\&quot;: \&quot;text\&quot;, </span><br><span class="line">        \&quot;text\&quot;: &#123;</span><br><span class="line">                 \&quot;content\&quot;: \&quot;大家好~\n$onduty_mess\n$help_mess\&quot;</span><br><span class="line">                 &#125;</span><br><span class="line">    &#125;&quot;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;需求&quot;&gt;&lt;a href=&quot;#需求&quot; class=&quot;headerlink&quot; title=&quot;需求&quot;&gt;&lt;/a&gt;需求&lt;/h1&gt;&lt;p&gt;每天运维人员都需要去做些基础服务，就需要值班人员去轮班解决，现在需要写一个定时发送值班人员的脚本&lt;/p&gt;
&lt;h1 id=&quot;前提&quot;&gt;&lt;a hr
      
    
    </summary>
    
      <category term="linux" scheme="https://shenshengkun.github.io/categories/linux/"/>
    
    
  </entry>
  
  <entry>
    <title>docker存储驱动</title>
    <link href="https://shenshengkun.github.io/posts/12280181.html"/>
    <id>https://shenshengkun.github.io/posts/12280181.html</id>
    <published>2019-04-18T07:48:50.000Z</published>
    <updated>2019-05-30T02:29:19.231Z</updated>
    
    <content type="html"><![CDATA[<h1 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h1><p>Docker最开始采用AUFS作为文件系统，也得益于AUFS分层的概念，实现了多个Container可以共享同一个image。但由于AUFS未并入Linux内核，且只支持Ubuntu，考虑到兼容性问题，在Docker 0.7版本中引入了存储驱动。</p><p>目前，Docker支持的存储驱动：aufs，devicemapper，btrfs，zfs，overlay和overlay2。</p><p>就如Docker官网上说的，没有单一的驱动适合所有的应用场景，要根据不同的场景选择合适的存储驱动，才能有效的提高Docker的性能。如何选择适合的存储驱动，要先了解存储驱动原理才能更好的判断</p><h1 id="写时复制（CoW）"><a href="#写时复制（CoW）" class="headerlink" title="写时复制（CoW）"></a>写时复制（CoW）</h1><p>所有驱动都用到的技术——写时复制（CoW）。CoW就是copy-on-write，表示只在需要写时才去复制，这个是针对已有文件的修改场景。比如基于一个image启动多个Container，如果为每个Container都去分配一个image一样的文件系统，那么将会占用大量的磁盘空间。而CoW技术可以让所有的容器共享image的文件系统，所有数据都从image中读取，只有当要对文件进行写操作时，才从image里把要写的文件复制到自己的文件系统进行修改。所以无论有多少个容器共享同一个image，所做的写操作都是对从image中复制到自己的文件系统中的复本上进行，并不会修改image的源文件，且多个容器操作同一个文件，会在每个容器的文件系统里生成一个复本，每个容器修改的都是自己的复本，相互隔离，相互不影响。使用CoW可以有效的提高磁盘的利用率。</p><h1 id="用时分配（allocate-on-demand）"><a href="#用时分配（allocate-on-demand）" class="headerlink" title="用时分配（allocate-on-demand）"></a>用时分配（allocate-on-demand）</h1><p>而写时分配是用在原本没有这个文件的场景，只有在要新写入一个文件时才分配空间，这样可以提高存储资源的利用率。比如启动一个容器，并不会为这个容器预分配一些磁盘空间，而是当有新文件写入时，才按需分配新空间。</p><h1 id="AUFS"><a href="#AUFS" class="headerlink" title="AUFS"></a>AUFS</h1><p>AUFS（AnotherUnionFS）是一种Union FS，是文件级的存储驱动。AUFS能透明覆盖一或多个现有文件系统的层状文件系统，把多层合并成文件系统的单层表示。简单来说就是支持将不同目录挂载到同一个虚拟文件系统下的文件系统。这种文件系统可以一层一层地叠加修改文件。无论底下有多少层都是只读的，只有最上层的文件系统是可写的。当需要修改一个文件时，AUFS创建该文件的一个副本，使用CoW将文件从只读层复制到可写层进行修改，结果也保存在可写层。在Docker中，底下的只读层就是image，可写层就是Container。结构如下图所示：</p><p><img src="https://shenshengkun.github.io/images/存储驱动1.png" alt=""></p><h1 id="Overlay"><a href="#Overlay" class="headerlink" title="Overlay"></a>Overlay</h1><p>Overlay是Linux内核3.18后支持的，也是一种Union FS，和AUFS的多层不同的是Overlay只有两层：一个upper文件系统和一个lower文件系统，分别代表Docker的镜像层和容器层。当需要修改一个文件时，使用CoW将文件从只读的lower复制到可写的upper进行修改，结果也保存在upper层。在Docker中，底下的只读层就是image，可写层就是Container。结构如下图所示：</p><p><img src="https://shenshengkun.github.io/images/存储驱动2.png" alt=""></p><h1 id="Device-mapper"><a href="#Device-mapper" class="headerlink" title="Device mapper"></a>Device mapper</h1><p>Device mapper是Linux内核2.6.9后支持的，提供的一种从逻辑设备到物理设备的映射框架机制，在该机制下，用户可以很方便的根据自己的需要制定实现存储资源的管理策略。前面讲的AUFS和OverlayFS都是文件级存储，而Device mapper是块级存储，所有的操作都是直接对块进行操作，而不是文件。Device mapper驱动会先在块设备上创建一个资源池，然后在资源池上创建一个带有文件系统的基本设备，所有镜像都是这个基本设备的快照，而容器则是镜像的快照。所以在容器里看到文件系统是资源池上基本设备的文件系统的快照，并不有为容器分配空间。当要写入一个新文件时，在容器的镜像内为其分配新的块并写入数据，这个叫用时分配。当要修改已有文件时，再使用CoW为容器快照分配块空间，将要修改的数据复制到在容器快照中新的块里再进行修改。Device mapper 驱动默认会创建一个100G的文件包含镜像和容器。每一个容器被限制在10G大小的卷内，可以自己配置调整。结构如下图所示：</p><p><img src="https://shenshengkun.github.io/images/存储驱动3.png" alt=""></p><h1 id="Btrfs"><a href="#Btrfs" class="headerlink" title="Btrfs"></a>Btrfs</h1><p>Btrfs被称为下一代写时复制文件系统，并入Linux内核，也是文件级级存储，但可以像Device mapper一直接操作底层设备。Btrfs把文件系统的一部分配置为一个完整的子文件系统，称之为subvolume 。那么采用 subvolume，一个大的文件系统可以被划分为多个子文件系统，这些子文件系统共享底层的设备空间，在需要磁盘空间时便从底层设备中分配，类似应用程序调用 malloc()分配内存一样。为了灵活利用设备空间，Btrfs 将磁盘空间划分为多个chunk 。每个chunk可以使用不同的磁盘空间分配策略。比如某些chunk只存放metadata，某些chunk只存放数据。这种模型有很多优点，比如Btrfs支持动态添加设备。用户在系统中增加新的磁盘之后，可以使用Btrfs的命令将该设备添加到文件系统中。Btrfs把一个大的文件系统当成一个资源池，配置成多个完整的子文件系统，还可以往资源池里加新的子文件系统，而基础镜像则是子文件系统的快照，每个子镜像和容器都有自己的快照，这些快照则都是subvolume的快照。</p><p><img src="https://shenshengkun.github.io/images/存储驱动4.png" alt=""></p><p>当写入一个新文件时，为在容器的快照里为其分配一个新的数据块，文件写在这个空间里，这个叫用时分配。而当要修改已有文件时，使用CoW复制分配一个新的原始数据和快照，在这个新分配的空间变更数据，变结束再更新相关的数据结构指向新子文件系统和快照，原来的原始数据和快照没有指针指向，被覆盖。</p><h1 id="ZFS"><a href="#ZFS" class="headerlink" title="ZFS"></a>ZFS</h1><p>ZFS 文件系统是一个革命性的全新的文件系统，它从根本上改变了文件系统的管理方式，ZFS 完全抛弃了“卷管理”，不再创建虚拟的卷，而是把所有设备集中到一个存储池中来进行管理，用“存储池”的概念来管理物理存储空间。过去，文件系统都是构建在物理设备之上的。为了管理这些物理设备，并为数据提供冗余，“卷管理”的概念提供了一个单设备的映像。而ZFS创建在虚拟的，被称为“zpools”的存储池之上。每个存储池由若干虚拟设备（virtual devices，vdevs）组成。这些虚拟设备可以是原始磁盘，也可能是一个RAID1镜像设备，或是非标准RAID等级的多磁盘组。于是zpool上的文件系统可以使用这些虚拟设备的总存储容量。</p><p><img src="https://shenshengkun.github.io/images/存储驱动5.png" alt=""></p><p>下面看一下在Docker里ZFS的使用。首先从zpool里分配一个ZFS文件系统给镜像的基础层，而其他镜像层则是这个ZFS文件系统快照的克隆，快照是只读的，而克隆是可写的，当容器启动时则在镜像的最顶层生成一个可写层。如下图所示：</p><p><img src="https://shenshengkun.github.io/images/存储驱动6.png" alt=""></p><p>当要写一个新文件时，使用按需分配，一个新的数据快从zpool里生成，新的数据写入这个块，而这个新空间存于容器（ZFS的克隆）里。<br>当要修改一个已存在的文件时，使用写时复制，分配一个新空间并把原始数据复制到新空间完成修改。</p><h1 id="overlay2"><a href="#overlay2" class="headerlink" title="overlay2"></a>overlay2</h1><p>OverlayFS将Linux主机上的两个单独目录分层，并将它们显示为一个目录。这些目录称为层，统一过程称为联合安装。OverlayFS指向一个upper文件系统和一个lower文件系统，分别代表Docker的镜像层和容器层。用统一视图将整合的目录公开。</p><p>该overlay2驱动程序原生支持多达128个较低的OverlayFS层。此功能为与层相关的Docker命令（如docker build和docker commit）提供了更好的性能，并且大量减少了inode的消耗。</p><h1 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h1><table><thead><tr><th>存储驱动</th><th>简介</th><th>优点</th><th>缺点</th><th>存储级别</th><th>场景</th></tr></thead><tbody><tr><td>aufs</td><td>最古老的联合文件系统，没有被内核收录，只支持ubuntu</td><td>允许容器共享可执行文件和共享内存，历史悠久，使用广泛</td><td>会导致一些严重的内核崩溃，多层，在CoW时如果文件大且在低层会慢一些</td><td>文件级存储</td><td>大并发少IO</td></tr><tr><td>devicemapper</td><td>自动创建的稀疏文件的loop挂载后，自动创建块设备</td><td>精简配置和写时复制（CoW）快照技术，只复制修改的块</td><td>不支持共享存储，多个容器读同一个文件复制多份，容器启停可能会有磁盘溢出</td><td>块级存储</td><td>IO密集场景</td></tr><tr><td>btrfs</td><td>和devicemapper一样操作底层设备</td><td>非常快，支持动态添加设备</td><td>设备之间不共享可执行内存</td><td>文件级块存储</td><td>不适合高密度容器的paas平台</td></tr><tr><td>zfs</td><td></td><td>支持多个容器共享一个缓存块，适合大内存场景</td><td>CoW使碎片化问题更严重，文件在磁盘上物理地址不连续，顺序读性能差</td><td>所有设备集中到一个共享池里面进行管理</td><td>Paas平台和高密度场景</td></tr><tr><td>overlay</td><td>联合文件系统，内核版本3.18.0开始合并到内核中，只有两层</td><td>非常快速的联合文件系统。还支持页面缓存共享，这意味着访问同一文件的多个容器可以共享单个页面缓存条目（或条目），如aufs一样高效</td><td>会导致过多的inode消耗，不管修改内容大小都会复制整个文件，修改大文件消耗时间长</td><td>文件级存储</td><td>大并发少IO</td></tr><tr><td>overlay2</td><td></td><td>内核版本4.0有附加功能，避免过多的inode消耗</td><td></td><td>文件级存储</td><td>大并发少IO</td></tr></tbody></table><h2 id="AUFS-VS-Overlay"><a href="#AUFS-VS-Overlay" class="headerlink" title="AUFS VS Overlay"></a>AUFS VS Overlay</h2><p>AUFS和Overlay都是联合文件系统，但AUFS有多层，而Overlay只有两层，所以在做写时复制操作时，如果文件比较大且存在比较低的层，则AUSF可能会慢一些。而且Overlay并入了linux kernel mainline，AUFS没有，所以可能会比AUFS快。但Overlay还太年轻，要谨慎在生产使用。而AUFS做为docker的第一个存储驱动，已经有很长的历史，比较的稳定，且在大量的生产中实践过，有较强的社区支持。目前开源的DC/OS指定使用Overlay。</p><h2 id="Overlay-VS-Device-mapper"><a href="#Overlay-VS-Device-mapper" class="headerlink" title="Overlay VS Device mapper"></a>Overlay VS Device mapper</h2><p>Overlay是文件级存储，Device mapper是块级存储，当文件特别大而修改的内容很小，Overlay不管修改的内容大小都会复制整个文件，对大文件进行修改显示要比小文件要消耗更多的时间，而块级无论是大文件还是小文件都只复制需要修改的块，并不是整个文件，在这种场景下，显然device mapper要快一些。因为块级的是直接访问逻辑盘，适合IO密集的场景。而对于程序内部复杂，大并发但少IO的场景，Overlay的性能相对要强一些。</p><h2 id="Device-mapper-VS-Btrfs-Driver-VS-ZFS"><a href="#Device-mapper-VS-Btrfs-Driver-VS-ZFS" class="headerlink" title="Device mapper VS Btrfs Driver VS ZFS"></a>Device mapper VS Btrfs Driver VS ZFS</h2><p>Device mapper和Btrfs都是直接对块操作，都不支持共享存储，表示当有多个容器读同一个文件时，需要生活多个复本，所以这种存储驱动不适合在高密度容器的PaaS平台上使用。而且在很多容器启停的情况下可能会导致磁盘溢出，造成主机不能工作。Device mapper不建议在生产使用。Btrfs在docker build可以很高效。</p><p>ZFS最初是为拥有大量内存的Salaris服务器设计的，所在在使用时对内存会有影响，适合内存大的环境。ZFS的COW使碎片化问题更加严重，对于顺序写生成的大文件，如果以后随机的对其中的一部分进行了更改，那么这个文件在硬盘上的物理地址就变得不再连续，未来的顺序读会变得性能比较差。ZFS支持多个容器共享一个缓存块，适合PaaS和高密度的用户场景。</p><h1 id="IO性能对比"><a href="#IO性能对比" class="headerlink" title="IO性能对比"></a>IO性能对比</h1><ul><li>测试工具：IOzone（是一个文件系统的benchmark工具，可以测试不同的操作系统中文件系统的读写性能）</li><li>测试场景：从4K到1G文件的顺序和随机IO性能</li><li>测试方法：基于不同的存储驱动启动容器，在容器内安装IOzone，执行命令：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./iozone -a -n 4k -g 1g -i 0 -i 1 -i 2 -f /root/test.rar -Rb ./iozone.xls</span><br></pre></td></tr></table></figure><h2 id="测试项的定义和解释"><a href="#测试项的定义和解释" class="headerlink" title="测试项的定义和解释"></a>测试项的定义和解释</h2><ul><li>Write：测试向一个新文件写入的性能。</li><li>Re-write：测试向一个已存在的文件写入的性能。</li><li>Read：测试读一个已存在的文件的性能。</li><li>Re-Read：测试读一个最近读过的文件的性能。</li><li>Random Read：测试读一个文件中的随机偏移量的性能。</li><li>Random Write：测试写一个文件中的随机偏移量的性能。</li></ul><h2 id="通过以上的性能数据可以看到："><a href="#通过以上的性能数据可以看到：" class="headerlink" title="通过以上的性能数据可以看到："></a>通过以上的性能数据可以看到：</h2><p>AUFS在读的方面性能相比Overlay要差一些，但在写的方面性能比Overlay要好。<br>device mapper在512M以上文件的读写性能都非常的差，但在512M以下的文件读写性能都比较好。<br>btrfs在512M以上的文件读写性能都非常好，但在512M以下的文件读写性能相比其他的存储驱动都比较差。<br>ZFS整体的读写性能相比其他的存储驱动都要差一些。 简单的测试了一些数据，对测试出来的数据原理还需要进一步的解析。</p><h1 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h1><h2 id="devicemapper"><a href="#devicemapper" class="headerlink" title="devicemapper"></a>devicemapper</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;storage-driver&quot;: &quot;devicemapper&quot;,</span><br><span class="line">    &quot;storage-opts&quot;: [</span><br><span class="line">      &quot;dm.thinpooldev=/dev/mapper/thin-pool&quot;,</span><br><span class="line">      &quot;dm.use_deferred_deletion=true&quot;,</span><br><span class="line">      &quot;dm.use_deferred_removal=true&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="overlay2-1"><a href="#overlay2-1" class="headerlink" title="overlay2"></a>overlay2</h2><p>overlay2需要使用4.0以上版本的内核，如果使用的是RHEL或CentOS，需要3.10.0-514以上版本的内核</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 查看是否开启overlay</span><br><span class="line">lsmod |grep over</span><br><span class="line"></span><br><span class="line"># 开启overlay支持</span><br><span class="line">modprobe overlay</span><br></pre></td></tr></table></figure><p>配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">    &quot;storage-opts&quot;: [</span><br><span class="line">        &quot;overlay2.override_kernel_check=true&quot;</span><br><span class="line">        #&quot;overlay2.size=1G&quot;, # xfs文件系统</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;摘要&quot;&gt;&lt;a href=&quot;#摘要&quot; class=&quot;headerlink&quot; title=&quot;摘要&quot;&gt;&lt;/a&gt;摘要&lt;/h1&gt;&lt;p&gt;Docker最开始采用AUFS作为文件系统，也得益于AUFS分层的概念，实现了多个Container可以共享同一个image。但由于AUFS
      
    
    </summary>
    
      <category term="虚拟化" scheme="https://shenshengkun.github.io/categories/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
    
  </entry>
  
  <entry>
    <title>Kubernetes节点资源耗尽状态的处理</title>
    <link href="https://shenshengkun.github.io/posts/a54106c5.html"/>
    <id>https://shenshengkun.github.io/posts/a54106c5.html</id>
    <published>2019-04-18T06:20:01.000Z</published>
    <updated>2019-05-30T02:29:19.200Z</updated>
    
    <content type="html"><![CDATA[<p>最近发现测试环境的k8s集群，总有node利用不上，pod漂移过去之后，启动不了，故仔细排查了一下缘由！</p><h1 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master35 scripts]# ./list_pod.sh | grep imis</span><br><span class="line">imis-866d46c464-nvz4b                       0/1       ContainerCreating   0          3m        &lt;none&gt;          node149</span><br><span class="line"></span><br><span class="line">发现有的pod无法启动，刚开始describe查了下原因，看到，一直在拉镜像状态中，但是3分钟了，也不至于镜像拉不下来啊！</span><br><span class="line"></span><br><span class="line">查看了下node149的状态，发现</span><br><span class="line">Warning: “EvictionThresholdMet Attempting to reclaim nodefs”</span><br><span class="line">发现大概应该是由于磁盘原因造成的，也可以看下kubelet日志，也会报这个类似的错误</span><br></pre></td></tr></table></figure><h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node149 ~]# df -h</span><br><span class="line">Filesystem                Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/cl-root        36G  30G   6G  86% /</span><br><span class="line">devtmpfs                  7.8G     0  7.8G   0% /dev</span><br><span class="line">tmpfs                     7.8G     0  7.8G   0% /dev/shm</span><br><span class="line">tmpfs                     7.8G  9.3M  7.8G   1% /run</span><br><span class="line">tmpfs                     7.8G     0  7.8G   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda1                1014M  186M  829M  19% /boot</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">由于这是测试环境，所以docker的目录，默认在/var/lib/docker，没有单独挂载别的目录，这样的话，也没加定时任务清理磁盘，/ 磁盘就会越来越满，现在看是用了86%</span><br></pre></td></tr></table></figure><p>由于某些原因，我们的那个portal pod必须运行于该node上（通过<a href="https://kubernetes.io/docs/concepts/configuration/assign-pod-node/" target="_blank" rel="noopener">nodeSelector</a>选定node的方式）。在无法扩充根分区size的情况下，为了临时恢复pod运行，我们只能进一步“压榨”node了。于是我们的思路是：通过调整node的eviction threshold值来让node恢复healthy。 </p><h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>每个node上的kubelet都负责定期采集资源占用数据，并与预设的 threshold值进行比对，如果超过 threshold值，kubelet就会尝试杀掉一些Pod以回收相关资源，对Node进行保护。kubelet关注的资源指标threshold大约有如下几种： </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- memory.available</span><br><span class="line">- nodefs.available</span><br><span class="line">- nodefs.inodesFree</span><br><span class="line">- imagefs.available</span><br><span class="line">- imagefs.inodesFree</span><br></pre></td></tr></table></figure><p>每种threshold又分为eviction-soft和eviction-hard两组值。soft和hard的区别在于前者在到达threshold值时会给pod一段时间优雅退出，而后者则崇尚“暴力”，直接杀掉pod，没有任何优雅退出的机会。这里还要提一下nodefs和imagefs的区别： </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nodefs: 指node自身的存储，存储daemon的运行日志等，一般指root分区/；</span><br><span class="line">imagefs: 指docker daemon用于存储image和容器可写层(writable layer)的磁盘；</span><br></pre></td></tr></table></figure><h1 id="解决步骤"><a href="#解决步骤" class="headerlink" title="解决步骤"></a>解决步骤</h1><p>我们需要为kubelet重新设定nodefs.available的threshold值。怎么做呢？</p><p><a href="https://kubernetes.io/docs/admin/kubelet/" target="_blank" rel="noopener">kubelet</a>是运行于每个kubernetes node上的daemon，它在system boot时由<a href="http://en.wikipedia.org/wiki/Systemd" target="_blank" rel="noopener">systemd</a>拉起:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@master35 ~# ps -ef|grep kubelet</span><br><span class="line">root      5718  5695  0 16:38 pts/3    00:00:00 grep --color=auto kubelet</span><br><span class="line">root     13640     1  4 10:25 ?        00:17:25 /usr/bin/kubelet --kubeconfig=/etc/kubernetes/kubelet.conf --require-kubeconfig=true --pod-manifest-path=/etc/kubernetes/manifests --allow-privileged=true --network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin --cluster-dns=10.96.0.10 --cluster-domain=cluster.local --authorization-mode=Webhook --client-ca-file=/etc/kubernetes/pki/ca.crt --cadvisor-port=0</span><br></pre></td></tr></table></figure><p>查看一下kubelet service的状态： </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@master35 scripts]# systemctl status kubelet               </span><br><span class="line">● kubelet.service - kubelet: The Kubernetes Node Agent</span><br><span class="line">   Loaded: loaded (/etc/systemd/system/kubelet.service; enabled; vendor preset: disabled)</span><br><span class="line">  Drop-In: /etc/systemd/system/kubelet.service.d</span><br><span class="line">           └─10-kubeadm.conf</span><br><span class="line">   Active: active (running) since Thu 2018-07-19 21:04:35 CST; 8 months 29 days ago</span><br><span class="line">     Docs: http://kubernetes.io/docs/</span><br><span class="line"> Main PID: 1921 (kubelet)</span><br><span class="line">    Tasks: 19</span><br><span class="line">   Memory: 54.9M</span><br><span class="line">   CGroup: /system.slice/kubelet.service</span><br><span class="line">           └─1921 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --pod-manifest-path=...</span><br><span class="line"></span><br><span class="line">Apr 14 09:26:16 master35 kubelet[1921]: W0414 09:26:16.673359    1921 reflector.go:341] k8s.io/kubernetes/pkg/kubelet/config/apiserver.go:47: watch o...(56737582)</span><br><span class="line">Apr 15 06:36:48 master35 kubelet[1921]: W0415 06:36:48.938194    1921 reflector.go:341] k8s.io/kubernetes/pkg/kubelet/config/apiserver.go:47: watch o...(56940044)</span><br></pre></td></tr></table></figure><p>我们定义一个新的Environment var，比如就叫：KUBELET_EVICTION_POLICY_ARGS 在/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Environment=&quot;KUBELET_EVICTION_POLICY_ARGS=--eviction-hard=nodefs.available&lt;5%&quot;</span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_SYSTEM_PODS_ARGS $KUBELET_NETWORK_ARGS $KUBELET_DNS_ARGS $KUBELET_AUTHZ_ARGS $KUBELET_CADVISOR_ARGS $KUBELET_EXTRA_ARGS $KUBELET_EVICTION_POLICY_ARGS</span><br></pre></td></tr></table></figure><p>这样控制，node的磁盘策略为&lt;5%的硬盘就可以用，不像之前默认的15%就用不了了！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;最近发现测试环境的k8s集群，总有node利用不上，pod漂移过去之后，启动不了，故仔细排查了一下缘由！&lt;/p&gt;
&lt;h1 id=&quot;问题现象&quot;&gt;&lt;a href=&quot;#问题现象&quot; class=&quot;headerlink&quot; title=&quot;问题现象&quot;&gt;&lt;/a&gt;问题现象&lt;/h1&gt;&lt;figu
      
    
    </summary>
    
      <category term="k8s" scheme="https://shenshengkun.github.io/categories/k8s/"/>
    
    
  </entry>
  
  <entry>
    <title>wordpress快速安装</title>
    <link href="https://shenshengkun.github.io/posts/5842d4c0.html"/>
    <id>https://shenshengkun.github.io/posts/5842d4c0.html</id>
    <published>2019-04-16T08:18:50.000Z</published>
    <updated>2019-05-30T02:29:19.207Z</updated>
    
    <content type="html"><![CDATA[<h1 id="yum安装lnmp环境"><a href="#yum安装lnmp环境" class="headerlink" title="yum安装lnmp环境"></a>yum安装lnmp环境</h1><h2 id="安装前准备"><a href="#安装前准备" class="headerlink" title="安装前准备"></a>安装前准备</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 配置阿里云 yum 仓库</span><br><span class="line">$ wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line">$ wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">$ yum clean all</span><br><span class="line">$ yum makecache</span><br><span class="line"></span><br><span class="line"># 配置时间同步</span><br><span class="line">$ vim /etc/crontab</span><br><span class="line">00 00 * * * root /sbin/ntpdate ntp.aliyun.com &amp;&gt;/dev/null</span><br></pre></td></tr></table></figure><h2 id="配置-nginx-repo"><a href="#配置-nginx-repo" class="headerlink" title="配置 nginx repo"></a>配置 nginx repo</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/yum.repos.d/nginx.repo</span><br><span class="line">[nginx-stable]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line"></span><br><span class="line">[nginx-mainline]</span><br><span class="line">name=nginx mainline repo</span><br><span class="line">baseurl=http://nginx.org/packages/mainline/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br></pre></td></tr></table></figure><h2 id="yum安装lnmp"><a href="#yum安装lnmp" class="headerlink" title="yum安装lnmp"></a>yum安装lnmp</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum -y install nginx mariadb-server php php-bcmath php-fpm php-gd php-json php-mbstring php-mcrypt php-mysqlnd php-opcache php-pdo php-pdo_dblib php-pgsql php-recode php-snmp php-soap php-xml php-pecl-zip</span><br></pre></td></tr></table></figure><h2 id="启动php和mariadb"><a href="#启动php和mariadb" class="headerlink" title="启动php和mariadb"></a>启动php和mariadb</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 启动 PHP-FPM</span><br><span class="line">$ systemctl enable php-fpm</span><br><span class="line">$ systemctl start php-fpm</span><br><span class="line"># 启动 mariadb</span><br><span class="line">$ systemctl enable mariadb.service</span><br><span class="line">$ systemctl start mariadb.service</span><br></pre></td></tr></table></figure><h2 id="创建-wordpress-数据库"><a href="#创建-wordpress-数据库" class="headerlink" title="创建 wordpress 数据库"></a>创建 wordpress 数据库</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 连接数据库，默认密码为空</span><br><span class="line">mysql -uroot -p</span><br><span class="line"># 创建wordpress数据库名为 wp</span><br><span class="line">create database wp;</span><br><span class="line"># 创建数据库用户，用户名: blog 密码：123456</span><br><span class="line">grant all privileges on wp.* to &apos;blog&apos;@&apos;127.0.0.1&apos; identified by &apos;123456&apos;;</span><br><span class="line"># 刷新授权</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure><h2 id="配置nginx虚拟主机"><a href="#配置nginx虚拟主机" class="headerlink" title="配置nginx虚拟主机"></a>配置nginx虚拟主机</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/nginx/conf.d/blog.conf</span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name 10.100.4.169;</span><br><span class="line">  index index.html index.php;</span><br><span class="line">  # 访问日志目录</span><br><span class="line">  access_log /var/log/nginx/blog_access.log main;</span><br><span class="line">  # 网站根目录</span><br><span class="line">  root /data/www;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    root /data/www;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location ~ \.php$ &#123;</span><br><span class="line">    fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">    fastcgi_index  index.php;</span><br><span class="line">    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class="line">    include        fastcgi_params;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="配置wordpress"><a href="#配置wordpress" class="headerlink" title="配置wordpress"></a>配置wordpress</h1><h2 id="下载最新版wordpress"><a href="#下载最新版wordpress" class="headerlink" title="下载最新版wordpress"></a>下载最新版wordpress</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://cn.wordpress.org/latest-zh_CN.tar.gz</span><br></pre></td></tr></table></figure><h2 id="配置wordpress连接数据库"><a href="#配置wordpress连接数据库" class="headerlink" title="配置wordpress连接数据库"></a>配置wordpress连接数据库</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ tar xf latest-zh_CN.tar.gz</span><br><span class="line">$ mv wordpress/ /data/www</span><br><span class="line">$ cd /data/www/</span><br><span class="line">$ cp wp-config-sample.php wp-config.php</span><br><span class="line">$ vim wp-config.php</span><br><span class="line">// ** MySQL 设置 - 具体信息来自您正在使用的主机 ** //</span><br><span class="line">/** WordPress数据库的名称 */</span><br><span class="line">define(&apos;DB_NAME&apos;, &apos;wp&apos;);</span><br><span class="line"></span><br><span class="line">/** MySQL数据库用户名 */</span><br><span class="line">define(&apos;DB_USER&apos;, &apos;blog&apos;);</span><br><span class="line"></span><br><span class="line">/** MySQL数据库密码 */</span><br><span class="line">define(&apos;DB_PASSWORD&apos;, &apos;123456&apos;);</span><br><span class="line"></span><br><span class="line">/** MySQL主机 */</span><br><span class="line">define(&apos;DB_HOST&apos;, &apos;127.0.0.1&apos;);</span><br><span class="line"></span><br><span class="line">/** 创建数据表时默认的文字编码 */</span><br><span class="line">define(&apos;DB_CHARSET&apos;, &apos;utf8&apos;);</span><br><span class="line"></span><br><span class="line">/** 数据库整理类型。如不确定请勿更改 */</span><br><span class="line">define(&apos;DB_COLLATE&apos;, &apos;&apos;);</span><br></pre></td></tr></table></figure><h2 id="启动-nginx"><a href="#启动-nginx" class="headerlink" title="启动 nginx"></a>启动 nginx</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl enable nginx</span><br><span class="line">$ systemctl start nginx</span><br><span class="line">$ ps -ef|grep nginx</span><br></pre></td></tr></table></figure><h2 id="访问wordpress"><a href="#访问wordpress" class="headerlink" title="访问wordpress"></a>访问wordpress</h2><p>nginx 启动后我们就可以在浏览器通过 IP 地址访问 WordPress 了，首先会让我们给博客起个名字，名设置管理员的账号密码，点击安装 WordPress 就完成了。 </p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;yum安装lnmp环境&quot;&gt;&lt;a href=&quot;#yum安装lnmp环境&quot; class=&quot;headerlink&quot; title=&quot;yum安装lnmp环境&quot;&gt;&lt;/a&gt;yum安装lnmp环境&lt;/h1&gt;&lt;h2 id=&quot;安装前准备&quot;&gt;&lt;a href=&quot;#安装前准备&quot; class
      
    
    </summary>
    
      <category term="中间件" scheme="https://shenshengkun.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
  </entry>
  
  <entry>
    <title>多级缓存</title>
    <link href="https://shenshengkun.github.io/posts/9c74e32c.html"/>
    <id>https://shenshengkun.github.io/posts/9c74e32c.html</id>
    <published>2019-04-15T05:59:50.000Z</published>
    <updated>2019-05-30T02:29:19.221Z</updated>
    
    <content type="html"><![CDATA[<h1 id="每一级缓存的意义"><a href="#每一级缓存的意义" class="headerlink" title="每一级缓存的意义"></a>每一级缓存的意义</h1><p><strong>时效性高的数据：采取DB和redis缓存双写方案</strong></p><p><strong>时效性不高的数据：采取nginx本地缓存+redis分布式缓存+tomcat堆缓存的多级缓存架构</strong></p><p>a: nginx本地缓存，抗的是热数据的高并发访问。利用nginx本地缓存，将热数据锁定在nginx的本地缓存内，那么对这些热数据的大量访问，就直接走nginx就可以，不需要走后续的各种网络开销了。</p><p>b: redis分布式大规模缓存，抗的是很高的离散访问，支撑海量的数据，高并发的访问，高可用的服务。最完整的数据和缓存。</p><p>c:  tomcat jvm堆内存缓存，主要是抗redis大规模灾难的，如果redis出现了大规模的宕机，导致nginx大量流量直接涌入数据生产服务，那么最后的tomcat堆内存缓存至少可以再抗一下，不至于让数据库直接裸奔， 同时tomcat jvm堆内存缓存，也可以抗住redis没有cache住的最后那少量的部分缓存。</p><p><img src="https://shenshengkun.github.io/images/duojihuancun1.png" alt=""></p><h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><h2 id="Redis-Cluster"><a href="#Redis-Cluster" class="headerlink" title="Redis Cluster"></a>Redis Cluster</h2><p>通过master的水平扩容，来横向扩展读写吞吐量，还有支撑更多的海量数据</p><p>redis cluster 高可用性：redis cluster 提供主备切换。slave做master的热备，一旦master故障。slave提升为master，对外提供服务，保证集群的高可用性。并且，当master恢复后，会作为 slave加入到集群中。</p><h2 id="redis-cluster水平扩容"><a href="#redis-cluster水平扩容" class="headerlink" title="redis cluster水平扩容"></a>redis cluster水平扩容</h2><p>master的水平扩容，来横向扩展读写吞吐量，还有支撑更多的海量数据</p><h2 id="slave-自动迁移"><a href="#slave-自动迁移" class="headerlink" title="slave 自动迁移"></a>slave 自动迁移</h2><p>为redis cluster 添加冗余slave</p><h2 id="redis性能（需根据机器配置测试）"><a href="#redis性能（需根据机器配置测试）" class="headerlink" title="redis性能（需根据机器配置测试）"></a>redis性能（需根据机器配置测试）</h2><p>  redis单机，读吞吐是5w/s，写吞吐2w/s</p><p>  扩展redis更多master，那么如果有5台master，不就读吞吐可以达到总量25w/s QPS，写可以达到10w/s QPS</p><p>  redis单机，内存，6G-8G，内存不易过大fork类操作的时候很耗时，会导致请求延时的问题。扩容到5台master，能支撑的总的缓存数据量就是30G</p><h1 id="Cache-Aside模式"><a href="#Cache-Aside模式" class="headerlink" title="Cache Aside模式"></a>Cache Aside模式</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">（1）读的时候，先读缓存，缓存没有的话，那么就读数据库，然后取出数据后放入缓存，同时返回响应</span><br><span class="line">（2）更新的时候，先删除缓存，然后再更新数据库</span><br></pre></td></tr></table></figure><h1 id="DB和缓存双写不一致问题以及解决方案"><a href="#DB和缓存双写不一致问题以及解决方案" class="headerlink" title="DB和缓存双写不一致问题以及解决方案"></a>DB和缓存双写不一致问题以及解决方案</h1><p> <strong>缓存不一致场景一：</strong> </p><p><img src="https://shenshengkun.github.io/images/duojihuancun2.png" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  解决思路：</span><br><span class="line"></span><br><span class="line">先删除缓存，再修改数据库，如果删除缓存成功了，如果修改数据库失败了，那么数据库中是旧数据，缓存中是空的，那么数据不会不一致</span><br><span class="line">因为读的时候缓存没有，则读数据库中旧数据，然后更新到缓存中</span><br></pre></td></tr></table></figure><p> <strong>缓存不一致场景二：</strong> </p><p><img src="https://shenshengkun.github.io/images/duojihuancun3.png" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> 解决思路：</span><br><span class="line"> a：更新数据的时候，根据数据的唯一标识，将操作路由之后，发送到一个jvm内部的队列中</span><br><span class="line"> b:读取数据的时候，如果发现数据不在缓存中，那么将重新读取数据+更新缓存的操作，根据唯一标识路由之后，也发送同一个jvm内部的队列中</span><br><span class="line"> c:一个队列对应一个工作线程</span><br><span class="line"> d:每个工作线程串行拿到对应的操作，然后一条一条的执行</span><br><span class="line">这样的话，一个数据变更的操作，先执行，删除缓存，然后再去更新数据库，但是还没完成更新</span><br><span class="line">此时如果一个读请求过来，读到了空的缓存，那么可以先将缓存更新的请求发送到队列中，此时会在队列中积压，然后同步等待缓存更新完成</span><br><span class="line"> e: 多个更新缓存请求处理：这里有一个优化点，一个队列中，其实多个更新缓存请求串在一起是没意义的，因此可以做过滤，如果发现队列中已经有一个更新缓存的请求了，那么就不用再放个更新请求操作进去了，直接等待前面的更新操作请求完成即可</span><br><span class="line">待那个队列对应的工作线程完成了上一个操作的数据库的修改之后，才会去执行下一个操作，也就是缓存更新的操作，此时会从数据库中读取最新的值，然后写入缓存中</span><br><span class="line">如果请求还在等待时间范围内，不断轮询发现可以取到值了，那么就直接返回; 如果请求等待的时间超过一定时长，那么这一次直接从数据库中读取当前的旧值</span><br><span class="line"> f:多个读请求，进行读请求过滤：对一个商品的库存的数据库更新操作已经在内存队列中了</span><br><span class="line">然后对这个商品的库存的读取操作，要求读取数据库的库存数据，然后更新到缓存中，多个读</span><br><span class="line">这多个读，其实只要有一个读请求操作压到队列里就可以了</span><br><span class="line">其他的读操作，全部都wait那个读请求的操作，刷新缓存，就可以读到缓存中的最新数据了</span><br><span class="line">如果读请求发现redis缓存中没有数据，就会发送读请求给库存服务，但是此时缓存中为空，可能是因为写请求先删除了缓存，也可能是数据库里压根儿没这条数据</span><br><span class="line">如果是数据库中压根儿没这条数据的场景，那么就不应该将读请求操作给压入队列中，而是直接返回空就可以了</span><br></pre></td></tr></table></figure><h1 id="大value缓存的全量更新效率低下问题"><a href="#大value缓存的全量更新效率低下问题" class="headerlink" title="大value缓存的全量更新效率低下问题"></a>大value缓存的全量更新效率低下问题</h1><p>缓存数据的维度化拆分 </p><h1 id="缓存数据生产服务工作流程"><a href="#缓存数据生产服务工作流程" class="headerlink" title="缓存数据生产服务工作流程"></a>缓存数据生产服务工作流程</h1><p><img src="https://shenshengkun.github.io/images/duojihuancun4.png" alt=""></p><p>（1）监听多个kafka topic，每个kafka topic对应一个服务（简化一下，监听一个kafka topic）</p><p>（2）如果一个服务发生了数据变更，那么就发送一个消息到kafka topic中</p><p>（3）缓存数据生产服务监听到了消息以后，就发送请求到对应的服务中调用接口以及拉取数据，此时是从mysql中查询的</p><p>（4）缓存数据生产服务拉取到了数据之后，会将数据在本地缓存中写入一份，就是ehcache中</p><p>​          同时会将数据在redis中写入一份</p><h1 id="缓存并发重建冲突解决方案"><a href="#缓存并发重建冲突解决方案" class="headerlink" title="缓存并发重建冲突解决方案"></a>缓存并发重建冲突解决方案</h1><p> 重建缓存：比如数据在所有的缓存中都不存在了（LRU算法弄掉了），就需要重新查询数据写入缓存，重建缓存 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">缓存重建存在的问题一：</span><br><span class="line">缓存数据生产服务在多个机器节点上部署了多个实例</span><br><span class="line"></span><br><span class="line">        若没有缓存数据。12:00的时候发来一个读请求  12:01发来一个读请求（此时12:00的读请求由于网络延迟还未执行完）。12:01请求比12:00的请求执行速度快。更新了生产服务的数据并将数据写入缓存。写完后。12:00的请求将数据写入了缓存。那么此时生产服务的最新数据是12：01的，但是缓存中是服务数据是12:00的。数据不一致。</span><br><span class="line"></span><br><span class="line">解决思路：对请求的数据ID 进行hash，让对同一个数据的请求落在同一个服务实例上</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">缓存重建存在的问题二：</span><br><span class="line"></span><br><span class="line">生产服务发送的变更消息到kafka。由于问题一解决方案中的hash算法与kafka分区策略不一致。数据变更的消息所到的缓存服务实例，跟请求分发到的那个缓存服务实例也许就不在一台机器上了</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">（1）变更缓存重建以及空缓存请求重建，更新redis之前，都需要先获取对应商品id的分布式锁</span><br><span class="line">（2）拿到分布式锁之后，需要根据时间版本去比较一下，如果自己的版本新于redis中的版本，那么就更新，否则就不更新</span><br><span class="line">（3）如果拿不到分布式锁，那么就等待，不断轮询等待，直到自己获取到分布式的锁</span><br></pre></td></tr></table></figure><h1 id="缓存雪崩问题"><a href="#缓存雪崩问题" class="headerlink" title="缓存雪崩问题"></a>缓存雪崩问题</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">缓存雪崩产生场景：</span><br><span class="line"></span><br><span class="line">1、redis集群彻底崩溃</span><br><span class="line">2、缓存服务大量对redis的请求hang住，占用资源</span><br><span class="line">3、缓存服务大量的请求打到源头服务去查询mysql，直接打死mysql</span><br><span class="line">4、源头服务因为mysql被打死也崩溃，对源服务的请求也hang住，占用资源</span><br><span class="line">5、缓存服务大量的资源全部耗费在访问redis和源服务无果，最后自己被拖死，无法提供服务</span><br><span class="line">6、nginx无法访问缓存服务，redis和源服务，只能基于本地缓存提供服务，但是缓存过期后，没有数据提供</span><br><span class="line">解决思路</span><br><span class="line">       1、对redis访问做资源隔离</span><br><span class="line">       2、若redis集群崩溃，对redis进行熔断</span><br><span class="line">       3、对源服务的访问做限流</span><br><span class="line">       4、限流失败后采用stubbed fallback降级机制</span><br></pre></td></tr></table></figure><h1 id="缓存穿透问题"><a href="#缓存穿透问题" class="headerlink" title="缓存穿透问题"></a>缓存穿透问题</h1><p>每次如果从生产查询到的数据是空，就说明这个数据根本就不存在</p><p>那么如果这个数据不存在的话，我们不要不往redis和ehcache等缓存中写入数据，我们呢，给写入一个空的数据，比如说空的productInfo的json串</p><p>因为我们有一个异步监听数据变更的机制在里面，也就是说，如果数据变更的话，某个数据本来是没有的，可能会导致缓存穿透，所以我们给了个空数据</p><p>但是现在这个数据有了，我们接收到这个变更的消息过后，就可以将数据再次从生产服务中查询出来</p><p>然后设置到各级缓存中去了</p><h1 id="缓存失效问题"><a href="#缓存失效问题" class="headerlink" title="缓存失效问题"></a>缓存失效问题</h1><p>设置随机的缓存失效时间 </p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;每一级缓存的意义&quot;&gt;&lt;a href=&quot;#每一级缓存的意义&quot; class=&quot;headerlink&quot; title=&quot;每一级缓存的意义&quot;&gt;&lt;/a&gt;每一级缓存的意义&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;时效性高的数据：采取DB和redis缓存双写方案&lt;/strong&gt;&lt;/p&gt;

      
    
    </summary>
    
      <category term="中间件" scheme="https://shenshengkun.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
  </entry>
  
  <entry>
    <title>fabric分布式部署</title>
    <link href="https://shenshengkun.github.io/posts/e0275bab.html"/>
    <id>https://shenshengkun.github.io/posts/e0275bab.html</id>
    <published>2019-04-08T07:20:44.000Z</published>
    <updated>2019-05-30T02:29:19.230Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Kafka模式简介"><a href="#Kafka模式简介" class="headerlink" title="Kafka模式简介"></a>Kafka模式简介</h1><p>Hyperledger Fabric采用kafka方式实现排序（orderer）服务的集群，kafka模块被认为是半中心化结构。顺便提一下，去中心化的BFT（拜占庭容错）排序（orderer）服务集群方式目前还在开发，还没有规定发布时间，将在1.x周期内发布，可以关注跟踪FAB-33的更新。 </p><p> Kafka模式由排序（orderer）服务、kafka集群和zookeeper集群组成。每个排序(orderer)服务相互之间不通信，只与kafka集群通信，kafka集群与zookeeper相互连接。        Fabric网络中的各节点（Peer）收到客户端发送的交易请求时，把交易信息发送给与其连接的排序（orderer）服务，交由排序（orderer）服务集群进行排序处理。 </p><h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><table><thead><tr><th style="text-align:center">orderer1.example.com,kafka1,zookeeper1</th><th style="text-align:center">192.168.3.98</th></tr></thead><tbody><tr><td style="text-align:center"><strong>orderer1.example.com,kafka1,zookeeper1</strong></td><td style="text-align:center"><strong>192.168.3.97</strong></td></tr><tr><td style="text-align:center"><strong>orderer1.example.com,kafka1,zookeeper1</strong></td><td style="text-align:center"><strong>192.168.3.94</strong></td></tr><tr><td style="text-align:center"><strong>peer0.org1.example.com</strong></td><td style="text-align:center"><strong>192.168.10.174</strong></td></tr><tr><td style="text-align:center"><strong>peer1.org1.example.com</strong></td><td style="text-align:center"><strong>192.168.10.173</strong></td></tr><tr><td style="text-align:center"><strong>peer0.org2.example.com</strong></td><td style="text-align:center"><strong>192.168.3.93</strong></td></tr></tbody></table><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>在六台机器上安装依赖工具docker、go、fabric源码</p><p>docker就不多说了，17,03以上就可以，go可以yum安装</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">安装fabric源码:</span><br><span class="line">git clone https://github.com/hyperledger/fabric.git</span><br><span class="line">cd fabric</span><br><span class="line">git checkout v1.4.0</span><br><span class="line"></span><br><span class="line">拉镜像：</span><br><span class="line"></span><br><span class="line"># mkdir -p /etc/docker</span><br><span class="line"># tee /etc/docker/daemon.json &lt;&lt;-&apos;EOF&apos;</span><br><span class="line">&#123;</span><br><span class="line">&quot;registry-mirrors&quot;: [&quot;https://8w1wqmsz.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"># systemctl daemon-reload</span><br><span class="line"># systemctl restart docker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># docker pull hyperledger/fabric-peer:latest</span><br><span class="line"># docker pull hyperledger/fabric-orderer:latest</span><br><span class="line"># docker pull hyperledger/fabric-tools:latest</span><br><span class="line"># docker pull hyperledger/fabric-ccenv:latest</span><br><span class="line"># docker pull hyperledger/fabric-baseos:latest</span><br><span class="line"># docker pull hyperledger/fabric-kafka:latest</span><br><span class="line"># docker pull hyperledger/fabric-zookeeper:latest</span><br><span class="line"># docker pull hyperledger/fabric-couchdb:latest</span><br><span class="line"># docker pull hyperledger/fabric-ca:latest</span><br></pre></td></tr></table></figure><h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><h2 id="创建创世快"><a href="#创建创世快" class="headerlink" title="创建创世快"></a>创建创世快</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br></pre></td><td class="code"><pre><span class="line"># cd $GOPATH/src/github.com/hyperledger/fabric</span><br><span class="line"># mkdir kafkapeer</span><br><span class="line"># cd kafkapeer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># cat configtx.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Copyright IBM Corp. All Rights Reserved.</span><br><span class="line">#</span><br><span class="line"># SPDX-License-Identifier: Apache-2.0</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">################################################################################</span><br><span class="line">#</span><br><span class="line">#   Section: Organizations</span><br><span class="line">#</span><br><span class="line">#   - This section defines the different organizational identities which will</span><br><span class="line">#   be referenced later in the configuration.</span><br><span class="line">#</span><br><span class="line">################################################################################</span><br><span class="line">Organizations:</span><br><span class="line"></span><br><span class="line">    # SampleOrg defines an MSP using the sampleconfig.  It should never be used</span><br><span class="line">    # in production but may be used as a template for other definitions</span><br><span class="line">    - &amp;OrdererOrg</span><br><span class="line">        # DefaultOrg defines the organization which is used in the sampleconfig</span><br><span class="line">        # of the fabric.git development environment</span><br><span class="line">        Name: OrdererOrg</span><br><span class="line"></span><br><span class="line">        # ID to load the MSP definition as</span><br><span class="line">        ID: OrdererMSP</span><br><span class="line"></span><br><span class="line">        # MSPDir is the filesystem path which contains the MSP configuration</span><br><span class="line">        MSPDir: crypto-config/ordererOrganizations/example.com/msp</span><br><span class="line"></span><br><span class="line">        # Policies defines the set of policies at this level of the config tree</span><br><span class="line">        # For organization policies, their canonical path is usually</span><br><span class="line">        #   /Channel/&lt;Application|Orderer&gt;/&lt;OrgName&gt;/&lt;PolicyName&gt;</span><br><span class="line">        Policies:</span><br><span class="line">            Readers:</span><br><span class="line">                Type: Signature</span><br><span class="line">                Rule: &quot;OR(&apos;OrdererMSP.member&apos;)&quot;</span><br><span class="line">            Writers:</span><br><span class="line">                Type: Signature</span><br><span class="line">                Rule: &quot;OR(&apos;OrdererMSP.member&apos;)&quot;</span><br><span class="line">            Admins:</span><br><span class="line">                Type: Signature</span><br><span class="line">                Rule: &quot;OR(&apos;OrdererMSP.admin&apos;)&quot;</span><br><span class="line"></span><br><span class="line">    - &amp;Org1</span><br><span class="line">        # DefaultOrg defines the organization which is used in the sampleconfig</span><br><span class="line">        # of the fabric.git development environment</span><br><span class="line">        Name: Org1MSP</span><br><span class="line"></span><br><span class="line">        # ID to load the MSP definition as</span><br><span class="line">        ID: Org1MSP</span><br><span class="line"></span><br><span class="line">        MSPDir: crypto-config/peerOrganizations/org1.example.com/msp</span><br><span class="line"></span><br><span class="line">        # Policies defines the set of policies at this level of the config tree</span><br><span class="line">        # For organization policies, their canonical path is usually</span><br><span class="line">        #   /Channel/&lt;Application|Orderer&gt;/&lt;OrgName&gt;/&lt;PolicyName&gt;</span><br><span class="line">        Policies:</span><br><span class="line">            Readers:</span><br><span class="line">                Type: Signature</span><br><span class="line">                Rule: &quot;OR(&apos;Org1MSP.admin&apos;, &apos;Org1MSP.peer&apos;, &apos;Org1MSP.client&apos;)&quot;</span><br><span class="line">            Writers:</span><br><span class="line">                Type: Signature</span><br><span class="line">                Rule: &quot;OR(&apos;Org1MSP.admin&apos;, &apos;Org1MSP.client&apos;)&quot;</span><br><span class="line">            Admins:</span><br><span class="line">                Type: Signature</span><br><span class="line">                Rule: &quot;OR(&apos;Org1MSP.admin&apos;)&quot;</span><br><span class="line"></span><br><span class="line">        AnchorPeers:</span><br><span class="line">            # AnchorPeers defines the location of peers which can be used</span><br><span class="line">            # for cross org gossip communication.  Note, this value is only</span><br><span class="line">            # encoded in the genesis block in the Application section context</span><br><span class="line">            - Host: peer0.org1.example.com</span><br><span class="line">              Port: 7051</span><br><span class="line"></span><br><span class="line">    - &amp;Org2</span><br><span class="line">        # DefaultOrg defines the organization which is used in the sampleconfig</span><br><span class="line">        # of the fabric.git development environment</span><br><span class="line">        Name: Org2MSP</span><br><span class="line"></span><br><span class="line">        # ID to load the MSP definition as</span><br><span class="line">        ID: Org2MSP</span><br><span class="line"></span><br><span class="line">        MSPDir: crypto-config/peerOrganizations/org2.example.com/msp</span><br><span class="line"></span><br><span class="line">        # Policies defines the set of policies at this level of the config tree</span><br><span class="line">        # For organization policies, their canonical path is usually</span><br><span class="line">        #   /Channel/&lt;Application|Orderer&gt;/&lt;OrgName&gt;/&lt;PolicyName&gt;</span><br><span class="line">        Policies:</span><br><span class="line">            Readers:</span><br><span class="line">                Type: Signature</span><br><span class="line">                Rule: &quot;OR(&apos;Org2MSP.admin&apos;, &apos;Org2MSP.peer&apos;, &apos;Org2MSP.client&apos;)&quot;</span><br><span class="line">            Writers:</span><br><span class="line">                Type: Signature</span><br><span class="line">                Rule: &quot;OR(&apos;Org2MSP.admin&apos;, &apos;Org2MSP.client&apos;)&quot;</span><br><span class="line">            Admins:</span><br><span class="line">                Type: Signature</span><br><span class="line">                Rule: &quot;OR(&apos;Org2MSP.admin&apos;)&quot;</span><br><span class="line"></span><br><span class="line">        AnchorPeers:</span><br><span class="line">            # AnchorPeers defines the location of peers which can be used</span><br><span class="line">            # for cross org gossip communication.  Note, this value is only</span><br><span class="line">            # encoded in the genesis block in the Application section context</span><br><span class="line">            - Host: peer0.org2.example.com</span><br><span class="line">              Port: 7051</span><br><span class="line"></span><br><span class="line">################################################################################</span><br><span class="line">#</span><br><span class="line">#   SECTION: Capabilities</span><br><span class="line">#</span><br><span class="line">#   - This section defines the capabilities of fabric network. This is a new</span><br><span class="line">#   concept as of v1.1.0 and should not be utilized in mixed networks with</span><br><span class="line">#   v1.0.x peers and orderers.  Capabilities define features which must be</span><br><span class="line">#   present in a fabric binary for that binary to safely participate in the</span><br><span class="line">#   fabric network.  For instance, if a new MSP type is added, newer binaries</span><br><span class="line">#   might recognize and validate the signatures from this type, while older</span><br><span class="line">#   binaries without this support would be unable to validate those</span><br><span class="line">#   transactions.  This could lead to different versions of the fabric binaries</span><br><span class="line">#   having different world states.  Instead, defining a capability for a channel</span><br><span class="line">#   informs those binaries without this capability that they must cease</span><br><span class="line">#   processing transactions until they have been upgraded.  For v1.0.x if any</span><br><span class="line">#   capabilities are defined (including a map with all capabilities turned off)</span><br><span class="line">#   then the v1.0.x peer will deliberately crash.</span><br><span class="line">#</span><br><span class="line">################################################################################</span><br><span class="line">Capabilities:</span><br><span class="line">    # Channel capabilities apply to both the orderers and the peers and must be</span><br><span class="line">    # supported by both.  Set the value of the capability to true to require it.</span><br><span class="line">    Global: &amp;ChannelCapabilities</span><br><span class="line">        # V1.1 for Global is a catchall flag for behavior which has been</span><br><span class="line">        # determined to be desired for all orderers and peers running v1.0.x,</span><br><span class="line">        # but the modification of which would cause incompatibilities.  Users</span><br><span class="line">        # should leave this flag set to true.</span><br><span class="line">        V1_1: true</span><br><span class="line"></span><br><span class="line">    # Orderer capabilities apply only to the orderers, and may be safely</span><br><span class="line">    # manipulated without concern for upgrading peers.  Set the value of the</span><br><span class="line">    # capability to true to require it.</span><br><span class="line">    Orderer: &amp;OrdererCapabilities</span><br><span class="line">        # V1.1 for Order is a catchall flag for behavior which has been</span><br><span class="line">        # determined to be desired for all orderers running v1.0.x, but the</span><br><span class="line">        # modification of which  would cause incompatibilities.  Users should</span><br><span class="line">        # leave this flag set to true.</span><br><span class="line">        V1_1: true</span><br><span class="line"></span><br><span class="line">    # Application capabilities apply only to the peer network, and may be safely</span><br><span class="line">    # manipulated without concern for upgrading orderers.  Set the value of the</span><br><span class="line">    # capability to true to require it.</span><br><span class="line">    Application: &amp;ApplicationCapabilities</span><br><span class="line">        # V1.1 for Application is a catchall flag for behavior which has been</span><br><span class="line">        # determined to be desired for all peers running v1.0.x, but the</span><br><span class="line">        # modification of which would cause incompatibilities.  Users should</span><br><span class="line">        # leave this flag set to true.</span><br><span class="line">        V1_2: true</span><br><span class="line"></span><br><span class="line">################################################################################</span><br><span class="line">#</span><br><span class="line">#   SECTION: Application</span><br><span class="line">#</span><br><span class="line">#   - This section defines the values to encode into a config transaction or</span><br><span class="line">#   genesis block for application related parameters</span><br><span class="line">#</span><br><span class="line">################################################################################</span><br><span class="line">Application: &amp;ApplicationDefaults</span><br><span class="line"></span><br><span class="line">    # Organizations is the list of orgs which are defined as participants on</span><br><span class="line">    # the application side of the network</span><br><span class="line">    Organizations:</span><br><span class="line"></span><br><span class="line">    # Policies defines the set of policies at this level of the config tree</span><br><span class="line">    # For Application policies, their canonical path is</span><br><span class="line">    #   /Channel/Application/&lt;PolicyName&gt;</span><br><span class="line">    Policies:</span><br><span class="line">        Readers:</span><br><span class="line">            Type: ImplicitMeta</span><br><span class="line">            Rule: &quot;ANY Readers&quot;</span><br><span class="line">        Writers:</span><br><span class="line">            Type: ImplicitMeta</span><br><span class="line">            Rule: &quot;ANY Writers&quot;</span><br><span class="line">        Admins:</span><br><span class="line">            Type: ImplicitMeta</span><br><span class="line">            Rule: &quot;MAJORITY Admins&quot;</span><br><span class="line"></span><br><span class="line">    # Capabilities describes the application level capabilities, see the</span><br><span class="line">    # dedicated Capabilities section elsewhere in this file for a full</span><br><span class="line">    # description</span><br><span class="line">    Capabilities:</span><br><span class="line">        &lt;&lt;: *ApplicationCapabilities</span><br><span class="line"></span><br><span class="line">################################################################################</span><br><span class="line">#</span><br><span class="line">#   SECTION: Orderer</span><br><span class="line">#</span><br><span class="line">#   - This section defines the values to encode into a config transaction or</span><br><span class="line">#   genesis block for orderer related parameters</span><br><span class="line">#</span><br><span class="line">################################################################################</span><br><span class="line">Orderer: &amp;OrdererDefaults</span><br><span class="line"></span><br><span class="line">    # Orderer Type: The orderer implementation to start</span><br><span class="line">    # Available types are &quot;solo&quot; and &quot;kafka&quot;</span><br><span class="line">    OrdererType: kafka</span><br><span class="line"></span><br><span class="line">    Addresses:</span><br><span class="line">        - orderer0.example.com:7050</span><br><span class="line">        - orderer1.example.com:7050</span><br><span class="line">        - orderer2.example.com:7050</span><br><span class="line"></span><br><span class="line">    # Batch Timeout: The amount of time to wait before creating a batch</span><br><span class="line">    BatchTimeout: 2s</span><br><span class="line"></span><br><span class="line">    # Batch Size: Controls the number of messages batched into a block</span><br><span class="line">    BatchSize:</span><br><span class="line"></span><br><span class="line">        # Max Message Count: The maximum number of messages to permit in a batch</span><br><span class="line">        MaxMessageCount: 10</span><br><span class="line"></span><br><span class="line">        # Absolute Max Bytes: The absolute maximum number of bytes allowed for</span><br><span class="line">        # the serialized messages in a batch.</span><br><span class="line">        AbsoluteMaxBytes: 98 MB</span><br><span class="line"></span><br><span class="line">        # Preferred Max Bytes: The preferred maximum number of bytes allowed for</span><br><span class="line">        # the serialized messages in a batch. A message larger than the preferred</span><br><span class="line">        # max bytes will result in a batch larger than preferred max bytes.</span><br><span class="line">        PreferredMaxBytes: 512 KB</span><br><span class="line"></span><br><span class="line">    Kafka:</span><br><span class="line">        # Brokers: A list of Kafka brokers to which the orderer connects. Edit</span><br><span class="line">        # this list to identify the brokers of the ordering service.</span><br><span class="line">        # NOTE: Use IP:port notation.</span><br><span class="line">        Brokers:</span><br><span class="line">            - kafka0:9092</span><br><span class="line">            - kafka1:9092</span><br><span class="line">            - kafka2:9092</span><br><span class="line">            - kafka3:9092</span><br><span class="line"></span><br><span class="line">    # Organizations is the list of orgs which are defined as participants on</span><br><span class="line">    # the orderer side of the network</span><br><span class="line">    Organizations:</span><br><span class="line"></span><br><span class="line">    # Policies defines the set of policies at this level of the config tree</span><br><span class="line">    # For Orderer policies, their canonical path is</span><br><span class="line">    #   /Channel/Orderer/&lt;PolicyName&gt;</span><br><span class="line">    Policies:</span><br><span class="line">        Readers:</span><br><span class="line">            Type: ImplicitMeta</span><br><span class="line">            Rule: &quot;ANY Readers&quot;</span><br><span class="line">        Writers:</span><br><span class="line">            Type: ImplicitMeta</span><br><span class="line">            Rule: &quot;ANY Writers&quot;</span><br><span class="line">        Admins:</span><br><span class="line">            Type: ImplicitMeta</span><br><span class="line">            Rule: &quot;MAJORITY Admins&quot;</span><br><span class="line">        # BlockValidation specifies what signatures must be included in the block</span><br><span class="line">        # from the orderer for the peer to validate it.</span><br><span class="line">        BlockValidation:</span><br><span class="line">            Type: ImplicitMeta</span><br><span class="line">            Rule: &quot;ANY Writers&quot;</span><br><span class="line"></span><br><span class="line">    # Capabilities describes the orderer level capabilities, see the</span><br><span class="line">    # dedicated Capabilities section elsewhere in this file for a full</span><br><span class="line">    # description</span><br><span class="line">    Capabilities:</span><br><span class="line">        &lt;&lt;: *OrdererCapabilities</span><br><span class="line"></span><br><span class="line">################################################################################</span><br><span class="line">#</span><br><span class="line">#   CHANNEL</span><br><span class="line">#</span><br><span class="line">#   This section defines the values to encode into a config transaction or</span><br><span class="line">#   genesis block for channel related parameters.</span><br><span class="line">#</span><br><span class="line">################################################################################</span><br><span class="line">Channel: &amp;ChannelDefaults</span><br><span class="line">    # Policies defines the set of policies at this level of the config tree</span><br><span class="line">    # For Channel policies, their canonical path is</span><br><span class="line">    #   /Channel/&lt;PolicyName&gt;</span><br><span class="line">    Policies:</span><br><span class="line">        # Who may invoke the &apos;Deliver&apos; API</span><br><span class="line">        Readers:</span><br><span class="line">            Type: ImplicitMeta</span><br><span class="line">            Rule: &quot;ANY Readers&quot;</span><br><span class="line">        # Who may invoke the &apos;Broadcast&apos; API</span><br><span class="line">        Writers:</span><br><span class="line">            Type: ImplicitMeta</span><br><span class="line">            Rule: &quot;ANY Writers&quot;</span><br><span class="line">        # By default, who may modify elements at this config level</span><br><span class="line">        Admins:</span><br><span class="line">            Type: ImplicitMeta</span><br><span class="line">            Rule: &quot;MAJORITY Admins&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # Capabilities describes the channel level capabilities, see the</span><br><span class="line">    # dedicated Capabilities section elsewhere in this file for a full</span><br><span class="line">    # description</span><br><span class="line">    Capabilities:</span><br><span class="line">        &lt;&lt;: *ChannelCapabilities</span><br><span class="line"></span><br><span class="line">################################################################################</span><br><span class="line">#</span><br><span class="line">#   Profile</span><br><span class="line">#</span><br><span class="line">#   - Different configuration profiles may be encoded here to be specified</span><br><span class="line">#   as parameters to the configtxgen tool</span><br><span class="line">#</span><br><span class="line">################################################################################</span><br><span class="line">Profiles:</span><br><span class="line"></span><br><span class="line">    TwoOrgsOrdererGenesis:</span><br><span class="line">        &lt;&lt;: *ChannelDefaults</span><br><span class="line">        Orderer:</span><br><span class="line">            &lt;&lt;: *OrdererDefaults</span><br><span class="line">            Organizations:</span><br><span class="line">                - *OrdererOrg</span><br><span class="line">        Consortiums:</span><br><span class="line">            SampleConsortium:</span><br><span class="line">                Organizations:</span><br><span class="line">                    - *Org1</span><br><span class="line">                    - *Org2</span><br><span class="line"></span><br><span class="line">    TwoOrgsChannel:</span><br><span class="line">        Consortium: SampleConsortium</span><br><span class="line">        Application:</span><br><span class="line">            &lt;&lt;: *ApplicationDefaults</span><br><span class="line">            Organizations:</span><br><span class="line">                - *Org1</span><br><span class="line">                - *Org2</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bin目录从fabric源码里面拷过来，这样方便生成块</span><br><span class="line"># mkdir channel-artifacts</span><br><span class="line"># ./bin/configtxgen -profile TwoOrgsOrdererGenesis -outputBlock ./channel-artifacts/genesis.block</span><br><span class="line"># ./bin/configtxgen -profile TwoOrgsChannel -outputCreateChannelTx ./channel-artifacts/mychannel.tx -channelID mychannel</span><br></pre></td></tr></table></figure><p>完事之后，把kafka目录，拷到所有机器上</p><h2 id="部署kafka、zk"><a href="#部署kafka、zk" class="headerlink" title="部署kafka、zk"></a>部署kafka、zk</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">zk的yaml文件：</span><br><span class="line"># cat docker-compose-zookeeper.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Copyright IBM Corp. All Rights Reserved.</span><br><span class="line">#</span><br><span class="line"># SPDX-License-Identifier: Apache-2.0</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">version: &apos;2&apos;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  zookeeper0:</span><br><span class="line">    container_name: zookeeper0</span><br><span class="line">    hostname: zookeeper0</span><br><span class="line">    image: hyperledger/fabric-zookeeper</span><br><span class="line">    restart: always</span><br><span class="line">    environment:</span><br><span class="line">      - ZOO_MY_ID=1</span><br><span class="line">      - ZOO_SERVERS=server.1=zookeeper0:2888:3888 server.2=zookeeper1:2888:3888 server.3=zookeeper2:2888:3888</span><br><span class="line">    ports:</span><br><span class="line">      - 2181:2181</span><br><span class="line">      - 2888:2888</span><br><span class="line">      - 3888:3888</span><br><span class="line">    dns:</span><br><span class="line">      - &quot;192.168.3.94&quot;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">kafka的yaml文件：</span><br><span class="line"># cat docker-compose-kafka.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Copyright IBM Corp. All Rights Reserved.</span><br><span class="line">#</span><br><span class="line"># SPDX-License-Identifier: Apache-2.0</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">version: &apos;2&apos;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  kafka0:</span><br><span class="line">    container_name: kafka0</span><br><span class="line">    hostname: kafka0</span><br><span class="line">    image: hyperledger/fabric-kafka</span><br><span class="line">    restart: always</span><br><span class="line">    environment:</span><br><span class="line">      - KAFKA_MESSAGE_MAX_BYTES=103809024 # 99 * 1024 * 1024 B</span><br><span class="line">      - KAFKA_REPLICA_FETCH_MAX_BYTES=103809024 # 99 * 1024 * 1024 B</span><br><span class="line">      - KAFKA_UNCLEAN_LEADER_ELECTION_ENABLE=false</span><br><span class="line">    environment:</span><br><span class="line">      - KAFKA_BROKER_ID=1</span><br><span class="line">      - KAFKA_MIN_INSYNC_REPLICAS=2</span><br><span class="line">      - KAFKA_DEFAULT_REPLICATION_FACTOR=3</span><br><span class="line">      - KAFKA_ZOOKEEPER_CONNECT=zookeeper0:2181,zookeeper1:2181,zookeeper2:2181</span><br><span class="line">    ports:</span><br><span class="line">      - 9092:9092</span><br><span class="line">    dns:</span><br><span class="line">      - &quot;192.168.3.94&quot;</span><br></pre></td></tr></table></figure><h2 id="部署orderer"><a href="#部署orderer" class="headerlink" title="部署orderer"></a>部署orderer</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">因为咱们的fabric证书，没生成tls，所以下面的配置文件需要把tls去掉，zk，kafka都各自按照上述步骤配置在三台不同机器上，orderer也一样</span><br><span class="line"></span><br><span class="line">cat docker-compose-orderer.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Copyright IBM Corp. All Rights Reserved.</span><br><span class="line">#</span><br><span class="line"># SPDX-License-Identifier: Apache-2.0</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">version: &apos;2&apos;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  orderer0.example.com:</span><br><span class="line">    container_name: orderer0.example.com</span><br><span class="line">    image: hyperledger/fabric-orderer</span><br><span class="line">    environment:</span><br><span class="line">      - ORDERER_GENERAL_LOGLEVEL=debug</span><br><span class="line">      - ORDERER_GENERAL_LISTENADDRESS=0.0.0.0</span><br><span class="line">      - ORDERER_GENERAL_GENESISMETHOD=file</span><br><span class="line">      - ORDERER_GENERAL_GENESISFILE=/var/hyperledger/orderer/orderer.genesis.block</span><br><span class="line">      - ORDERER_GENERAL_LOCALMSPID=OrdererMSP</span><br><span class="line">      - ORDERER_GENERAL_LOCALMSPDIR=/var/hyperledger/orderer/msp</span><br><span class="line">      # enabled TLS</span><br><span class="line">      - ORDERER_GENERAL_TLS_ENABLED=true</span><br><span class="line">      - ORDERER_GENERAL_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key</span><br><span class="line">      - ORDERER_GENERAL_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt</span><br><span class="line">      - ORDERER_GENERAL_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]</span><br><span class="line">      - ORDERER_KAFKA_RETRY_LONGINTERVAL=10s </span><br><span class="line">      - ORDERER_KAFKA_RETRY_LONGTOTAL=100s</span><br><span class="line">      - ORDERER_KAFKA_RETRY_SHORTINTERVAL=1s</span><br><span class="line">      - ORDERER_KAFKA_RETRY_SHORTTOTAL=30s</span><br><span class="line">      - ORDERER_KAFKA_VERBOSE=true</span><br><span class="line">    working_dir: /opt/gopath/src/github.com/hyperledger/fabric</span><br><span class="line">    command: orderer</span><br><span class="line">    volumes:</span><br><span class="line">      - ./channel-artifacts/genesis.block:/var/hyperledger/orderer/orderer.genesis.block</span><br><span class="line">      - ./crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp:/var/hyperledger/orderer/msp</span><br><span class="line">      - ./crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/tls/:/var/hyperledger/orderer/tls</span><br><span class="line">    ports:</span><br><span class="line">      - 7050:7050</span><br><span class="line">    dns:</span><br><span class="line">     - &quot;192.168.3.94&quot;</span><br></pre></td></tr></table></figure><h2 id="部署peer"><a href="#部署peer" class="headerlink" title="部署peer"></a>部署peer</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"># cat docker-compose-peer.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># All elements in this file should depend on the docker-compose-base.yaml</span><br><span class="line"># Provided fabric peer node</span><br><span class="line"></span><br><span class="line">version: &apos;2&apos;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  peer1.org1.example.com:</span><br><span class="line">    container_name: peer1.org1.example.com</span><br><span class="line">    hostname: peer1.org1.example.com</span><br><span class="line">    image: hyperledger/fabric-peer</span><br><span class="line">    environment:</span><br><span class="line">       - CORE_PEER_ID=peer1.org1.example.com</span><br><span class="line">       - CORE_PEER_ADDRESS=peer1.org1.example.com:7051</span><br><span class="line">       - CORE_PEER_CHAINCODELISTENADDRESS=peer1.org1.example.com:7052</span><br><span class="line">       - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer1.org1.example.com:7051</span><br><span class="line">       - CORE_PEER_LOCALMSPID=Org1MSP</span><br><span class="line">       - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock</span><br><span class="line">       # the following setting starts chaincode containers on the same</span><br><span class="line">       # bridge network as the peers</span><br><span class="line">       # https://docs.docker.com/compose/networking/</span><br><span class="line">       #- CORE_LOGGING_LEVEL=ERROR</span><br><span class="line">       - CORE_LOGGING_LEVEL=DEBUG</span><br><span class="line">       - CORE_PEER_GOSSIP_USELEADERELECTION=true</span><br><span class="line">       - CORE_PEER_GOSSIP_ORGLEADER=false</span><br><span class="line">       - CORE_PEER_PROFILE_ENABLED=true</span><br><span class="line">       - CORE_PEER_TLS_ENABLED=true</span><br><span class="line">       - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt</span><br><span class="line">       - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key</span><br><span class="line">       - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt</span><br><span class="line">    working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer</span><br><span class="line">    command: peer node start</span><br><span class="line">    volumes:</span><br><span class="line">       - /var/run/:/host/var/run/</span><br><span class="line">       - ./crypto-config/peerOrganizations/org1.example.com/peers/peer1.org1.example.com/msp:/etc/hyperledger/fabric/msp</span><br><span class="line">       - ./crypto-config/peerOrganizations/org1.example.com/peers/peer1.org1.example.com/tls:/etc/hyperledger/fabric/tls</span><br><span class="line">    ports:</span><br><span class="line">      - 7051:7051</span><br><span class="line">      - 7052:7052</span><br><span class="line">      - 7053:7053</span><br><span class="line">    dns:</span><br><span class="line">      - &quot;192.168.3.94&quot;</span><br><span class="line"></span><br><span class="line">  cli:</span><br><span class="line">    container_name: cli</span><br><span class="line">    image: hyperledger/fabric-tools</span><br><span class="line">    tty: true</span><br><span class="line">    environment:</span><br><span class="line">      - GOPATH=/opt/gopath</span><br><span class="line">      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock</span><br><span class="line">      # - CORE_LOGGING_LEVEL=ERROR</span><br><span class="line">      - CORE_LOGGING_LEVEL=DEBUG</span><br><span class="line">      - CORE_PEER_ID=cli</span><br><span class="line">      - CORE_PEER_ADDRESS=peer1.org1.example.com:7051</span><br><span class="line">      - CORE_PEER_LOCALMSPID=Org1MSP</span><br><span class="line">      - CORE_PEER_TLS_ENABLED=true</span><br><span class="line">      - CORE_PEER_TLS_CERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer1.org1.example.com/tls/server.crt</span><br><span class="line">      - CORE_PEER_TLS_KEY_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer1.org1.example.com/tls/server.key</span><br><span class="line">      - CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer1.org1.example.com/tls/ca.crt</span><br><span class="line">      - CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp</span><br><span class="line">    working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer</span><br><span class="line">    volumes:</span><br><span class="line">        - /var/run/:/host/var/run/</span><br><span class="line">        - ./chaincode/go/:/opt/gopath/src/github.com/hyperledger/fabric/kafkapeer/chaincode/go</span><br><span class="line">        - ./crypto-config:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/</span><br><span class="line">        - ./channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts</span><br><span class="line">    dns:</span><br><span class="line">      - &quot;192.168.3.94&quot;</span><br></pre></td></tr></table></figure><h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f docker-compose-zookeeper.yaml up -d</span><br><span class="line">docker-compose -f docker-compose-kafka.yaml up -d</span><br><span class="line">docker-compose -f docker-compose-orderer.yaml up -d</span><br><span class="line">docker-compose -f docker-compose-peer.yaml up -d</span><br></pre></td></tr></table></figure><h2 id="创建channel"><a href="#创建channel" class="headerlink" title="创建channel"></a>创建channel</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">进入cli：</span><br><span class="line">peer channel create -o orderer0.example.com:7050 -c mychannel -f ./channel-artifacts/mychannel.tx</span><br><span class="line">peer channel join -b mychannel.block</span><br></pre></td></tr></table></figure><p>之后切换变量，批量加就可以了</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Kafka模式简介&quot;&gt;&lt;a href=&quot;#Kafka模式简介&quot; class=&quot;headerlink&quot; title=&quot;Kafka模式简介&quot;&gt;&lt;/a&gt;Kafka模式简介&lt;/h1&gt;&lt;p&gt;Hyperledger Fabric采用kafka方式实现排序（orderer）服务
      
    
    </summary>
    
      <category term="区块链" scheme="https://shenshengkun.github.io/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/"/>
    
    
  </entry>
  
  <entry>
    <title>tornado-电话报警</title>
    <link href="https://shenshengkun.github.io/posts/aa774e96.html"/>
    <id>https://shenshengkun.github.io/posts/aa774e96.html</id>
    <published>2019-03-19T05:37:01.000Z</published>
    <updated>2019-05-30T02:29:19.203Z</updated>
    
    <content type="html"><![CDATA[<h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p>某些时候邮件，钉钉的报警我们在家里，或者周末是很少去观看的，这时候如果服务器出了问题，运维人员是没法第一时间排查到，所以短信和电话报警就很有必要去做。</p><p>已有阿里云的语音短信报警接口，故做了个端口电话报警。</p><h1 id="电话报警脚本"><a href="#电话报警脚本" class="headerlink" title="电话报警脚本"></a>电话报警脚本</h1><p>[root@aa phone_send]# cat send_model.py</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line">import requests</span><br><span class="line">import tornado.ioloop</span><br><span class="line">import tornado.web</span><br><span class="line"></span><br><span class="line">phonenumber = &quot;xxxxxxx,xxxxxxx&quot;</span><br><span class="line">portdic = &#123;</span><br><span class="line">    &quot;9876&quot;:&quot;服务类型MQ,端口9876&quot;,</span><br><span class="line">    &quot;2181&quot;:&quot;服务类型ZK,端口2181&quot;,</span><br><span class="line">    &quot;3306&quot;:&quot;服务类型数据库,端口3306&quot;,</span><br><span class="line">    &quot;27017&quot;:&quot;服务类型数据库,端口27017&quot;,</span><br><span class="line">    &quot;1908&quot;:&quot;服务类型spada,薛亮应用&quot;,</span><br><span class="line">    &quot;53&quot;:&quot;服务类型dns,端口53&quot;,</span><br><span class="line">    &quot;9200&quot;:&quot;服务类型es,端口9200&quot;,</span><br><span class="line">    &quot;6379&quot;:&quot;服务类型redis,端口6379&quot;,</span><br><span class="line">    &quot;80&quot;:&quot;服务类型nginx,端口80&quot;</span><br><span class="line">&#125;</span><br><span class="line">statusdic = &#123;</span><br><span class="line">    &quot;PROBLEM&quot;:&quot;服务发生故障&quot;,</span><br><span class="line">    &quot;OK&quot;:&quot;故障恢复&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class MainHandler(tornado.web.RequestHandler):</span><br><span class="line">    def get(self):</span><br><span class="line">        status = self.get_argument(&apos;status&apos;)</span><br><span class="line">        endpoint = self.get_argument(&apos;endpoint&apos;)</span><br><span class="line">        metric = self.get_argument(&apos;metric&apos;)</span><br><span class="line">        tags = self.get_argument(&apos;tags&apos;)</span><br><span class="line">        statusok = statusdic.get(status)</span><br><span class="line">        port = tags.split(&quot;:&quot;)[1]</span><br><span class="line">        p_endpoint = endpoint.split(&quot;.&quot;)</span><br><span class="line">        del(p_endpoint[0])</span><br><span class="line">        portmes = portdic.get(port)</span><br><span class="line">        if portmes == None:</span><br><span class="line">            portmes = &quot;端口&quot; + port</span><br><span class="line">        # 短信</span><br><span class="line">        requests.get(&quot;http://域名/send_sms/%s,%s,%s,%s/%s&quot;%(statusok,endpoint,metric,portmes,phonenumber))</span><br><span class="line">        # 电话</span><br><span class="line">        requests.get(&quot;http://域名/send_phone/%s%s%s%s/%s&quot;%(statusok,p_endpoint,metric,portmes,phonenumber))</span><br><span class="line">        message = status + endpoint + metric + tags</span><br><span class="line">        print(status,endpoint,metric,tags,port)</span><br><span class="line">application = tornado.web.Application([(r&quot;/message&quot;, MainHandler), ])</span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    application.listen(8868)</span><br><span class="line">    tornado.ioloop.IOLoop.instance().start()</span><br></pre></td></tr></table></figure><h1 id="执行"><a href="#执行" class="headerlink" title="执行"></a>执行</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 send_model.py</span><br></pre></td></tr></table></figure><h1 id="callback接口"><a href="#callback接口" class="headerlink" title="callback接口"></a>callback接口</h1><p><a href="http://ip:8868/message" target="_blank" rel="noopener">http://ip:8868/message</a></p><h1 id="openfalcon监控做模板"><a href="#openfalcon监控做模板" class="headerlink" title="openfalcon监控做模板"></a>openfalcon监控做模板</h1><p><img src="https://shenshengkun.github.io/images/open_falcon-tornado.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;需求&quot;&gt;&lt;a href=&quot;#需求&quot; class=&quot;headerlink&quot; title=&quot;需求&quot;&gt;&lt;/a&gt;需求&lt;/h1&gt;&lt;p&gt;某些时候邮件，钉钉的报警我们在家里，或者周末是很少去观看的，这时候如果服务器出了问题，运维人员是没法第一时间排查到，所以短信和电话报警就很有
      
    
    </summary>
    
      <category term="python" scheme="https://shenshengkun.github.io/categories/python/"/>
    
    
  </entry>
  
  <entry>
    <title>tornado-hello</title>
    <link href="https://shenshengkun.github.io/posts/6fd83cc1.html"/>
    <id>https://shenshengkun.github.io/posts/6fd83cc1.html</id>
    <published>2019-03-19T02:23:01.000Z</published>
    <updated>2019-05-30T02:29:19.197Z</updated>
    
    <content type="html"><![CDATA[<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p><a href="http://www.tornadoweb.org/" target="_blank" rel="noopener">Tornado</a>是一个Python Web框架和异步网络库，最初是在<a href="http://friendfeed.com/" target="_blank" rel="noopener">FriendFeed上</a>开发的。通过使用非阻塞网络I / O，Tornado可以扩展到数万个开放连接，使其成为<a href="http://en.wikipedia.org/wiki/Push_technology#Long_polling" target="_blank" rel="noopener">长轮询</a>， <a href="http://en.wikipedia.org/wiki/WebSocket" target="_blank" rel="noopener">WebSockets</a>和其他需要与每个用户建立长期连接的应用程序的理想选择 。 </p><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install tornado</span><br></pre></td></tr></table></figure><h1 id="简单的web"><a href="#简单的web" class="headerlink" title="简单的web"></a>简单的web</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import tornado.ioloop</span><br><span class="line">import tornado.web</span><br><span class="line"></span><br><span class="line">class MainHandler(tornado.web.RequestHandler):</span><br><span class="line">    def get(self):</span><br><span class="line">        self.write(&quot;Hello, world&quot;)</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    application = tornado.web.Application([</span><br><span class="line">        (r&quot;/index&quot;, MainHandler),</span><br><span class="line">    ])</span><br><span class="line">    application.listen(8888)</span><br><span class="line">    tornado.ioloop.IOLoop.current().start()</span><br></pre></td></tr></table></figure><h1 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h1><p><a href="http://ip:8888/index" target="_blank" rel="noopener">http://ip:8888/index</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;概念&quot;&gt;&lt;a href=&quot;#概念&quot; class=&quot;headerlink&quot; title=&quot;概念&quot;&gt;&lt;/a&gt;概念&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;http://www.tornadoweb.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;To
      
    
    </summary>
    
      <category term="python" scheme="https://shenshengkun.github.io/categories/python/"/>
    
    
  </entry>
  
  <entry>
    <title>fabric-ca部署</title>
    <link href="https://shenshengkun.github.io/posts/86326b76.html"/>
    <id>https://shenshengkun.github.io/posts/86326b76.html</id>
    <published>2019-03-05T02:10:01.000Z</published>
    <updated>2019-05-31T02:45:33.852Z</updated>
    
    <content type="html"><![CDATA[<h1 id="部署一个fabric-ca"><a href="#部署一个fabric-ca" class="headerlink" title="部署一个fabric-ca"></a>部署一个fabric-ca</h1><h2 id="创建一个由两个组织org1-example-com和org2-example-com组成的的联盟"><a href="#创建一个由两个组织org1-example-com和org2-example-com组成的的联盟" class="headerlink" title="创建一个由两个组织org1.example.com和org2.example.com组成的的联盟"></a>创建一个由两个组织<code>org1.example.com</code>和<code>org2.example.com</code>组成的的联盟</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">还有一个组织example.com用来部署orderer。</span><br><span class="line"></span><br><span class="line">组织example.com部署了一个solo模式的orderer。（多个orderer的部署方式，以后探讨）</span><br><span class="line">orderer.example.com</span><br><span class="line"></span><br><span class="line">组织org1.example.com部署了两个peer:</span><br><span class="line">peer0.org1.example.com</span><br><span class="line">peer1.org1.example.com</span><br><span class="line"></span><br><span class="line">组织org2.example.com部署了一个peer:</span><br><span class="line">peer0.org2.example.com</span><br><span class="line"></span><br><span class="line">每个组织都要有一个Admin用户，每个组件(peer/orderer)也需要一个账号，因此需要通过FabricCA创建7个用户：</span><br><span class="line">example.com:       Admin@example.com       orderer.example.com</span><br><span class="line">org1.example.com:  Admin@org1.example.com  peer0.org1.example.com  peer1.org1.example.com  </span><br><span class="line">org2.example.com:  Admin@org2.example.com  peer0.org2.example.com</span><br><span class="line"></span><br><span class="line">这里只创建了Admin用户和每个组件的账号，普通用户的创建方式相同，只是普通用户的证书不需要添加到目标组件的admincerts目录中。</span><br><span class="line"></span><br><span class="line">或者说一个用户的证书如果被添加到了对应组织或组件的msp/admincerts目录中，那么这个用户就称为对应的管理员。</span><br></pre></td></tr></table></figure><h2 id="启动fabric-ca"><a href="#启动fabric-ca" class="headerlink" title="启动fabric-ca"></a>启动fabric-ca</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">fabirc-ca的编译：</span><br><span class="line"></span><br><span class="line">$ go get -u github.com/hyperledger/fabric-ca</span><br><span class="line">$ cd $GOPATH/src/github.com/hyperledger/fabric-ca</span><br><span class="line">$ make fabric-ca-server</span><br><span class="line">$ make fabric-ca-client</span><br><span class="line">$ ls bin/</span><br><span class="line">fabric-ca-client  fabric-ca-server</span><br><span class="line">这里将fabric-ca部署在/opt/app/fabric-ca/server目录中：</span><br><span class="line"></span><br><span class="line">mkdir -p /opt/app/fabric-ca/server</span><br><span class="line">cp -rf $GOPATH/src/github.com/hyperledger/fabric-ca/bin/*  /opt/app/fabric-ca/server</span><br><span class="line">ln -s /opt/app/fabric-ca/server/fabric-ca-client  /usr/bin/fabric-ca-client</span><br><span class="line">直接启动ca，fabric-ca admin的名称为admin，密码为pass。(这里只是演示，生产中使用，你需要根据实际的情况配置)</span><br><span class="line"></span><br><span class="line">cd /opt/app/fabric-ca/server</span><br><span class="line">./fabric-ca-server start -b  admin:pass &amp;</span><br><span class="line">如果有删除联盟和删除用户的需求，需要用下面的方式启动：</span><br><span class="line"></span><br><span class="line">cd /opt/app/fabric-ca/server</span><br><span class="line">./fabric-ca-server start -b admin:pass --cfg.affiliations.allowremove  --cfg.identities.allowremove &amp;</span><br></pre></td></tr></table></figure><h2 id="生成fabric-ca-admin的凭证"><a href="#生成fabric-ca-admin的凭证" class="headerlink" title="生成fabric-ca admin的凭证"></a>生成fabric-ca admin的凭证</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/fabric-deploy</span><br><span class="line">cd ~/fabric-deploy</span><br><span class="line">mkdir fabric-ca-files </span><br><span class="line">生成fabric-ca admin的凭证，用-H参数指定client目录：</span><br><span class="line"></span><br><span class="line">mkdir -p `pwd`/fabric-ca-files/admin</span><br><span class="line">fabric-ca-client enroll -u http://admin:pass@localhost:7054 -H `pwd`/fabric-ca-files/admin</span><br><span class="line">也可以用环境变量FABRIC_CA_CLIENT_HOME指定了client的工作目录，生成的用户凭证将存放在这个目录中。</span><br><span class="line"></span><br><span class="line">export FABRIC_CA_CLIENT_HOME=`pwd`/fabric-ca-files/admin</span><br><span class="line">mkdir -p $FABRIC_CA_CLIENT_HOME</span><br><span class="line">fabric-ca-client enroll -u http://admin:pass@localhost:7054</span><br></pre></td></tr></table></figure><h2 id="创建联盟"><a href="#创建联盟" class="headerlink" title="创建联盟"></a>创建联盟</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">上面的启动方式默认会创建两个组织：</span><br><span class="line"></span><br><span class="line">$ fabric-ca-client  -H `pwd`/fabric-ca-files/admin  affiliation list</span><br><span class="line">2018/05/07 02:36:46 [INFO] [::1]:56148 GET /affiliations 200 0 &quot;OK&quot;</span><br><span class="line">affiliation: .</span><br><span class="line">   affiliation: org2</span><br><span class="line">      affiliation: org2.department1</span><br><span class="line">   affiliation: org1</span><br><span class="line">      affiliation: org1.department1</span><br><span class="line">      affiliation: org1.department2</span><br><span class="line"></span><br><span class="line">为了查看信息的时候，看到的输出比较简洁，用下面的命令将其删除：</span><br><span class="line">fabric-ca-client -H `pwd`/fabric-ca-files/admin  affiliation remove --force  org1</span><br><span class="line">fabric-ca-client -H `pwd`/fabric-ca-files/admin  affiliation remove --force  org2</span><br><span class="line"></span><br><span class="line">执行下面命令创建联盟：</span><br><span class="line">fabric-ca-client  -H `pwd`/fabric-ca-files/admin  affiliation add com </span><br><span class="line">fabric-ca-client  -H `pwd`/fabric-ca-files/admin  affiliation add com.example</span><br><span class="line">fabric-ca-client  -H `pwd`/fabric-ca-files/admin  affiliation add com.example.org1</span><br><span class="line">fabric-ca-client  -H `pwd`/fabric-ca-files/admin  affiliation add com.example.org2</span><br><span class="line"></span><br><span class="line">注意：联盟是有层级的。</span><br><span class="line"></span><br><span class="line">创建联盟如下：</span><br><span class="line">$ fabric-ca-client -H `pwd`/fabric-ca-files/admin  affiliation list</span><br><span class="line">2018/04/28 15:19:34 [INFO] 127.0.0.1:38160 GET /affiliations 201 0 &quot;OK&quot;</span><br><span class="line">affiliation: com</span><br><span class="line">   affiliation: com.example</span><br><span class="line">      affiliation: com.example.org1</span><br><span class="line">      affiliation: com.example.org2</span><br></pre></td></tr></table></figure><h2 id="为每个组织准备msp"><a href="#为每个组织准备msp" class="headerlink" title="为每个组织准备msp"></a>为每个组织准备msp</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">就是从Fabric-CA中，读取出用来签署用户的根证书等。</span><br><span class="line"></span><br><span class="line">为example.com准备msp，将ca证书等存放example.com组织的目录中:</span><br><span class="line">mkdir -p ./fabric-ca-files/example.com/msp</span><br><span class="line">fabric-ca-client getcacert -M `pwd`/fabric-ca-files/example.com/msp    //-M需要指定绝对路径</span><br><span class="line"></span><br><span class="line">命令执行结束后，会在fabric-ca-files/example.com/msp得到文件：</span><br><span class="line">$ tree fabric-ca-files/example.com/msp/</span><br><span class="line">example.com/msp/</span><br><span class="line">|-- cacerts</span><br><span class="line">|   `-- localhost-7054.pem</span><br><span class="line">|-- intermediatecerts</span><br><span class="line">|   `-- localhost-7054.pem</span><br><span class="line">|-- keystore</span><br><span class="line">`-- signcerts</span><br><span class="line"></span><br><span class="line">注意通过getcacert得到msp目录中只有CA证书，而且这里没有使用中间CA，fabric-ca-files/example.com/msp/intermediatecerts/localhost-7054.pem是一个空文件。</span><br><span class="line"></span><br><span class="line">同样的方式为org1.example.com获取msp:</span><br><span class="line">mkdir -p fabric-ca-files/org1.example.com/msp</span><br><span class="line">fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org1.example.com/msp</span><br><span class="line"></span><br><span class="line">为org2.example.com准备msp:</span><br><span class="line">mkdir -p ./fabric-ca-files/org2.example.com/msp</span><br><span class="line">fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org2.example.com/msp</span><br><span class="line"></span><br><span class="line">这里是用getcacert为每个组织准备需要的ca文件，在生成创始块的时候会用到。</span><br><span class="line">在1.1.0版本的fabric-ca中，只会生成用户在操作区块链的时候用到的证书和密钥，不会生成用来加密grpc通信的证书。</span><br><span class="line"></span><br><span class="line">这里复用之前用cryptogen生成的tls证书，需要将验证tls证书的ca添加到msp目录中，如下：</span><br><span class="line">cp -rf certs/ordererOrganizations/example.com/msp/tlscacerts  fabric-ca-files/example.com/msp/</span><br><span class="line">cp -rf certs/peerOrganizations/org1.example.com/msp/tlscacerts/ fabric-ca-files/org1.example.com/msp/</span><br><span class="line">cp -rf certs/peerOrganizations/org2.example.com/msp/tlscacerts/ fabric-ca-files/org2.example.com/msp/</span><br><span class="line"></span><br><span class="line">如果在你的环境中，各个组件域名的证书，是由第三方CA签署的，就将第三方CA的根证书添加到msp/tlscacerts目录中。</span><br><span class="line"></span><br><span class="line">组织的msp目录中，包含都是CA根证书，分别是TLS加密的根证书，和用于身份验证的根证书。另外还需要admin用户的证书，后面的操作中会添加。</span><br></pre></td></tr></table></figure><h2 id="注册example-com的管理员Admin-example-com"><a href="#注册example-com的管理员Admin-example-com" class="headerlink" title="注册example.com的管理员Admin@example.com"></a>注册example.com的管理员<a href="mailto:Admin@example.com" target="_blank" rel="noopener">Admin@example.com</a></h2><p>可以直接用命令行（命令比较长，这里用<code>\\</code>截断了）： </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fabric-ca-client register --id.name Admin@example.com --id.type client --id.affiliation &quot;com.example.org1&quot;  \</span><br><span class="line">    --id.attrs &apos;&quot;hf.Registrar.Roles=client,orderer,peer,user&quot;,&quot;hf.Registrar.DelegateRoles=client,orderer,peer,user&quot;,\</span><br><span class="line">                 hf.Registrar.Attributes=*,hf.GenCRL=true,hf.Revoker=true,hf.AffiliationMgr=true,hf.IntermediateCA=true,role=admin:ecert&apos;</span><br></pre></td></tr></table></figure><p>也可以将命令行参数写在fabric-ca admin的配置文件<code>fabric-ca-files/admin/fabric-ca-client-config.yaml</code>中。 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ls fabric-ca-files/admin/admin/</span><br><span class="line">fabric-ca-client-config.yaml  msp</span><br></pre></td></tr></table></figure><p>为了演示清楚，这里使用修改配置文件的方式，将<code>fabric-ca-files/admin/fabric-ca-client-config.yaml</code>其中的<code>id</code>部分修改为： </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">id:</span><br><span class="line">  name: Admin@example.com</span><br><span class="line">  type: client</span><br><span class="line">  affiliation: com.example</span><br><span class="line">  maxenrollments: 0</span><br><span class="line">  attributes:</span><br><span class="line">    - name: hf.Registrar.Roles</span><br><span class="line">      value: client,orderer,peer,user</span><br><span class="line">    - name: hf.Registrar.DelegateRoles</span><br><span class="line">      value: client,orderer,peer,user</span><br><span class="line">    - name: hf.Registrar.Attributes</span><br><span class="line">      value: &quot;*&quot;</span><br><span class="line">    - name: hf.GenCRL</span><br><span class="line">      value: true</span><br><span class="line">    - name: hf.Revoker</span><br><span class="line">      value: true</span><br><span class="line">    - name: hf.AffiliationMgr</span><br><span class="line">      value: true</span><br><span class="line">    - name: hf.IntermediateCA</span><br><span class="line">      value: true</span><br><span class="line">    - name: role</span><br><span class="line">      value: admin</span><br><span class="line">      ecert: true</span><br></pre></td></tr></table></figure><p>注意最后一行role属性，是我们<code>自定义</code>的属性，对于自定义的属性，要设置certs，在配置文件中需要<code>单独设置ecert属性为true或者false</code>。如果在命令行中，添加后缀<code>:ecert</code>表示true，例如: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fabric-ca-client register --id.affiliation &quot;com.example.org1&quot; --id.attrs &quot;role=admin:ecert&quot;</span><br></pre></td></tr></table></figure><p>直接执行下面的命令，即可完成用户<a href="mailto:`Admin@example.com" target="_blank" rel="noopener">`Admin@example.com</a>`注册，注意这时候的注册使用fabricCA的admin账号完成的： </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password</span><br></pre></td></tr></table></figure><p>如果不用<code>--id.secret</code>指定密码，会自动生成密码。</p><p>其它配置的含义是用户名为<a href="mailto:`Admin@example.com" target="_blank" rel="noopener">`Admin@example.com</a><code>，类型是</code>client<code>，它能够管理</code>com.example.*`下的用户，如下:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">--id.name  Admin@example.com                           //用户名</span><br><span class="line">--id.type client                                       //类型为client</span><br><span class="line">--id.affiliation &quot;com.example&quot;                         //权利访问</span><br><span class="line">hf.Registrar.Roles=client,orderer,peer,user            //能够管理的用户类型</span><br><span class="line">hf.Registrar.DelegateRoles=client,orderer,peer,user    //可以授权给子用户管理的用户类型</span><br><span class="line">hf.Registrar.Attributes=*                              //可以为子用户设置所有属性</span><br><span class="line">hf.GenCRL=true                                         //可以生成撤销证书列表</span><br><span class="line">hf.Revoker=true                                        //可以撤销用户</span><br><span class="line">hf.AffiliationMgr=true                                 //能够管理联盟</span><br><span class="line">hf.IntermediateCA=true                                 //可以作为中间CA</span><br><span class="line">role=admin:ecert                                       //自定义属性</span><br></pre></td></tr></table></figure><p>完成注册之后，还需生成<a href="mailto:Admin@example.com" target="_blank" rel="noopener">Admin@example.com</a>凭证： </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p ./fabric-ca-files/example.com/admin</span><br><span class="line">$ fabric-ca-client enroll -u http://Admin@example.com:password@localhost:7054  -H `pwd`/fabric-ca-files/example.com/admin</span><br><span class="line">$ ls ./fabric-ca-files/example.com/admin</span><br><span class="line">fabric-ca-client-config.yaml  msp/</span><br></pre></td></tr></table></figure><p>这时候可以用<a href="mailto:Admin@example.com" target="_blank" rel="noopener">Admin@example.com</a>的身份查看联盟： </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/example.com/admin</span><br><span class="line">2018/04/28 15:35:10 [INFO] 127.0.0.1:38172 GET /affiliations 201 0 &quot;OK&quot;</span><br><span class="line">affiliation: com</span><br><span class="line">   affiliation: com.example</span><br><span class="line">      affiliation: com.example.org1</span><br><span class="line">      affiliation: com.example.org2</span><br></pre></td></tr></table></figure><p>最后将<a href="mailto:Admin@example.com" target="_blank" rel="noopener">Admin@example.com</a>的证书复制到example.com/msp/admincerts/中： </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir fabric-ca-files/example.com/msp/admincerts/</span><br><span class="line">cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem  fabric-ca-files/example.com/msp/admincerts/</span><br></pre></td></tr></table></figure><h2 id="注册org1-example-com的管理员Admin-org1-example-com"><a href="#注册org1-example-com的管理员Admin-org1-example-com" class="headerlink" title="注册org1.example.com的管理员Admin@org1.example.com"></a>注册org1.example.com的管理员<a href="mailto:Admin@org1.example.com" target="_blank" rel="noopener">Admin@org1.example.com</a></h2><p>为org1.example.com的管理员<a href="mailto:Admin@org1.example.com" target="_blank" rel="noopener">Admin@org1.example.com</a>准备一个目录:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/fabric-deploy</span><br><span class="line">mkdir -p ./fabric-ca-files/org1.example.com/admin</span><br></pre></td></tr></table></figure><p>将<code>fabric-ca-files/admin/fabric-ca-client-config.yaml</code>其中的<code>id</code>部分修改为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">id:</span><br><span class="line">  name: Admin@org1.example.com</span><br><span class="line">  type: client</span><br><span class="line">  affiliation: com.example.org1</span><br><span class="line">  maxenrollments: 0</span><br><span class="line">  attributes:</span><br><span class="line">    - name: hf.Registrar.Roles</span><br><span class="line">      value: client,orderer,peer,user</span><br><span class="line">    - name: hf.Registrar.DelegateRoles</span><br><span class="line">      value: client,orderer,peer,user</span><br><span class="line">    - name: hf.Registrar.Attributes</span><br><span class="line">      value: &quot;*&quot;</span><br><span class="line">    - name: hf.GenCRL</span><br><span class="line">      value: true</span><br><span class="line">    - name: hf.Revoker</span><br><span class="line">      value: true</span><br><span class="line">    - name: hf.AffiliationMgr</span><br><span class="line">      value: true</span><br><span class="line">    - name: hf.IntermediateCA</span><br><span class="line">      value: true</span><br><span class="line">    - name: role</span><br><span class="line">      value: admin</span><br><span class="line">      ecert: true</span><br></pre></td></tr></table></figure><p>注册：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password</span><br></pre></td></tr></table></figure><p>生成凭证：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ fabric-ca-client enroll -u http://Admin@org1.example.com:password@localhost:7054  -H `pwd`/fabric-ca-files/org1.example.com/admin</span><br><span class="line">$ ls ./fabric-ca-files/org1.example.com/admin</span><br><span class="line">fabric-ca-client-config.yaml  msp/</span><br></pre></td></tr></table></figure><p>查看联盟：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/org1.example.com/admin</span><br><span class="line">2018/05/04 15:42:53 [INFO] 127.0.0.1:51298 GET /affiliations 201 0 &quot;OK&quot;</span><br><span class="line">affiliation: com</span><br><span class="line">   affiliation: com.example</span><br><span class="line">      affiliation: com.example.org1</span><br></pre></td></tr></table></figure><p>注意与<a href="mailto:`Admin@example.com" target="_blank" rel="noopener">`Admin@example.com</a>`的区别，这里只能看到组织com.example.org1</p><p>将<a href="mailto:Admin@org1.example.com" target="_blank" rel="noopener">Admin@org1.example.com</a>的证书复制到<code>org1.example.com</code>的<code>msp/admincerts</code>中：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir fabric-ca-files/org1.example.com/msp/admincerts/</span><br><span class="line">cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem  fabric-ca-files/org1.example.com/msp/admincerts/</span><br></pre></td></tr></table></figure><p>在<a href="mailto:`Admin@org1.example.com" target="_blank" rel="noopener">`Admin@org1.example.com</a>目录`中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir fabric-ca-files/org1.example.com/admin/msp/admincerts/     # 注意是org1.example.com/admin目录</span><br><span class="line">cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem  fabric-ca-files/org1.example.com/admin/msp/admincerts/</span><br></pre></td></tr></table></figure><p>另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm fabric-ca-files/org1.example.com/admin/msp/intermediatecerts/*</span><br></pre></td></tr></table></figure><h2 id="注册org2-example-com的管理员Admin-org2-example-com"><a href="#注册org2-example-com的管理员Admin-org2-example-com" class="headerlink" title="注册org2.example.com的管理员Admin@org2.example.com"></a>注册org2.example.com的管理员<a href="mailto:Admin@org2.example.com" target="_blank" rel="noopener">Admin@org2.example.com</a></h2><p>为org2.example.com的管理员<a href="mailto:Admin@org2.example.com" target="_blank" rel="noopener">Admin@org2.example.com</a>准备一个目录:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/fabric-deploy</span><br><span class="line">mkdir -p ./fabric-ca-files/org2.example.com/admin</span><br></pre></td></tr></table></figure><p>将<code>fabric-ca-files/admin/fabric-ca-client-config.yaml</code>其中的<code>id</code>部分修改为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">id:</span><br><span class="line">  name: Admin@org2.example.com</span><br><span class="line">  type: client</span><br><span class="line">  affiliation: com.example.org2</span><br><span class="line">  maxenrollments: 0</span><br><span class="line">  attributes:</span><br><span class="line">    - name: hf.Registrar.Roles</span><br><span class="line">      value: client,orderer,peer,user</span><br><span class="line">    - name: hf.Registrar.DelegateRoles</span><br><span class="line">      value: client,orderer,peer,user</span><br><span class="line">    - name: hf.Registrar.Attributes</span><br><span class="line">      value: &quot;*&quot;</span><br><span class="line">    - name: hf.GenCRL</span><br><span class="line">      value: true</span><br><span class="line">    - name: hf.Revoker</span><br><span class="line">      value: true</span><br><span class="line">    - name: hf.AffiliationMgr</span><br><span class="line">      value: true</span><br><span class="line">    - name: hf.IntermediateCA</span><br><span class="line">      value: true</span><br><span class="line">    - name: role</span><br><span class="line">      value: admin</span><br><span class="line">      ecert: true</span><br></pre></td></tr></table></figure><p>注册：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password</span><br></pre></td></tr></table></figure><p>生成凭证：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ fabric-ca-client enroll -u http://Admin@org2.example.com:password@localhost:7054  -H `pwd`/fabric-ca-files/org2.example.com/admin</span><br><span class="line">$ ls ./fabric-ca-files/org2.example.com/admin</span><br><span class="line">fabric-ca-client-config.yaml  msp/</span><br></pre></td></tr></table></figure><p>查看联盟：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/org2.example.com/admin</span><br><span class="line">2018/05/02 16:49:00 [INFO] 127.0.0.1:50828 GET /affiliations 201 0 &quot;OK&quot;</span><br><span class="line">affiliation: com</span><br><span class="line">   affiliation: com.example</span><br><span class="line">      affiliation: com.example.org2</span><br></pre></td></tr></table></figure><p><a href="mailto:Admin@org2.example.com" target="_blank" rel="noopener">Admin@org2.example.com</a>只能看到组织<code>com.example.org2</code>。</p><p>将<a href="mailto:Admin@org2.example.com" target="_blank" rel="noopener">Admin@org2.example.com</a>的证书复制到org2.example.com的msp/admincerts中：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir fabric-ca-files/org2.example.com/msp/admincerts/</span><br><span class="line">cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem  fabric-ca-files/org2.example.com/msp/admincerts/</span><br></pre></td></tr></table></figure><p>在<a href="mailto:Admin@org2.example.com" target="_blank" rel="noopener">Admin@org2.example.com</a>中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir fabric-ca-files/org2.example.com/admin/msp/admincerts/</span><br><span class="line">cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem  fabric-ca-files/org2.example.com/admin/msp/admincerts/</span><br></pre></td></tr></table></figure><p>另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm fabric-ca-files/org2.example.com/admin/msp/intermediatecerts/*</span><br></pre></td></tr></table></figure><h2 id="各个组织分别使用自己的Admin账户创建其它账号"><a href="#各个组织分别使用自己的Admin账户创建其它账号" class="headerlink" title="各个组织分别使用自己的Admin账户创建其它账号"></a>各个组织分别使用自己的Admin账户创建其它账号</h2><p>example.com、org1.example.com、org2.example.com三个组织这时候可以分别使用自己的Admin账号创建子账号。 </p><h3 id="orderer-example-com"><a href="#orderer-example-com" class="headerlink" title="orderer.example.com"></a>orderer.example.com</h3><p>使用<a href="mailto:`Admin@example.com" target="_blank" rel="noopener">`Admin@example.com</a><code>注册账号orderer.example.com。注意这时候指定的目录是fabric-ca-files/</code>example.com`/admin/。</p><p>修改fabric-ca-files/example.com/admin/fabric-ca-client-config.yaml:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">id:</span><br><span class="line">  name: orderer.example.com</span><br><span class="line">  type: orderer</span><br><span class="line">  affiliation: com.example</span><br><span class="line">  maxenrollments: 0</span><br><span class="line">  attributes:</span><br><span class="line">    - name: role</span><br><span class="line">      value: orderer</span><br><span class="line">      ecert: true</span><br></pre></td></tr></table></figure><p>注册以及生成凭证：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fabric-ca-client register -H `pwd`/fabric-ca-files/example.com/admin --id.secret=password</span><br><span class="line">mkdir ./fabric-ca-files/example.com/orderer</span><br><span class="line">fabric-ca-client enroll -u http://orderer.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/example.com/orderer</span><br></pre></td></tr></table></figure><p>将<a href="mailto:`Admin@example.com" target="_blank" rel="noopener">`Admin@example.com</a>`的证书复制到fabric-ca-files/example.com/orderer/msp/admincerts：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir fabric-ca-files/example.com/orderer/msp/admincerts</span><br><span class="line">cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem fabric-ca-files/example.com/orderer/msp/admincerts/</span><br></pre></td></tr></table></figure><h3 id="peer0-org1-example-com"><a href="#peer0-org1-example-com" class="headerlink" title="peer0.org1.example.com"></a>peer0.org1.example.com</h3><p>使用<a href="mailto:`Admin@org1.example.com" target="_blank" rel="noopener">`Admin@org1.example.com</a><code>注册账号peer0.org1.example.com。这时候指定的目录是fabric-ca-files/</code>org1.example.com`/admin/。</p><p>修改fabric-ca-files/org1.example.com/admin/fabric-ca-client-config.yaml:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">id:</span><br><span class="line">  name: peer0.org1.example.com</span><br><span class="line">  type: peer</span><br><span class="line">  affiliation: com.example.org1</span><br><span class="line">  maxenrollments: 0</span><br><span class="line">  attributes:</span><br><span class="line">    - name: role</span><br><span class="line">      value: peer</span><br><span class="line">      ecert: true</span><br></pre></td></tr></table></figure><p>注册以及生成凭证：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin --id.secret=password</span><br><span class="line">mkdir ./fabric-ca-files/org1.example.com/peer0</span><br><span class="line">fabric-ca-client enroll -u http://peer0.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer0</span><br></pre></td></tr></table></figure><p>将<a href="mailto:`Admin@org1.example.com" target="_blank" rel="noopener">`Admin@org1.example.com</a>`的证书复制到fabric-ca-files/org1.example.com/peer0/msp/admincerts：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir fabric-ca-files/org1.example.com/peer0/msp/admincerts</span><br><span class="line">cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/peer0/msp/admincerts/</span><br></pre></td></tr></table></figure><h3 id="peer1-org1-example-com"><a href="#peer1-org1-example-com" class="headerlink" title="peer1.org1.example.com"></a>peer1.org1.example.com</h3><p>使用<a href="mailto:`Admin@org1.example.com" target="_blank" rel="noopener">`Admin@org1.example.com</a><code>注册账号peer1.org1.example.com。这时候指定的目录是fabric-ca-files/</code>org1.example.com`/admin/。</p><p>修改fabric-ca-files/org1.example.com/admin/fabric-ca-client-config.yaml:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">id:</span><br><span class="line">  name: peer1.org1.example.com</span><br><span class="line">  type: peer</span><br><span class="line">  affiliation: com.example.org1</span><br><span class="line">  maxenrollments: 0</span><br><span class="line">  attributes:</span><br><span class="line">    - name: role</span><br><span class="line">      value: peer</span><br><span class="line">      ecert: true</span><br></pre></td></tr></table></figure><p>注册以及生成凭证：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin --id.secret=password</span><br><span class="line">mkdir ./fabric-ca-files/org1.example.com/peer1</span><br><span class="line">fabric-ca-client enroll -u http://peer1.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer1</span><br></pre></td></tr></table></figure><p>将<a href="mailto:`Admin@org1.example.com" target="_blank" rel="noopener">`Admin@org1.example.com</a>`的证书复制到fabric-ca-files/org1.example.com/peer1/msp/admincerts：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir fabric-ca-files/org1.example.com/peer1/msp/admincerts</span><br><span class="line">cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/peer1/msp/admincerts/</span><br></pre></td></tr></table></figure><h3 id="peer0-org2-example-com"><a href="#peer0-org2-example-com" class="headerlink" title="peer0.org2.example.com"></a>peer0.org2.example.com</h3><p>使用<a href="mailto:`Admin@org2.example.com" target="_blank" rel="noopener">`Admin@org2.example.com</a><code>注册账号peer0.org2.example.com。这时候指定的目录是fabric-ca-files/</code>org2.example.com`/admin/。</p><p>修改fabric-ca-files/org2.example.com/admin/fabric-ca-client-config.yaml:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">id:</span><br><span class="line">  name: peer0.org2.example.com</span><br><span class="line">  type: peer</span><br><span class="line">  affiliation: com.example.org2</span><br><span class="line">  maxenrollments: 0</span><br><span class="line">  attributes:</span><br><span class="line">    - name: role</span><br><span class="line">      value: peer</span><br><span class="line">      ecert: true</span><br></pre></td></tr></table></figure><p>注册以及生成凭证：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fabric-ca-client register -H `pwd`/fabric-ca-files/org2.example.com/admin --id.secret=password</span><br><span class="line">mkdir ./fabric-ca-files/org2.example.com/peer0</span><br><span class="line">fabric-ca-client enroll -u http://peer0.org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/peer0</span><br></pre></td></tr></table></figure><p>将<a href="mailto:`Admin@org2.example.com" target="_blank" rel="noopener">`Admin@org2.example.com</a>`的证书复制到fabric-ca-files/org2.example.com/peer0/msp/admincerts：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir fabric-ca-files/org2.example.com/peer0/msp/admincerts</span><br><span class="line">cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/peer0/msp/admincerts/</span><br></pre></td></tr></table></figure><p>注意：</p><p>之前发现直接这么生成的证书，会少东西，需要在每个组织的msp目录下面配置下config.yaml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost msp]# pwd</span><br><span class="line">/data/fabric/fabric-ca-files/gzyb.vaccine.com/msp</span><br><span class="line">[root@localhost msp]# cat config.yaml </span><br><span class="line">NodeOUs:</span><br><span class="line">  Enable: true</span><br><span class="line">  ClientOUIdentifier:</span><br><span class="line">    Certificate: cacerts/localhost-7054.pem</span><br><span class="line">    OrganizationalUnitIdentifier: client</span><br><span class="line">  PeerOUIdentifier:</span><br><span class="line">    Certificate: cacerts/localhost-7054.pem</span><br><span class="line">    OrganizationalUnitIdentifier: peer</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;部署一个fabric-ca&quot;&gt;&lt;a href=&quot;#部署一个fabric-ca&quot; class=&quot;headerlink&quot; title=&quot;部署一个fabric-ca&quot;&gt;&lt;/a&gt;部署一个fabric-ca&lt;/h1&gt;&lt;h2 id=&quot;创建一个由两个组织org1-example
      
    
    </summary>
    
      <category term="区块链" scheme="https://shenshengkun.github.io/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/"/>
    
    
  </entry>
  
  <entry>
    <title>Prometheus监控elasticsearch</title>
    <link href="https://shenshengkun.github.io/posts/550bdf86.html"/>
    <id>https://shenshengkun.github.io/posts/550bdf86.html</id>
    <published>2019-02-22T01:49:01.000Z</published>
    <updated>2019-05-31T02:20:09.247Z</updated>
    
    <content type="html"><![CDATA[<h1 id="安装监控插件"><a href="#安装监控插件" class="headerlink" title="安装监控插件"></a>安装监控插件</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/justwatchcom/elasticsearch_exporter/releases/download/v1.0.4rc1/elasticsearch_exporter-1.0.4rc1.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"> tar -zxvf elasticsearch_exporter-1.0.4rc1.linux-amd64.tar.gz</span><br><span class="line"> cd elasticsearch_exporter-1.0.4rc1.linux-amd64/</span><br><span class="line"> nohup ./elasticsearch_exporter --web.listen-address &quot;:9109&quot;  --es.uri http://192.168.50.153:9200 &amp;</span><br></pre></td></tr></table></figure><p>启动成功后，可以访问 <a href="http://192.168.50.153:9109/metrics" target="_blank" rel="noopener">http://192.168.50.153:9109/metrics</a>  ，看抓取的信息</p><h1 id="监控图表"><a href="#监控图表" class="headerlink" title="监控图表"></a>监控图表</h1><table><thead><tr><th>指标</th><th>解析</th></tr></thead><tbody><tr><td>##搜索和索引性能</td><td></td></tr><tr><td>elasticsearch_indices_search_query_total</td><td>查询总数 吞吐量</td></tr><tr><td>elasticsearch_indices_search_query_time_seconds</td><td>查询总时间    性能</td></tr><tr><td>elasticsearch_indices_search_fetch_total</td><td>提取总数</td></tr><tr><td>elasticsearch_indices_search_fetch_time_seconds</td><td>花费在提取上的总时间</td></tr><tr><td>##索引请求</td><td></td></tr><tr><td>elasticsearch_indices_indexing_index_total</td><td>索引的文件总数</td></tr><tr><td>elasticsearch_indices_indexing_index_time_seconds_total</td><td>索引文档总时间</td></tr><tr><td>elasticsearch_indices_indexing_delete_total</td><td>索引的文件删除总数</td></tr><tr><td>elasticsearch_indices_indexing_delete_time_seconds_total</td><td>索引的文件删除总时间</td></tr><tr><td>elasticsearch_indices_refresh_total</td><td>索引刷新总数</td></tr><tr><td>elasticsearch_indices_refresh_time_seconds_total</td><td>刷新指数的总时间</td></tr><tr><td>elasticsearch_indices_flush_total</td><td>索引刷新总数到磁盘</td></tr><tr><td>elasticsearch_indices_flush_time_seconds</td><td>将索引刷新到磁盘上的总时间 累计flush时间</td></tr><tr><td>##JVM内存和垃圾回收</td><td></td></tr><tr><td>elasticsearch_jvm_gc_collection_seconds_sum</td><td>GC run time in seconds垃圾回收时间</td></tr><tr><td>elasticsearch_jvm_gc_collection_seconds_count</td><td>Count of JVM GC runs垃圾搜集数</td></tr><tr><td>elasticsearch_jvm_memory_committed_bytes</td><td>JVM memory currently committed by area最大使用内存限制</td></tr><tr><td>elasticsearch_jvm_memory_max_bytes</td><td>配置的最大jvm值</td></tr><tr><td>elasticsearch_jvm_memory_pool_max_bytes</td><td>JVM内存最大池数</td></tr><tr><td>elasticsearch_jvm_memory_pool_peak_max_bytes</td><td>最大的JVM内存峰值</td></tr><tr><td>elasticsearch_jvm_memory_pool_peak_used_bytes</td><td>池使用的JVM内存峰值</td></tr><tr><td>elasticsearch_jvm_memory_pool_used_bytes</td><td>目前使用的JVM内存池</td></tr><tr><td>elasticsearch_jvm_memory_used_bytes</td><td>JVM memory currently used by area 内存使用量</td></tr><tr><td>##集群健康和节点可用性</td><td></td></tr><tr><td>elasticsearch_cluster_health_status</td><td>集群状态，green（ 所有的主分片和副本分片都正常运行）、yellow（所有的主分片都正常运行，但不是所有的副本分片都正常运行）red（有主分片没能正常运行）值为1的即为对应状态</td></tr><tr><td>elasticsearch_cluster_health_number_of_data_nodes</td><td>node节点的数量</td></tr><tr><td>elasticsearch_cluster_health_number_of_in_flight_fetch</td><td>正在进行的碎片信息请求的数量</td></tr><tr><td>elasticsearch_cluster_health_number_of_nodes</td><td>集群内所有的节点</td></tr><tr><td>elasticsearch_cluster_health_number_of_pending_tasks</td><td>尚未执行的集群级别更改</td></tr><tr><td>elasticsearch_cluster_health_initializing_shards</td><td>正在初始化的分片数</td></tr><tr><td>elasticsearch_cluster_health_unassigned_shards</td><td>未分配分片数</td></tr><tr><td>elasticsearch_cluster_health_active_primary_shards</td><td>活跃的主分片总数</td></tr><tr><td>elasticsearch_cluster_health_active_shards</td><td>活跃的分片总数（包括复制分片）</td></tr><tr><td>elasticsearch_cluster_health_relocating_shards</td><td>当前节点正在迁移到其他节点的分片数量，通常为0，集群中有节点新加入或者退出时该值会增加</td></tr><tr><td>##资源饱和度</td><td></td></tr><tr><td>elasticsearch_thread_pool_completed_count</td><td>线程池操作完成（bulk、index、search、force_merge）</td></tr><tr><td>elasticsearch_thread_pool_active_count</td><td>线程池线程活动（bulk、index、search、force_merge）</td></tr><tr><td>elasticsearch_thread_pool_largest_count</td><td>线程池最大线程数（bulk、index、search、force_merge）</td></tr><tr><td>elasticsearch_thread_pool_queue_count</td><td>线程池中的排队线程数（bulk、index、search、force_merge）</td></tr><tr><td>elasticsearch_thread_pool_rejected_count</td><td>线程池的被拒绝线程数（bulk、index、search、force_merge）</td></tr><tr><td>elasticsearch_indices_fielddata_memory_size_bytes</td><td>fielddata缓存的大小（字节）</td></tr><tr><td>elasticsearch_indices_fielddata_evictions</td><td>来自fielddata缓存的驱逐次数</td></tr><tr><td>elasticsearch_indices_filter_cache_evictions</td><td>来自过滤器缓存的驱逐次数（仅版本2.x）</td></tr><tr><td>elasticsearch_indices_filter_cache_memory_size_bytes</td><td>过滤器高速缓存的大小（字节）（仅版本2.x）</td></tr><tr><td>elasticsearch_cluster_health_number_of_pending_tasks</td><td>待处理任务数</td></tr><tr><td>elasticsearch_indices_get_time_seconds</td><td></td></tr><tr><td>elasticsearch_indices_get_missing_total</td><td>丢失的文件的GET请求总数</td></tr><tr><td>elasticsearch_indices_get_missing_time_seconds</td><td>花费在文档丢失的GET请求上的总时间</td></tr><tr><td>elasticsearch_indices_get_exists_time_seconds</td><td></td></tr><tr><td>elasticsearch_indices_get_exists_total</td><td></td></tr><tr><td>elasticsearch_indices_get_total</td><td></td></tr><tr><td>##主机级别的系统和网络指标</td><td></td></tr><tr><td>elasticsearch_process_cpu_percent</td><td>Percent CPU used by process CPU使用率</td></tr><tr><td>elasticsearch_filesystem_data_free_bytes</td><td>Free space on block device in bytes 磁盘可用空间</td></tr><tr><td>elasticsearch_process_open_files_count</td><td>Open file descriptors ES进程打开的文件描述符</td></tr><tr><td>elasticsearch_transport_rx_packets_total</td><td>Count of packets receivedES节点之间网络入流量</td></tr><tr><td>elasticsearch_transport_tx_packets_total</td><td>Count of packets sentES节点之间网络出流量</td></tr><tr><td></td></tr></tbody></table><h1 id="prometheus配置"><a href="#prometheus配置" class="headerlink" title="prometheus配置"></a>prometheus配置</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &apos;elasticsearch&apos;</span><br><span class="line">      scrape_interval: 60s</span><br><span class="line">      scrape_timeout:  30s</span><br><span class="line">      metrics_path: &quot;/metrics&quot;</span><br><span class="line">      static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - &apos;192.168.50.153:9109&apos;</span><br><span class="line">        labels:</span><br><span class="line">          service: elasticsearch</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        regex: &apos;(.*)\:9109&apos;</span><br><span class="line">        target_label:  &apos;instance&apos;</span><br><span class="line">        replacement:   &apos;$1&apos;</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        regex:         &apos;.*\.(.*)\.lan.*&apos;</span><br><span class="line">        target_label:  &apos;environment&apos;</span><br><span class="line">        replacement:   &apos;$1&apos;</span><br></pre></td></tr></table></figure><p>之后运行重读prometheus配置命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./reload-prometheus.sh</span><br></pre></td></tr></table></figure><h1 id="grafana模板"><a href="#grafana模板" class="headerlink" title="grafana模板"></a>grafana模板</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://grafana.com/dashboards/2322</span><br></pre></td></tr></table></figure><p><img src="https://shenshengkun.github.io/images/ela.png" alt=""></p><h1 id="报警配置"><a href="#报警配置" class="headerlink" title="报警配置"></a>报警配置</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: elasticsearchStatsAlert</span><br><span class="line">  rules:</span><br><span class="line">  - alert: Elastic_Cluster_Health_RED</span><br><span class="line">    expr: elasticsearch_cluster_health_status&#123;color=&quot;red&quot;&#125;==1 </span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Instance &#123;&#123; $labels.instance &#125;&#125;: not all primary and replica shards are allocated in elasticsearch cluster &#123;&#123; $labels.cluster &#125;&#125;&quot;</span><br><span class="line">      description: &quot;Instance &#123;&#123; $labels.instance &#125;&#125;: not all primary and replica shards are allocated in elasticsearch cluster &#123;&#123; $labels.cluster &#125;&#125;.&quot;</span><br><span class="line">  - alert: Elastic_Cluster_Health_Yellow </span><br><span class="line">    expr: elasticsearch_cluster_health_status&#123;color=&quot;yellow&quot;&#125;==1</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot; Instance &#123;&#123; $labels.instance &#125;&#125;: not all primary and replica shards are allocated in elasticsearch cluster &#123;&#123; $labels.cluster &#125;&#125;&quot; </span><br><span class="line">      description: &quot;Instance &#123;&#123; $labels.instance &#125;&#125;: not all primary and replica shards are allocated in elasticsearch cluster &#123;&#123; $labels.cluster &#125;&#125;.&quot;</span><br><span class="line">  - alert: Elasticsearch_JVM_Heap_Too_High</span><br><span class="line">    expr: elasticsearch_jvm_memory_used_bytes&#123;area=&quot;heap&quot;&#125; / elasticsearch_jvm_memory_max_bytes&#123;area=&quot;heap&quot;&#125; &gt; 0.8</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;ElasticSearch node &#123;&#123; $labels.instance &#125;&#125; heap usage is high &quot;</span><br><span class="line">      description: &quot;The heap in &#123;&#123; $labels.instance &#125;&#125; is over 80% for 15m.&quot;</span><br><span class="line">  - alert: Elasticsearch_health_up</span><br><span class="line">    expr: elasticsearch_cluster_health_up !=1</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot; ElasticSearch node: &#123;&#123; $labels.instance &#125;&#125; last scrape of the ElasticSearch cluster health failed&quot;                               </span><br><span class="line">      description: &quot;ElasticSearch node: &#123;&#123; $labels.instance &#125;&#125; last scrape of the ElasticSearch cluster health failed&quot;</span><br><span class="line">  - alert: Elasticsearch_Too_Few_Nodes_Running</span><br><span class="line">    expr: elasticsearch_cluster_health_number_of_nodes &lt; 12</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;There are only &#123;&#123;$value&#125;&#125; &lt; 12 ElasticSearch nodes running &quot;                               </span><br><span class="line">      description: &quot;lasticSearch running on less than 12 nodes(total 14)&quot;</span><br><span class="line">  - alert: Elasticsearch_Count_of_JVM_GC_Runs</span><br><span class="line">    expr: rate(elasticsearch_jvm_gc_collection_seconds_count&#123;&#125;[5m])&gt;5</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;ElasticSearch node &#123;&#123; $labels.instance &#125;&#125;: Count of JVM GC runs &gt; 5 per sec and has a value of &#123;&#123; $value &#125;&#125; &quot;</span><br><span class="line">      description: &quot;ElasticSearch node &#123;&#123; $labels.instance &#125;&#125;: Count of JVM GC runs &gt; 5 per sec and has a value of &#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">  - alert: Elasticsearch_GC_Run_Time</span><br><span class="line">    expr: rate(elasticsearch_jvm_gc_collection_seconds_sum[5m])&gt;0.3</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot; ElasticSearch node &#123;&#123; $labels.instance &#125;&#125;: GC run time in seconds &gt; 0.3 sec and has a value of &#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">      description: &quot;ElasticSearch node &#123;&#123; $labels.instance &#125;&#125;: GC run time in seconds &gt; 0.3 sec and has a value of &#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">  - alert: Elasticsearch_json_parse_failures</span><br><span class="line">    expr: elasticsearch_cluster_health_json_parse_failures&gt;0</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot; ElasticSearch node &#123;&#123; $labels.instance &#125;&#125;: json parse failures &gt; 0 and has a value of &#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">      description: &quot;ElasticSearch node &#123;&#123; $labels.instance &#125;&#125;: json parse failures &gt; 0 and has a value of &#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">  - alert: Elasticsearch_breakers_tripped</span><br><span class="line">    expr: rate(elasticsearch_breakers_tripped&#123;&#125;[5m])&gt;0</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot; ElasticSearch node &#123;&#123; $labels.instance &#125;&#125;: breakers tripped &gt; 0 and has a value of &#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">      description: &quot;ElasticSearch node &#123;&#123; $labels.instance &#125;&#125;: breakers tripped &gt; 0 and has a value of &#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">  - alert: Elasticsearch_health_timed_out</span><br><span class="line">    expr: elasticsearch_cluster_health_timed_out&gt;0</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot; ElasticSearch node &#123;&#123; $labels.instance &#125;&#125;: Number of cluster health checks timed out &gt; 0 and has a value of &#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">      description: &quot;ElasticSearch node &#123;&#123; $labels.instance &#125;&#125;: Number of cluster health checks timed out &gt; 0 and has a value of &#123;&#123; $value &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;安装监控插件&quot;&gt;&lt;a href=&quot;#安装监控插件&quot; class=&quot;headerlink&quot; title=&quot;安装监控插件&quot;&gt;&lt;/a&gt;安装监控插件&lt;/h1&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gut
      
    
    </summary>
    
      <category term="k8s" scheme="https://shenshengkun.github.io/categories/k8s/"/>
    
    
  </entry>
  
  <entry>
    <title>Prometheus监控</title>
    <link href="https://shenshengkun.github.io/posts/e2e612d1.html"/>
    <id>https://shenshengkun.github.io/posts/e2e612d1.html</id>
    <published>2019-01-29T07:33:01.000Z</published>
    <updated>2019-05-30T02:29:19.228Z</updated>
    
    <content type="html"><![CDATA[<h1 id="在Kubernetes上快速部署Prometheus"><a href="#在Kubernetes上快速部署Prometheus" class="headerlink" title="在Kubernetes上快速部署Prometheus"></a>在Kubernetes上快速部署Prometheus</h1><h2 id="创建一个新的命名空间"><a href="#创建一个新的命名空间" class="headerlink" title="创建一个新的命名空间"></a>创建一个新的命名空间</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@prometheus]# cat monitor_namespace.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">   name: monitor</span><br><span class="line">   labels:</span><br><span class="line">     name: monitor</span><br><span class="line">[root@prometheus]#kubectl create -f monitor_namespace.yaml</span><br></pre></td></tr></table></figure><h2 id="rbac文件"><a href="#rbac文件" class="headerlink" title="rbac文件"></a>rbac文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@prometheus]# cat rbac-setup.yaml </span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources:</span><br><span class="line">  - nodes</span><br><span class="line">  - nodes/proxy</span><br><span class="line">  - services</span><br><span class="line">  - endpoints</span><br><span class="line">  - pods</span><br><span class="line">  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]</span><br><span class="line">- apiGroups:</span><br><span class="line">  - extensions</span><br><span class="line">  resources:</span><br><span class="line">  - ingresses</span><br><span class="line">  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]</span><br><span class="line">- nonResourceURLs: [&quot;/metrics&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;]</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: monitor</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: prometheus</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: monitor</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">[root@prometheus]#kubectl create -f rbac-setup.yaml</span><br></pre></td></tr></table></figure><h2 id="prometheus-deploy文件"><a href="#prometheus-deploy文件" class="headerlink" title="prometheus-deploy文件"></a>prometheus-deploy文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br></pre></td><td class="code"><pre><span class="line">[root@prometheus]# cat configmap.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-config</span><br><span class="line">  namespace: monitor</span><br><span class="line">data:</span><br><span class="line">  #被引用到/etc/prometheus/prometheus.yml</span><br><span class="line">  prometheus.yml: |</span><br><span class="line">    global:</span><br><span class="line">      #每15s采集一次数据和15s做一次告警检测</span><br><span class="line">      scrape_interval:     15s</span><br><span class="line">      evaluation_interval: 15s</span><br><span class="line">    #指定加载的告警规则文件</span><br><span class="line">    rule_files:</span><br><span class="line">    - /etc/prometheus/rules.yml</span><br><span class="line">    #将报警送至何地进行报警</span><br><span class="line">    alerting:</span><br><span class="line">      alertmanagers:</span><br><span class="line">        - static_configs:</span><br><span class="line">          - targets: [&quot;192.168.50.60:9093&quot;]</span><br><span class="line">    #指定prometheus要监控的目标</span><br><span class="line">    scrape_configs:</span><br><span class="line">    - job_name: &apos;k8s-node&apos;</span><br><span class="line">      scrape_interval: 10s</span><br><span class="line">      static_configs:</span><br><span class="line">      - targets: </span><br><span class="line">        - &apos;192.168.50.61:31672&apos;</span><br><span class="line">    </span><br><span class="line">    #自定义获取监控数据,每个 job_name 都是独立的</span><br><span class="line">    - job_name: &apos;tomcat-pods&apos;</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: endpoints</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_service_annotation_prometheus_io_jvm_scrape]</span><br><span class="line">        regex: true;true</span><br><span class="line">        action: keep</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_app_metrics_patn]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __metrics_path__</span><br><span class="line">        regex: (.+)</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_ip, __meta_kubernetes_service_annotation_prometheus_io_app_metrics_port]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __address__</span><br><span class="line">        regex: (.+);(.+)</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_namespace</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_pod_name</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_host_ip]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_host_ip</span><br><span class="line"></span><br><span class="line">    - job_name: &apos;kubernetes-apiservers&apos;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: endpoints</span><br><span class="line">      scheme: https</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: default;kubernetes;https</span><br><span class="line"></span><br><span class="line">    - job_name: &apos;kubernetes-nodes&apos;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: node</span><br><span class="line">      scheme: https</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_node_label_(.+)</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: kubernetes.default.svc:443</span><br><span class="line">      - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">        regex: (.+)</span><br><span class="line">        target_label: __metrics_path__</span><br><span class="line">        replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics</span><br><span class="line"></span><br><span class="line">    - job_name: &apos;kubernetes-cadvisor&apos;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: node</span><br><span class="line">      scheme: https</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_node_label_(.+)</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: kubernetes.default.svc:443</span><br><span class="line">      - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">        regex: (.+)</span><br><span class="line">        target_label: __metrics_path__</span><br><span class="line">        replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics/cadvisor</span><br><span class="line"></span><br><span class="line">    - job_name: &apos;kubernetes-service-endpoints&apos;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: endpoints</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: true</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __scheme__</span><br><span class="line">        regex: (https?)</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __metrics_path__</span><br><span class="line">        regex: (.+)</span><br><span class="line">      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __address__</span><br><span class="line">        regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">        replacement: $1:$2</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_service_label_(.+)</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_namespace</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_name</span><br><span class="line"></span><br><span class="line">    - job_name: &apos;kubernetes-services&apos;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: service</span><br><span class="line">      metrics_path: /probe</span><br><span class="line">      params:</span><br><span class="line">        module: [http_2xx]</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_probe]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: true</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        target_label: __param_target</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: blackbox-exporter.example.com:9115</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_service_label_(.+)</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">        target_label: kubernetes_namespace</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">        target_label: kubernetes_name</span><br><span class="line"></span><br><span class="line">    - job_name: &apos;kubernetes-ingresses&apos;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: ingress</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_ingress_annotation_prometheus_io_probe]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: true</span><br><span class="line">      - source_labels: [__meta_kubernetes_ingress_scheme,__address__,__meta_kubernetes_ingress_path]</span><br><span class="line">        regex: (.+);(.+);(.+)</span><br><span class="line">        replacement: $&#123;1&#125;://$&#123;2&#125;$&#123;3&#125;</span><br><span class="line">        target_label: __param_target</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: blackbox-exporter.example.com:9115</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_ingress_label_(.+)</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">        target_label: kubernetes_namespace</span><br><span class="line">      - source_labels: [__meta_kubernetes_ingress_name]</span><br><span class="line">        target_label: kubernetes_name</span><br><span class="line">    - job_name: &apos;kubernetes-pods&apos;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: pod</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: true</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __metrics_path__</span><br><span class="line">        regex: (.+)</span><br><span class="line">      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="line">        action: replace</span><br><span class="line">        regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">        replacement: $1:$2</span><br><span class="line">        target_label: __address__</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_namespace</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_pod_name</span><br><span class="line">  # 监控规则文件,被引用到/etc/prometheus/rules.yml</span><br><span class="line">  rules.yml: |</span><br><span class="line">    groups:</span><br><span class="line">    - name: test-rule</span><br><span class="line">      rules:</span><br><span class="line"></span><br><span class="line">      ############# Node监控 #############</span><br><span class="line">      - alert: k8s-node状态异常</span><br><span class="line">        expr: up&#123;job=&quot;k8s-node&quot;&#125; != 1</span><br><span class="line">        for: 3m</span><br><span class="line">        labels:</span><br><span class="line">          team: k8s-node</span><br><span class="line">        annotations:</span><br><span class="line">          summary: &quot;&#123;&#123;$labels.instance&#125;&#125;: Node节点状态异常&quot;</span><br><span class="line">          description: &quot;可能是重启了&quot;</span><br><span class="line">      - alert: k8s-node节点CPU使用率</span><br><span class="line">        expr: (1 - avg(irate(node_cpu_seconds_total&#123;job=&quot;k8s-node&quot;,mode=&quot;idle&quot;&#125;[1m])) by (instance)) * 100  &gt; 95</span><br><span class="line">        for: 1m</span><br><span class="line">        labels:</span><br><span class="line">          team: k8s-node</span><br><span class="line">        annotations:</span><br><span class="line">          summary: &quot;&#123;&#123;$labels.instance&#125;&#125;: Node节点CPU使用率超过95%&quot;</span><br><span class="line">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;: Node节点当前CPU使用率为: &#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">      - alert: k8s-node节点磁盘使用率</span><br><span class="line">        expr: (node_filesystem_size_bytes&#123;mountpoint=&quot;/&quot;,job=&quot;k8s-node&quot;&#125; - node_filesystem_avail_bytes&#123;mountpoint=&quot;/&quot;,job=&quot;k8s-node&quot;&#125;) / node_filesystem_size_bytes&#123;mountpoint=&quot;/&quot;,job=&quot;k8s-node&quot;&#125; * 100 &gt; 85</span><br><span class="line">        for: 1m</span><br><span class="line">        labels:</span><br><span class="line">          team: k8s-node</span><br><span class="line">        annotations:</span><br><span class="line">          description: &quot;Node服务器[[ &#123;&#123;$labels.instance&#125;&#125; ]] 的 &#123;&#123;mountpoint&#125;&#125; 磁盘空间使用率超过85%&quot;</span><br><span class="line">          summary: &quot;磁盘 &#123;&#123;$labels.device&#125;&#125; 当前使用率为: &#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">      - alert: k8s-node节点内存使用率</span><br><span class="line">        expr: (node_memory_MemTotal_bytes&#123;job=&quot;k8s-node&quot;&#125; - (node_memory_Buffers_bytes&#123;job=&quot;k8s-node&quot;&#125; + node_memory_Cached_bytes&#123;job=&quot;k8s-node&quot;&#125; + node_memory_MemFree_bytes&#123;job=&quot;k8s-node&quot;&#125;)) / node_memory_MemTotal_bytes&#123;job=&quot;k8s-node&quot;&#125; * 100</span><br><span class="line">        for: 1m</span><br><span class="line">        labels:</span><br><span class="line">          team: k8s-node</span><br><span class="line">        annotations:</span><br><span class="line">          description: &quot;Node服务器[[ &#123;&#123;$labels.instance&#125;&#125; ]]  内存使用率超过95%&quot;</span><br><span class="line">          summary: &quot;&#123;&#123;$labels.instance&#125;&#125; 当前内存使用率为: &#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">      ############ Pod 监控 ############</span><br><span class="line">      - alert: 监控k8s的pod状态异常</span><br><span class="line">        expr: up&#123;kubernetes_namespace=&quot;monitor&quot;&#125; != 1</span><br><span class="line">        for: 3m</span><br><span class="line">        labels:</span><br><span class="line">          team: &quot;kube-state-metrics&quot;</span><br><span class="line">        annotations:</span><br><span class="line">          description: &quot;&#123;&#123;$labels.kubernetes_namespace&#125;&#125; 内的 pod 状态有变动&quot;</span><br><span class="line">          summary: &quot;此 Pod 用于获取 k8s 监控数据, 绑定在一个节点上&quot;</span><br><span class="line">      - alert: 应用的 pod 状态有变动</span><br><span class="line">        expr: kube_pod_container_status_ready&#123;namespace=&quot;product&quot;&#125; != 1</span><br><span class="line">        for: 3m</span><br><span class="line">        labels:</span><br><span class="line">          status: &quot;product 命名空间内的 pod &#123;&#123;$labels.pod&#125;&#125;有变动&quot;</span><br><span class="line">        annotations:</span><br><span class="line">          description: &quot;Deployment &#123;&#123;$labels.container&#125;&#125; 内的 pod 状态有变动&quot;</span><br><span class="line">          summary: &quot;可能是重启或者在升级版本,如果频繁重启,请跟踪排查问题&quot;</span><br><span class="line">      - alert: 以下应用的 pod 重启次数已经超过15,请查看原因</span><br><span class="line">        expr: kube_pod_container_status_restarts_total&#123;namespace=&quot;product&quot;&#125; &gt; 15</span><br><span class="line">        for: 3m</span><br><span class="line">        labels:</span><br><span class="line">          status: &quot;product 命名空间内的 pod &#123;&#123;$labels.pod&#125;&#125; 重启次数太多&quot;</span><br><span class="line">        annotations:</span><br><span class="line">          description: &quot;Deployment &#123;&#123;$labels.container&#125;&#125; 内的 pod 重启次数太多&quot;</span><br><span class="line">          summary: &quot;重启次数太多,可能是因为 pod 内应用有问题&quot;</span><br><span class="line">      ########### Java 监控 ############</span><br><span class="line">      - alert: jvm线程数过高</span><br><span class="line">        expr: jvm_threads_current&#123;job=&quot;tomcat-pods&quot;&#125;&gt;2000</span><br><span class="line">        for: 1m</span><br><span class="line">        labels:</span><br><span class="line">          status: &quot;空间内 jvm 的变动情况&quot;</span><br><span class="line">        annotations:</span><br><span class="line">          description: &quot;&#123;&#123;$labels.kubernetes_pod_name&#125;&#125;: Jvm线程数过高&quot;</span><br><span class="line">          summary: &apos;&#123;&#123; $labels.kubernetes_pod_name &#125;&#125; : 当前你线程值为: &#123;&#123; $value &#125;&#125;&apos;</span><br><span class="line">          </span><br><span class="line">          </span><br><span class="line">          </span><br><span class="line">          </span><br><span class="line">          </span><br><span class="line">          </span><br><span class="line">[root@prometheus]# cat prometheus.deploy.yml </span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1beta2</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    name: prometheus-deployment</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: monitor</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: prometheus</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: prometheus</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: prom/prometheus:v2.6.0</span><br><span class="line">        name: prometheus</span><br><span class="line">        command:</span><br><span class="line">        - &quot;/bin/prometheus&quot;</span><br><span class="line">        args:</span><br><span class="line">        - &quot;--config.file=/etc/prometheus/prometheus.yml&quot;</span><br><span class="line">        - &quot;--storage.tsdb.path=/home/prometheus&quot;</span><br><span class="line">        - &quot;--storage.tsdb.retention=168h&quot;</span><br><span class="line">        - &quot;--web.enable-lifecycle&quot;</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9090</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &quot;/home/prometheus&quot;</span><br><span class="line">          name: data</span><br><span class="line">        - mountPath: &quot;/etc/prometheus&quot;</span><br><span class="line">          name: config-volume</span><br><span class="line">        - mountPath: &quot;/etc/localtime&quot;</span><br><span class="line">          readOnly: false</span><br><span class="line">          name: localtime</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 2048Mi</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 3180Mi</span><br><span class="line">      serviceAccountName: prometheus    </span><br><span class="line">      nodeSelector:</span><br><span class="line">        nodetype: prometheus</span><br><span class="line">      volumes:</span><br><span class="line">      - name: data</span><br><span class="line">        hostPath:</span><br><span class="line">          path: &quot;/opt/prometheus/data&quot;</span><br><span class="line">      - name: config-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: prometheus-config</span><br><span class="line">      - name: localtime</span><br><span class="line">        hostPath:</span><br><span class="line">          path: &quot;/etc/localtime&quot;</span><br><span class="line">          type: File</span><br><span class="line">          </span><br><span class="line">          </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> [root@prometheus]# cat prometheus.svc.yml </span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: prometheus</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: monitor</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 9090</span><br><span class="line">    targetPort: 9090</span><br><span class="line">    nodePort: 30003</span><br><span class="line">  selector:</span><br><span class="line">    app: prometheus</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">[root@prometheus]#kubectl create -f configmap.yaml</span><br><span class="line">[root@prometheus]#kubectl create -f prometheus.deploy.yml</span><br><span class="line">[root@prometheus]#kubectl create -f prometheus.svc.yml</span><br><span class="line"></span><br><span class="line">注：需要在本地创建/opt/prometheus/data作为prometheus数据路径，另需要给data目录赋予777权限</span><br></pre></td></tr></table></figure><h3 id="热重读配置文件"><a href="#热重读配置文件" class="headerlink" title="热重读配置文件"></a>热重读配置文件</h3><p>congfigmap有热重启功能，这样每次改完配置文件都不需要重启prometheus的pod来重读配置了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- &quot;--web.enable-lifecycle&quot;在prometheus.deploy.yml的配置文件里面加上这段话就可以了</span><br><span class="line"></span><br><span class="line">[root@prometheus]# cat reload-prometheus.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line">kubectl apply -f configmap.yaml</span><br><span class="line">sleep 60</span><br><span class="line">curl -XPOST http://192.168.50.60:30003/-/reload</span><br><span class="line"></span><br><span class="line">可以写个脚本，每次修改完配置文件的配置之后，执行一下脚本就可以同步生效了！</span><br></pre></td></tr></table></figure><h2 id="安装kube-state-metrics"><a href="#安装kube-state-metrics" class="headerlink" title="安装kube-state-metrics"></a>安装kube-state-metrics</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@prometheus]# git clone https://github.com/kubernetes/kube-state-metrics.git</span><br><span class="line">之后把默认的命名空间改成monitor，进入kube-state-metrics目录</span><br><span class="line">[root@prometheus]#kubectl create -f ./</span><br></pre></td></tr></table></figure><h1 id="安装grafana"><a href="#安装grafana" class="headerlink" title="安装grafana"></a>安装grafana</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">创建grafana的数据目录</span><br><span class="line">mkdir /opt/grafana/data</span><br><span class="line">启动脚本</span><br><span class="line">[root@grafana]# cat start_grafana.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">docker stop `docker ps -a |awk &apos;/grafana/&#123;print $1&#125;&apos;`</span><br><span class="line">docker rm `docker ps -a |awk &apos;/grafana/&#123;print $1&#125;&apos;`</span><br><span class="line">docker run -d \</span><br><span class="line">   --name=grafana \</span><br><span class="line">   --restart=always \</span><br><span class="line">   -p 3000:3000 \</span><br><span class="line">   -m 4096m \</span><br><span class="line">   -v /opt/grafana/data:/var/lib/grafana \</span><br><span class="line">   -v /opt/grafana/log:/var/log/grafana \</span><br><span class="line">   grafana/grafana:5.4.3</span><br></pre></td></tr></table></figure><p>1、安装完之后，需要添加source，source直接点prometheus，链接就是<a href="http://192.168.50.60:30003之前创建的prometheus界面" target="_blank" rel="noopener">http://192.168.50.60:30003之前创建的prometheus界面</a></p><p>2、添加模板dashboad（列出几个常用的）</p><p>点import导入，有俩种方式，直接填官网模板，或者导入json</p><p><a href="https://grafana.com/dashboards/9276" target="_blank" rel="noopener">https://grafana.com/dashboards/9276</a>  node的cpu、内存等</p><p><a href="https://grafana.com/dashboards/3146" target="_blank" rel="noopener">https://grafana.com/dashboards/3146</a>  pod</p><p><a href="https://grafana.com/dashboards/8588" target="_blank" rel="noopener">https://grafana.com/dashboards/8588</a>  deployment</p><h1 id="安装alertmanager"><a href="#安装alertmanager" class="headerlink" title="安装alertmanager"></a>安装alertmanager</h1><h2 id="创建配置文件、目录"><a href="#创建配置文件、目录" class="headerlink" title="创建配置文件、目录"></a>创建配置文件、目录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">创建alert数据目录</span><br><span class="line">mkdir /opt/alert/data</span><br><span class="line"></span><br><span class="line">注意：需要alertmanager.yml配置，此配置钉钉和邮件可同时放松</span><br><span class="line">[root@docker60 alert]# cat alertmanager.yml </span><br><span class="line">global:</span><br><span class="line">  resolve_timeout: 5m</span><br><span class="line"></span><br><span class="line">route:</span><br><span class="line">  group_by: [&apos;alertname&apos;]</span><br><span class="line">  group_wait: 10s</span><br><span class="line">  group_interval: 10s</span><br><span class="line">  repeat_interval: 6m</span><br><span class="line">  receiver: default</span><br><span class="line">receivers:</span><br><span class="line">- name: &apos;default&apos;</span><br><span class="line">  email_configs:</span><br><span class="line">  - to: &quot;&quot;</span><br><span class="line">    send_resolved: true</span><br><span class="line">    from: &quot;&quot;</span><br><span class="line">    smarthost:  &quot;smtp.xxx.com:25&quot;</span><br><span class="line">    auth_username: &quot;&quot;</span><br><span class="line">    auth_password: &quot;&quot;</span><br><span class="line">  webhook_configs:</span><br><span class="line">  - url: &apos;http://192.168.50.60:8060/dingtalk/ops_dingding/send&apos;</span><br><span class="line">    send_resolved: true</span><br><span class="line">inhibit_rules:</span><br><span class="line">  - source_match:</span><br><span class="line">      severity: &apos;critical&apos;</span><br><span class="line">    target_match:</span><br><span class="line">      severity: &apos;warning&apos;</span><br><span class="line">    equal: [&apos;alertname&apos;]</span><br></pre></td></tr></table></figure><h2 id="启动脚本"><a href="#启动脚本" class="headerlink" title="启动脚本"></a>启动脚本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@alert]# cat start_alert.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">docker stop `docker ps -a |awk &apos;/alertmanager/&#123;print $1&#125;&apos;`</span><br><span class="line">docker rm `docker ps -a |awk &apos;/alertmanager/&#123;print $1&#125;&apos;`</span><br><span class="line"></span><br><span class="line">docker run -d \</span><br><span class="line">  --name alertmanager \</span><br><span class="line">  --restart=always \</span><br><span class="line">  -p 9093:9093 \</span><br><span class="line">  -v /etc/localtime:/etc/localtime:ro \</span><br><span class="line">  -v /opt/alert/alertmanager.yml:/etc/alertmanager/alertmanager.yml \</span><br><span class="line">  -v /opt/alert/data:/alertmanager \</span><br><span class="line">  prom/alertmanager:v0.15.3</span><br></pre></td></tr></table></figure><h2 id="安装dingding插件"><a href="#安装dingding插件" class="headerlink" title="安装dingding插件"></a>安装dingding插件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1、安装go （这里就不叙述了）</span><br><span class="line">2、假设go的路径是/usr/local/go</span><br><span class="line">mkdir -pv /usr/local/go/src/github.com/timonwong</span><br><span class="line">3、下载dingding插件</span><br><span class="line">git clone https://github.com/timonwong/prometheus-webhook-dingtalk.git</span><br><span class="line">4、添加dingding机器人</span><br><span class="line">在dingding群里面添加即可</span><br><span class="line">5、启动dingding</span><br><span class="line">[root@alert]# cat start_dingding.sh </span><br><span class="line">cd /usr/local/go/src/github.com/timonwong/prometheus-webhook-dingtalk</span><br><span class="line">kill -9 `ps -ef | grep prometheus-webhook-dingtalk | grep -v grep | awk &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">nohup ./prometheus-webhook-dingtalk --ding.profile=&quot;ops_dingding=https://oapi.dingtalk.com/robot/send?access_token=xxxx&quot;   2&gt;&amp;1 1&gt;dingding.log &amp;</span><br></pre></td></tr></table></figure><h1 id="包下载位置"><a href="#包下载位置" class="headerlink" title="包下载位置"></a>包下载位置</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">链接：https://pan.baidu.com/s/1-7QofB1qzi0Wvnc4BgIDTQ </span><br><span class="line">提取码：i6yw</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;在Kubernetes上快速部署Prometheus&quot;&gt;&lt;a href=&quot;#在Kubernetes上快速部署Prometheus&quot; class=&quot;headerlink&quot; title=&quot;在Kubernetes上快速部署Prometheus&quot;&gt;&lt;/a&gt;在Kuberne
      
    
    </summary>
    
      <category term="k8s" scheme="https://shenshengkun.github.io/categories/k8s/"/>
    
    
  </entry>
  
  <entry>
    <title>jira-安装及破解</title>
    <link href="https://shenshengkun.github.io/posts/6924c90a.html"/>
    <id>https://shenshengkun.github.io/posts/6924c90a.html</id>
    <published>2018-11-20T23:28:40.000Z</published>
    <updated>2019-05-30T02:29:19.215Z</updated>
    
    <content type="html"><![CDATA[<h1 id="安装jira"><a href="#安装jira" class="headerlink" title="安装jira"></a>安装jira</h1><p>JIRA是Atlassian公司出品的项目与事务跟踪工具，被广泛应用于缺陷跟踪、客户服务、需求收集、流程审批、任务跟踪、项目跟踪和敏捷管理等工作领域。 </p><p><img src="https://shenshengkun.github.io/images/jira1.png" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">下载包：</span><br><span class="line"></span><br><span class="line">wget https://product-downloads.atlassian.com/software/jira/downloads/atlassian-jira-software-7.13.0-x64.bin</span><br><span class="line">[root@YZSJHL82-204 ~]# chmod +x atlassian-jira-software-7.13.0-x64.bin</span><br><span class="line">[root@YZSJHL82-204 ~]# ./atlassian-jira-software-7.13.0-x64.bin</span><br><span class="line">Unpacking JRE ...</span><br><span class="line">Starting Installer ...</span><br><span class="line">十月 23, 2018 4:38:25 下午 java.util.prefs.FileSystemPreferences$1 run</span><br><span class="line">信息: Created user preferences directory.</span><br><span class="line">十月 23, 2018 4:38:25 下午 java.util.prefs.FileSystemPreferences$2 run</span><br><span class="line">信息: Created system preferences directory in java.home.</span><br><span class="line">This will install JIRA Software 7.4.1 on your computer.</span><br><span class="line">OK [o, Enter], Cancel [c]</span><br><span class="line">o               #按o安装</span><br><span class="line">Choose the appropriate installation or upgrade option.</span><br><span class="line">Please choose one of the following:</span><br><span class="line">Express Install (use default settings) [1], Custom Install (recommended for advanced users) [2, Enter], Upgrade an existing JIRA installation [3]</span><br><span class="line">2               #2为自定义安装</span><br><span class="line">Where should JIRA Software be installed?</span><br><span class="line">[/opt/atlassian/jira]</span><br><span class="line">/usr/local/atlassina/jira       #自定义安装目录</span><br><span class="line">Default location for JIRA Software data</span><br><span class="line">[/var/atlassian/application-data/jira]</span><br><span class="line">/usr/local/atlassina/jira_data          #自定义数据目录</span><br><span class="line">Configure which ports JIRA Software will use.</span><br><span class="line">JIRA requires two TCP ports that are not being used by any other</span><br><span class="line">applications on this machine. The HTTP port is where you will access JIRA</span><br><span class="line">through your browser. The Control port is used to startup and shutdown JIRA.</span><br><span class="line">Use default ports (HTTP: 8080, Control: 8005) - Recommended [1, Enter], Set custom value for HTTP and Control ports [2]</span><br><span class="line">2               #2为自定义端口</span><br><span class="line">HTTP Port Number</span><br><span class="line">[8080]          #8080为默认端口</span><br><span class="line">8050            #http连接端口</span><br><span class="line">Control Port Number</span><br><span class="line">[8005]</span><br><span class="line">8040            #控制端口</span><br><span class="line">JIRA can be run in the background.</span><br><span class="line">You may choose to run JIRA as a service, which means it will start</span><br><span class="line">automatically whenever the computer restarts.</span><br><span class="line">Install JIRA as Service?</span><br><span class="line">Yes [y, Enter], No [n]</span><br><span class="line">y               #是否开机自启</span><br><span class="line">Details on where JIRA Software will be installed and the settings that will be used.</span><br><span class="line">Installation Directory: /usr/local/atlassina/jira </span><br><span class="line">Home Directory: /usr/local/atlassina/jira_data </span><br><span class="line">HTTP Port: 8050 </span><br><span class="line">RMI Port: 8040 </span><br><span class="line">Install as service: Yes </span><br><span class="line">Install [i, Enter], Exit [e]</span><br><span class="line">i               #确认已选配置</span><br><span class="line">Extracting files ...</span><br><span class="line">Please wait a few moments while JIRA Software is configured.</span><br><span class="line">Installation of JIRA Software 7.4.1 is complete</span><br><span class="line">Start JIRA Software 7.4.1 now?</span><br><span class="line">Yes [y, Enter], No [n]</span><br><span class="line">y               #启动</span><br><span class="line">Please wait a few moments while JIRA Software starts up.</span><br><span class="line">Launching JIRA Software ...</span><br><span class="line">Installation of JIRA Software 7.4.1 is complete</span><br><span class="line">Your installation of JIRA Software 7.4.1 is now ready and can be accessed</span><br><span class="line">via your browser.</span><br><span class="line">JIRA Software 7.4.1 can be accessed at http://localhost:8050</span><br><span class="line">Finishing installation ...</span><br></pre></td></tr></table></figure><p><img src="https://shenshengkun.github.io/images/jira2.png" alt=""></p><p>浏览器访问jira，地址为：<a href="http://IP:8050" target="_blank" rel="noopener">http://IP:8050</a> 请自行修改IP和端口。如果可以访问，说明安装成功。</p><p><img src="https://shenshengkun.github.io/images/jira3.png" alt=""></p><h1 id="配置数据库及密码"><a href="#配置数据库及密码" class="headerlink" title="配置数据库及密码"></a>配置数据库及密码</h1><p><img src="https://shenshengkun.github.io/images/jira4.png" alt=""><br>在mySQL上创建用户及库做授权<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">create database jira_new;</span><br><span class="line">grant all privileges on *.* to jira@&apos;10.4.82.204&apos; identified by &apos;jira&apos;;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure></p><p>在授权完用户我们不可以马上填写信息，需要添加MySQL的一个jra包，否则下一步会提示找不到mysql的驱动</p><p>wget <a href="https://dev.mysql.com/get/Downloads/Connector-J/mysql-connector-java-5.1.46.zip" target="_blank" rel="noopener">https://dev.mysql.com/get/Downloads/Connector-J/mysql-connector-java-5.1.46.zip</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">停止jira</span><br><span class="line">[root@YZSJHL82-204 ~]# /etc/init.d/jira stop</span><br><span class="line">上传软件包</span><br><span class="line">[root@YZSJHL82-204 ~]# cp mysql-connector-java-5.1.46-bin.jar /opt/atlassian/jira/atlassian-jira/WEB-INF/lib/</span><br><span class="line">启动jira</span><br><span class="line">[root@YZSJHL82-204 ~]# /etc/init.d/jira start</span><br><span class="line">注意防火墙</span><br></pre></td></tr></table></figure></p><p>安装完数据库插件即可下一步:</p><p><img src="https://shenshengkun.github.io/images/jira5.png" alt=""></p><h1 id="设置jira主题"><a href="#设置jira主题" class="headerlink" title="设置jira主题"></a>设置jira主题</h1><p><img src="https://shenshengkun.github.io/images/jira6.png" alt=""> </p><p>因为第一次安装，我们需要去jira官网注册用户，获取授权码 (免费30天，安装后更换破解即可) </p><p><img src="https://shenshengkun.github.io/images/jira7.png" alt=""></p><p>保存好服务器ID，进入atlassian官网获取试用许可证，下边附上注册地址： </p><p>注册官网：<a href="https://my.atlassian.com" target="_blank" rel="noopener">https://my.atlassian.com</a> </p><p>或使用以下地址： </p><p><a href="https://id.atlassian.com/signup?application=mac&amp;continue=https://my.atlassian.com" target="_blank" rel="noopener">https://id.atlassian.com/signup?application=mac&amp;continue=https://my.atlassian.com</a> </p><p>登陆账号后，选择New Evaluation License</p><p><img src="https://shenshengkun.github.io/images/jira8.png" alt=""> </p><h1 id="设置管理员用户"><a href="#设置管理员用户" class="headerlink" title="设置管理员用户:"></a>设置管理员用户:</h1><p><img src="https://shenshengkun.github.io/images/jira9.png" alt=""><br>官网注册的账号只可以免费试用30天，所以当我们安装完需要尽快进行破解<br><img src="https://shenshengkun.github.io/images/jira10.jpg" alt=""></p><p><img src="https://shenshengkun.github.io/images/jira11.png" alt=""></p><h1 id="破解jira"><a href="#破解jira" class="headerlink" title="破解jira"></a>破解jira</h1><p><a href="https://download.csdn.net/download/lbwahoo/10030807" target="_blank" rel="noopener">https://download.csdn.net/download/lbwahoo/10030807</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">停止jira</span><br><span class="line">[root@YZSJHL82-204 ~]# /etc/init.d/jira stop</span><br><span class="line">进入安装目录下的atlassian-jira/WEB-INF/lib/目录下，用破解包atlassian-extras-3.2.jar替换原来的包。并将mysql连接驱动复制到此目录下。</span><br><span class="line">[root@YZSJHL82-204 ~]# cp atlassian-extras-3.2.jar /opt/atlassian/jira/atlassian-jira/WEB-INF/lib/</span><br><span class="line">启动jira</span><br><span class="line">[root@YZSJHL82-204 ~]# /etc/init.d/jira start</span><br><span class="line">注意防火墙</span><br></pre></td></tr></table></figure></p><p><img src="https://shenshengkun.github.io/images/jira12.png" alt=""></p><h1 id="配置数据库连接地址"><a href="#配置数据库连接地址" class="headerlink" title="配置数据库连接地址"></a>配置数据库连接地址</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/var/atlassian/application-data/jira/dbconfig.xml</span><br><span class="line">#此路径为默认路径</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;安装jira&quot;&gt;&lt;a href=&quot;#安装jira&quot; class=&quot;headerlink&quot; title=&quot;安装jira&quot;&gt;&lt;/a&gt;安装jira&lt;/h1&gt;&lt;p&gt;JIRA是Atlassian公司出品的项目与事务跟踪工具，被广泛应用于缺陷跟踪、客户服务、需求收集、流程审批
      
    
    </summary>
    
      <category term="版本管理工具" scheme="https://shenshengkun.github.io/categories/%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/"/>
    
    
  </entry>
  
  <entry>
    <title>python删除mongo表</title>
    <link href="https://shenshengkun.github.io/posts/7c0c3da0.html"/>
    <id>https://shenshengkun.github.io/posts/7c0c3da0.html</id>
    <published>2018-10-28T23:23:01.000Z</published>
    <updated>2019-05-30T02:29:19.189Z</updated>
    
    <content type="html"><![CDATA[<h1 id="PyMongo"><a href="#PyMongo" class="headerlink" title="PyMongo"></a>PyMongo</h1><p>Python 要连接 MongoDB 需要 MongoDB 驱动，这里我们使用 PyMongo 驱动来连接。 </p><h2 id="pip-安装"><a href="#pip-安装" class="headerlink" title="pip 安装"></a>pip 安装</h2><p>pip 是一个通用的 Python 包管理工具，提供了对 Python 包的查找、下载、安装、卸载的功能。</p><p>安装 pymongo:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python3 -m pip3 install pymongo</span><br></pre></td></tr></table></figure><p>也可以指定安装的版本:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python3 -m pip3 install pymongo==3.5.1</span><br></pre></td></tr></table></figure><p>更新 pymongo 命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python3 -m pip3 install --upgrade pymongo</span><br></pre></td></tr></table></figure><h2 id="easy-install-安装"><a href="#easy-install-安装" class="headerlink" title="easy_install 安装"></a>easy_install 安装</h2><p>旧版的 Python 可以使用 easy_install 来安装，easy_install 也是 Python 包管理工具。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python -m easy_install pymongo</span><br></pre></td></tr></table></figure><p>更新 pymongo 命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python -m easy_install -U pymongo</span><br></pre></td></tr></table></figure><h1 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h1><p>创建数据库需要使用 MongoClient 对象，并且指定连接的 URL 地址和要创建的数据库名。</p><p>如下实例中，我们创建的数据库 aa :</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line"> </span><br><span class="line">import pymongo</span><br><span class="line"> </span><br><span class="line">myclient = pymongo.MongoClient(&quot;mongodb://localhost:27017/&quot;)</span><br><span class="line">mydb = myclient[&quot;aa&quot;]</span><br></pre></td></tr></table></figure><h1 id="删除表"><a href="#删除表" class="headerlink" title="删除表"></a>删除表</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"></span><br><span class="line">#-*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">from pymongo import MongoClient</span><br><span class="line">from datetime import datetime</span><br><span class="line"></span><br><span class="line">def delete(year,month,day):</span><br><span class="line">  try:</span><br><span class="line">    client = MongoClient(&apos;mongodb://192.168.50.223:27017,192.168.50.224:27017,192.168.50.225:27017&apos;)</span><br><span class="line">    db_auth = client.admin</span><br><span class="line">    db_auth.authenticate(&quot;root&quot;, &quot;passwd&quot;)</span><br><span class="line">    db = client.gag_bill</span><br><span class="line">    old_count = db.billInfo.count()</span><br><span class="line">    print (&quot;old_count = %d&quot; % (old_count))</span><br><span class="line">    db.billInfo.remove(&#123;&quot;cTimeStamp&quot;:&#123;&quot;$lte&quot;:datetime(year,month,day,0,0,0,000)&#125;&#125;)</span><br><span class="line">    new_count = db.billInfo.count()</span><br><span class="line">    client.close()</span><br><span class="line">    print (&quot;del_data = %d&quot; %(old_count-new_count))</span><br><span class="line">    print (&quot;new_count = %d&quot; % (new_count))</span><br><span class="line">  except Exception as e:</span><br><span class="line">    print (e)</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">  starttime = datetime.now()</span><br><span class="line">  print (&quot;start_time = %s&quot; % (starttime))</span><br><span class="line">  year = starttime.year</span><br><span class="line">  month = starttime.month</span><br><span class="line">  day = starttime.day-4</span><br><span class="line">  delete(year,month,day)</span><br><span class="line">  endtime = datetime.now()</span><br><span class="line">  print (&quot;end_time = %s&quot; % (endtime))</span><br><span class="line">  runtime = (endtime - starttime).seconds</span><br><span class="line">  print (&quot;run_time = %d seconds&quot; % (runtime))</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;PyMongo&quot;&gt;&lt;a href=&quot;#PyMongo&quot; class=&quot;headerlink&quot; title=&quot;PyMongo&quot;&gt;&lt;/a&gt;PyMongo&lt;/h1&gt;&lt;p&gt;Python 要连接 MongoDB 需要 MongoDB 驱动，这里我们使用 PyMongo 驱动
      
    
    </summary>
    
      <category term="python" scheme="https://shenshengkun.github.io/categories/python/"/>
    
    
  </entry>
  
</feed>
